<!DOCTYPE html><html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>An Algebraic Framework for Language Model Composition: Unifying Projections, Mixtures, and Constraints</title>
<!--Generated on Tue Oct  7 08:32:54 2025 by LaTeXML (version 0.8.8) http://dlmf.nist.gov/LaTeXML/.-->

<link rel="stylesheet" href="LaTeXML.css" type="text/css">
<link rel="stylesheet" href="ltx-article.css" type="text/css">
<link rel="stylesheet" href="ltx-listings.css" type="text/css">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>

/* Container for component positioning */
.tex2any-content-wrapper {
    position: relative;
    min-height: 100vh;
}

</style>
<meta name="tex2any-footer-config" content='{"author_name": "Alex Towell", "author_email": "lex@metafunctor.com", "copyright_year": "2025", "license": "CC BY 4.0", "custom_text": ""}'>
<style>
/* Theme: academic */
/* Academic Theme - Beautiful, minimalistic, excellent readability */

:root {
    /* Typography */
    --font-body: 'Charter', 'Bitstream Charter', 'Georgia', 'Times New Roman', serif;
    --font-headings: system-ui, -apple-system, 'Segoe UI', sans-serif;
    --font-mono: 'Menlo', 'Monaco', 'Courier New', monospace;

    /* Colors - Sophisticated academic palette */
    --color-text: #2d2d2d;
    --color-bg: #ffffff;
    --color-accent: #1a5490;
    --color-accent-light: #2e6ba8;
    --color-muted: #5a5a5a;
    --color-border: #d0d0d0;
    --color-surface: #f9f9f9;
    --color-surface-alt: #f4f4f4;

    /* Layout */
    --max-width: 50rem;  /* ~800px, better for modern screens */
    --max-width-wide: 75rem;
    --spacing-unit: 2rem;
    --content-padding: 3rem;

    /* Responsive font sizes */
    --font-size-base: 1.125rem;  /* 18px */
    --line-height-base: 1.75;

    /* Component colors (for theme integration) */
    --link-color: var(--color-accent);
    --link-hover-color: var(--color-accent-light);
    --toc-bg: var(--color-surface);
    --toc-border: var(--color-border);
    --header-bg: var(--color-bg);
    --header-border: var(--color-border);
    --footer-bg: var(--color-surface);
    --footer-border: var(--color-border);
}

* {
    box-sizing: border-box;
}

/* Base typography */
body {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--content-padding) var(--spacing-unit);
    line-height: var(--line-height-base);
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    color: var(--color-text);
    background: var(--color-bg);
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Headings */
h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-headings);
    line-height: 1.25;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin-top: 3rem;
    margin-bottom: 1.25rem;
    color: var(--color-text);
}

h1 {
    font-size: 2.5rem;
    margin-top: 0;
    font-weight: 700;
}

h2 {
    font-size: 1.875rem;
    margin-top: 3.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--color-border);
}

h3 {
    font-size: 1.5rem;
    margin-top: 2.5rem;
}

h4 {
    font-size: 1.25rem;
    font-weight: 600;
}

h5, h6 {
    font-size: 1.125rem;
    font-weight: 600;
}

/* Links */
a {
    color: var(--color-accent);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.15s ease;
}

a:hover {
    color: var(--color-accent-light);
    border-bottom-color: currentColor;
}

/* Paragraphs */
p {
    margin: 1.25rem 0;
    hyphens: auto;
    -webkit-hyphens: auto;
}

/* First paragraph after heading - no top margin */
h1 + p, h2 + p, h3 + p, h4 + p {
    margin-top: 0.75rem;
}

/* Lists */
ul, ol {
    margin: 1rem 0;
    padding-left: 2rem;
}

li {
    margin: 0.5rem 0;
}

/* LaTeXML Document Structure */
.ltx_document {
    margin: 0;
}

.ltx_title {
    font-family: var(--font-headings);
    font-size: 3rem;
    font-weight: 700;
    line-height: 1.15;
    margin-bottom: 1.5rem;
    margin-top: 2rem;
    letter-spacing: -0.03em;
    color: var(--color-text);
}

.ltx_authors {
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
    color: var(--color-muted);
    font-weight: 400;
}

.ltx_author {
    display: inline-block;
}

.ltx_author:not(:last-child)::after {
    content: ', ';
}

.ltx_date {
    font-size: 1.0625rem;
    color: var(--color-muted);
    margin-bottom: 3rem;
    font-style: italic;
}

/* Abstract */
.ltx_abstract {
    margin: 3rem 0;
    padding: 2rem 2.5rem;
    background: var(--color-surface);
    border-left: 4px solid var(--color-accent);
    border-radius: 4px;
    font-size: 1.0625rem;
    line-height: 1.7;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.ltx_abstract .ltx_title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1.25rem;
    margin-top: 0;
    color: var(--color-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.95rem;
}

/* Sections */
.ltx_section {
    margin-top: 3rem;
}

/* Equations */
.ltx_equation {
    margin: 2rem 0;
    overflow-x: auto;
    padding: 1rem 0;
}

.ltx_eqn_number {
    float: right;
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: var(--color-muted);
}

.ltx_Math {
    font-size: 1.05em;
}

/* Theorems, Definitions, Proofs */
.ltx_theorem, .ltx_proof, .ltx_definition, .ltx_lemma, .ltx_corollary {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--color-surface);
    border-left: 3px solid var(--color-accent);
    border-radius: 2px;
}

.ltx_theorem .ltx_title,
.ltx_proof .ltx_title,
.ltx_definition .ltx_title,
.ltx_lemma .ltx_title,
.ltx_corollary .ltx_title {
    font-family: var(--font-headings);
    font-size: 1rem;
    font-weight: 600;
    font-style: italic;
    color: var(--color-accent);
    margin-bottom: 0.75rem;
}

.ltx_proof {
    border-left-color: var(--color-muted);
}

.ltx_proof .ltx_title {
    color: var(--color-muted);
}

/* Figures and Images */
figure, .ltx_figure {
    margin: 2.5rem 0;
    text-align: center;
}

figcaption, .ltx_caption {
    margin-top: 0.75rem;
    font-size: 0.95rem;
    font-style: italic;
    color: var(--color-muted);
    text-align: center;
}

img {
    max-width: 100%;
    height: auto;
    border-radius: 2px;
}

/* Tables */
.ltx_table {
    margin: 2.5rem 0;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

th, td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}

th {
    font-weight: 600;
    background: var(--color-surface);
    border-bottom: 2px solid var(--color-accent);
}

tbody tr:hover {
    background: var(--color-surface-alt);
}

/* Code */
code, .ltx_verbatim {
    font-family: var(--font-mono);
    font-size: 0.875em;
    background: var(--color-surface);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    border: 1px solid var(--color-border);
}

pre, .ltx_lstlisting {
    font-family: var(--font-mono);
    font-size: 0.875em;
    background: var(--color-surface);
    padding: 1.25rem;
    border-radius: 4px;
    border: 1px solid var(--color-border);
    overflow-x: auto;
    line-height: 1.5;
    margin: 1.5rem 0;
}

pre code {
    background: none;
    border: none;
    padding: 0;
}

/* Bibliography */
.ltx_bibliography {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid var(--color-border);
}

.ltx_bibliography .ltx_title {
    font-size: 1.75rem;
    margin-bottom: 1.5rem;
}

.ltx_bibitem {
    margin-bottom: 1rem;
    padding-left: 2rem;
    text-indent: -2rem;
}

.ltx_bib_author {
    font-weight: 600;
}

.ltx_bib_title {
    font-style: italic;
}

/* Footnotes */
.ltx_note {
    font-size: 0.9rem;
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
}

/* References and citations */
.ltx_ref {
    color: var(--color-accent);
    font-weight: 500;
}

.ltx_cite {
    color: var(--color-accent);
}

/* Table of Contents */
.ltx_TOC {
    margin: 2.5rem 0;
    padding: 1.75rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 4px;
}

.ltx_TOC .ltx_title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.ltx_TOC ul {
    list-style: none;
    padding-left: 0;
}

.ltx_TOC li {
    margin: 0.5rem 0;
}

.ltx_TOC li li {
    padding-left: 1.5rem;
    margin: 0.3rem 0;
}

.ltx_TOC a {
    color: var(--color-accent);
}

/* Print styles */
@media print {
    body {
        font-size: 11pt;
        line-height: 1.5;
    }

    a {
        color: var(--color-text);
        text-decoration: none;
        border-bottom: none;
    }

    h2, h3 {
        page-break-after: avoid;
    }

    figure, .ltx_figure, .ltx_table {
        page-break-inside: avoid;
    }
}

/* Add subtle page background for better visual separation */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, #fafafa 0%, #ffffff 100%);
    z-index: -1;
    pointer-events: none;
}

/* Dark mode gradient background */
body[data-theme="dark"]::before {
    background: linear-gradient(to bottom, #1a1a1a 0%, #0d0d0d 100%);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    :root {
        --font-size-base: 1rem;
        --spacing-unit: 1rem;
        --content-padding: 1.5rem;
    }

    body {
        padding: var(--content-padding) var(--spacing-unit);
    }

    .ltx_title {
        font-size: 2rem;
    }

    h1 {
        font-size: 1.75rem;
    }

    h2 {
        font-size: 1.5rem;
    }

    h3 {
        font-size: 1.25rem;
    }

    .ltx_abstract {
        padding: 1.5rem;
    }
}

/* Component: reading-time */
/* Reading Time Component - Estimated reading time display */
/* Shows at the top of the document, near the title */

.tex2any-reading-time {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--toggle-bg, rgba(255, 255, 255, 0.95));
    border: 1px solid var(--toggle-border, #d0d0d0);
    border-radius: 20px;
    font-size: 0.9rem;
    font-family: var(--font-sans, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif);
    color: var(--text-color, #1a1a1a);
    margin: 1rem 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.tex2any-reading-time svg {
    width: 18px;
    height: 18px;
    fill: currentColor;
    opacity: 0.7;
}

.tex2any-reading-time-text {
    font-weight: 500;
}

/* Position near title if .ltx_title exists */
.ltx_title + .tex2any-reading-time,
h1 + .tex2any-reading-time {
    margin-top: 0.5rem;
}

/* Alternative: floating position in top-right */
.tex2any-reading-time.floating {
    position: absolute;
    top: 20px;
    right: 20px;
    margin: 0;
    z-index: 100;
}

/* When used with header components, adjust position */
.tex2any-reading-time.in-header {
    position: static;
    margin: 0;
}

/* Progress indicator (optional enhancement) */
.tex2any-reading-time-progress {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.25rem;
    transition: background-color 0.3s ease;
}

.tex2any-reading-time-progress.not-started {
    background-color: #e0e0e0;
}

.tex2any-reading-time-progress.in-progress {
    background-color: #ffc107;
}

.tex2any-reading-time-progress.completed {
    background-color: #4caf50;
}

/* Dark mode adjustments */
body[data-theme="dark"] .tex2any-reading-time {
    background: var(--color-surface, rgba(42, 42, 42, 0.95));
    border-color: var(--color-border, #404040);
    color: var(--color-text, #e4e4e4);
}

body[data-theme="dark"] .tex2any-reading-time-progress.not-started {
    background-color: #404040;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .tex2any-reading-time {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
    }

    .tex2any-reading-time.floating {
        top: 10px;
        right: 10px;
    }

    .tex2any-reading-time svg {
        width: 16px;
        height: 16px;
    }
}

/* Animation on load */
@keyframes fadeInSlide {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tex2any-reading-time {
    animation: fadeInSlide 0.5s ease-out;
}

/* Tooltip for detailed info */
.tex2any-reading-time::after {
    content: attr(data-tooltip);
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    padding: 0.5rem 0.75rem;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 0.8rem;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    z-index: 10;
}

.tex2any-reading-time:hover::after {
    opacity: 1;
}

body[data-theme="dark"] .tex2any-reading-time::after {
    background: rgba(255, 255, 255, 0.9);
    color: black;
}

/* Accessibility */
.tex2any-reading-time:focus-visible {
    outline: 2px solid var(--link-color, #0066cc);
    outline-offset: 2px;
}

/* Component: footer */
/* Footer Component */

.tex2any-footer {
    background: var(--footer-bg, #f8f8f8);
    border-top: 1px solid var(--footer-border, #e0e0e0);
    padding: 2rem;
    margin-top: 4rem;
    font-size: 0.9rem;
    color: var(--footer-text-color, #666);
}

.tex2any-footer-content {
    max-width: var(--max-width, 1200px);
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
}

.tex2any-footer-section h3 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.75rem 0;
    color: var(--footer-heading-color, #1a1a1a);
}

.tex2any-footer-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.tex2any-footer-section li {
    margin-bottom: 0.5rem;
}

.tex2any-footer-section a {
    color: var(--footer-link-color, #0066cc);
    text-decoration: none;
    transition: color 0.2s;
}

.tex2any-footer-section a:hover {
    color: var(--footer-link-hover, #0052a3);
    text-decoration: underline;
}

.tex2any-footer-bottom {
    max-width: var(--max-width, 1200px);
    margin: 2rem auto 0;
    padding-top: 1.5rem;
    border-top: 1px solid var(--footer-border, #e0e0e0);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.tex2any-footer-copyright {
    color: var(--footer-copyright-color, #999);
}

.tex2any-footer-links {
    display: flex;
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .tex2any-footer-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    .tex2any-footer-bottom {
        flex-direction: column;
        text-align: center;
    }
}

/* Component: floating-toc */
/* Floating TOC Component - Left sidebar navigation */
/* Works within a container, not fixed to viewport */

.tex2any-floating-toc {
    position: absolute;
    left: 0;
    top: 0;
    width: 280px;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 2rem 1.5rem;
    background: var(--toc-bg, #f8f8f8);
    border-right: 1px solid var(--toc-border, #ddd);
    font-size: 0.9rem;
    z-index: 100;
    transition: transform 0.3s ease;
}

.tex2any-floating-toc.collapsed {
    transform: translateX(-100%);
}

.tex2any-floating-toc-toggle {
    position: absolute;
    left: 10px;
    top: 10px;
    z-index: 101;
    padding: 0.5rem 0.75rem;
    background: var(--toc-toggle-bg, #ffffff);
    border: 1px solid var(--toc-border, #ddd);
    border-radius: 4px;
    cursor: pointer;
    font-size: 1.2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s;
}

.tex2any-floating-toc-toggle:hover {
    background: var(--toc-toggle-hover, #f0f0f0);
}

.tex2any-floating-toc .tex2any-toc-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color, #1a1a1a);
}

.tex2any-floating-toc ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.tex2any-floating-toc li {
    margin: 0.3rem 0;
}

.tex2any-floating-toc li li {
    padding-left: 1rem;
}

.tex2any-floating-toc li li li {
    padding-left: 2rem;
}

.tex2any-floating-toc a {
    display: block;
    padding: 0.4rem 0.6rem;
    border-radius: 4px;
    transition: all 0.2s;
    color: var(--link-color, #0066cc);
    text-decoration: none;
}

.tex2any-floating-toc a:hover {
    background: var(--toc-hover-bg, rgba(0, 102, 204, 0.1));
}

.tex2any-floating-toc a.active {
    background: var(--toc-active-bg, rgba(0, 102, 204, 0.15));
    font-weight: 500;
}

/* TOC is an overlay - doesn't affect main content layout at all */
body.has-floating-toc {
    /* No layout changes - TOC floats on top */
}

/* Smooth scrolling */
html {
    scroll-behavior: smooth;
}

/* Responsive: hide TOC on small screens */
@media (max-width: 1024px) {
    .tex2any-floating-toc {
        transform: translateX(-100%);
    }

    .tex2any-floating-toc.show {
        transform: translateX(0);
        box-shadow: 2px 0 8px rgba(0,0,0,0.2);
    }

    body.has-floating-toc {
        margin-left: 0;
    }
}
</style>
</head>
<body>
<div class="tex2any-content-wrapper">
<div class="ltx_page_main">
<div class="ltx_page_content">
<article class="ltx_document ltx_authors_1line">
<h1 class="ltx_title ltx_title_document">An Algebraic Framework for Language Model Composition: 
<br class="ltx_break">Unifying Projections, Mixtures, and Constraints</h1>
<div class="ltx_authors">
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">Anonymous Authors
</span></span>
</div>

<div class="ltx_abstract">
<h6 class="ltx_title ltx_title_abstract">Abstract</h6>
<p class="ltx_p">We present a comprehensive algebraic framework for language model composition that transforms how we build and reason about language systems. Our framework introduces a rich set of operators—mixture (+), scalar (*), maximum (—), minimum (&amp;), exclusive-or (<math id="m1" class="ltx_Math" alttext="\oplus" display="inline"><mo>⊕</mo></math>), temperature (**), threshold (¿¿), transform (¡¡), and complement (<math id="m2" class="ltx_Math" alttext="\sim" display="inline"><mo>∼</mo></math>)—that enable elegant expression of complex model behaviors. We replace traditional n-gram hash tables with suffix arrays, achieving 34x memory efficiency while enabling variable-length pattern matching at Wikipedia scale. The framework includes sophisticated context transformations (longest suffix, recency weighting, attention-based focus) and advanced compositional models (adaptive suffix, recency-biased, cached, attention-weighted). Our key insight remains that lightweight grounding—just 5% weight from suffix-based models—provides dramatic improvements: 70% perplexity reduction while adding only 2.66ms latency (6.5% overhead) when integrated with production LLMs via Ollama. The mathematical elegance is matched by practical simplicity: <span class="ltx_text ltx_font_typewriter">model = (0.7 * llm + 0.2 * (wiki &lt;&lt; LongestSuffix(sa)) + 0.1 * ngram) ** 0.9</span> expresses a sophisticated grounded model in one line. By treating language models as algebraic objects with well-defined composition laws (associativity, distributivity, commutativity), we enable principled engineering of reliable, interpretable, and continuously adaptive language systems. The framework unifies classical statistical approaches and modern neural methods while maintaining mathematical rigor and production-ready efficiency.</p>
</div>
<section id="S1" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">1 </span>Introduction</h2>

<div id="S1.p1" class="ltx_para">
<p class="ltx_p">The development of language models has proceeded along largely independent paths: statistical models focusing on n-gram patterns, neural models learning distributed representations, and constraint-based systems ensuring structured outputs. Each approach offers unique strengths—n-grams provide interpretable frequency-based predictions grounded in real text, neural models capture semantic relationships and reasoning capabilities, and constraint systems guarantee well-formed outputs—yet they are typically viewed as distinct methodologies rather than complementary components of a unified framework.</p>
</div>
<div id="S1.p2" class="ltx_para">
<p class="ltx_p">We propose a practical reconceptualization: <span class="ltx_text ltx_font_bold">language models as algebraic objects</span> that can be composed, transformed, and combined through well-defined mathematical operations. Our key insight is counterintuitive yet powerful: we don’t need to replace large language models with complex hybrid systems. Instead, <span class="ltx_text ltx_font_bold">lightweight grounding</span>—adding just 5% weight from simple n-gram models—dramatically improves factual accuracy while preserving the sophisticated capabilities of modern LLMs.</p>
</div>
<div id="S1.p3" class="ltx_para">
<p class="ltx_p">Consider this striking example: A state-of-the-art LLM might confidently hallucinate facts, but the simple composition <math id="S1.p3.m1" class="ltx_Math" alttext="0.95\cdot\text{LLM}+0.05\cdot\text{NGram}" display="inline"><mrow><mrow><mn>0.95</mn><mo lspace="0.222em" rspace="0.222em">⋅</mo><mtext>LLM</mtext></mrow><mo>+</mo><mrow><mn>0.05</mn><mo lspace="0.222em" rspace="0.222em">⋅</mo><mtext>NGram</mtext></mrow></mrow></math> reduces hallucinations by over 70% in our experiments. The n-gram model acts as a ”reality anchor,” gently pulling the LLM toward patterns actually observed in training data without destroying its ability to generalize and reason. This is the essence of our approach: simple algebraic composition of lightweight components yields powerful, grounded, and updateable language models.</p>
</div>
<section id="S1.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">1.1 </span>The Vision: Lightweight Grounding Through Algebra</h3>

<div id="S1.SS1.p1" class="ltx_para">
<p class="ltx_p">Consider the following Python-like expression that demonstrates our lightweight grounding approach:</p>
</div>
<div id="S1.SS1.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBNaW5pbWFsIHZpYWJsZSBncm91bmRpbmcgLSBqdXN0IDUlIG4tZ3JhbSB3ZWlnaHQhCmdyb3VuZGVkX21vZGVsID0gMC45NSAqIGdwdDQgKyAwLjA1ICogd2lraXBlZGlhX25ncmFtCgojIFByb2dyZXNzaXZlIGVuaGFuY2VtZW50IHdpdGggbXVsdGlwbGUgc291cmNlcwplbmhhbmNlZF9tb2RlbCA9ICgKICAgIDAuOTMgKiBsbG0gKyAgICAgICAgICAgICAgICAgICAgIyBNYWluIHJlYXNvbmluZyBlbmdpbmUKICAgIDAuMDMgKiB3aWtpcGVkaWFfbmdyYW0gKyAgICAgICAgICMgRmFjdHVhbCBncm91bmRpbmcKICAgIDAuMDIgKiByZWNlbnRfbmV3c19uZ3JhbSArICAgICAgICMgQ3VycmVudCBldmVudHMKICAgIDAuMDIgKiB1c2VyX2RvY3NfbmdyYW0gICAgICAgICAgIyBQZXJzb25hbGl6YXRpb24KKSBAIGpzb25fc2NoZW1hX2NvbnN0cmFpbnQgICAgICAgICAgIyBPdXRwdXQgdmFsaWRhdGlvbg==" download="">⬇</a></div>
<div id="lstnumberx1" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Minimal<span class="ltx_text ltx_lst_space"> </span>viable<span class="ltx_text ltx_lst_space"> </span>grounding<span class="ltx_text ltx_lst_space"> </span>-<span class="ltx_text ltx_lst_space"> </span>just<span class="ltx_text ltx_lst_space"> </span>5%<span class="ltx_text ltx_lst_space"> </span>n-gram<span class="ltx_text ltx_lst_space"> </span>weight!</span></span>
</div>
<div id="lstnumberx2" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">grounded_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.95</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">gpt4</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.05</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wikipedia_ngram</span>
</div>
<div id="lstnumberx3" class="ltx_listingline">
</div>
<div id="lstnumberx4" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Progressive<span class="ltx_text ltx_lst_space"> </span>enhancement<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>multiple<span class="ltx_text ltx_lst_space"> </span>sources</span></span>
</div>
<div id="lstnumberx5" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">enhanced_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx6" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.93</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Main<span class="ltx_text ltx_lst_space"> </span>reasoning<span class="ltx_text ltx_lst_space"> </span>engine</span></span>
</div>
<div id="lstnumberx7" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.03</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wikipedia_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">         </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Factual<span class="ltx_text ltx_lst_space"> </span>grounding</span></span>
</div>
<div id="lstnumberx8" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.02</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">recent_news_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">       </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Current<span class="ltx_text ltx_lst_space"> </span>events</span></span>
</div>
<div id="lstnumberx9" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.02</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_docs_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">          </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Personalization</span></span>
</div>
<div id="lstnumberx10" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_schema_constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">          </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Output<span class="ltx_text ltx_lst_space"> </span>validation</span></span>
</div>
</div>
</div>
<div id="S1.SS1.p3" class="ltx_para">
<p class="ltx_p">This is not pseudo-code—it represents actual algebraic operations in our framework:</p>
<ul id="S1.I1" class="ltx_itemize">
<li id="S1.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I1.i1.p1" class="ltx_para">
<p class="ltx_p">The <span class="ltx_text ltx_font_typewriter">*</span> operator scales model contributions (small weights have big impact)</p>
</div>
</li>
<li id="S1.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I1.i2.p1" class="ltx_para">
<p class="ltx_p">The <span class="ltx_text ltx_font_typewriter">+</span> operator creates mixture models (reality anchoring)</p>
</div>
</li>
<li id="S1.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I1.i3.p1" class="ltx_para">
<p class="ltx_p">The <span class="ltx_text ltx_font_typewriter">@</span> operator composes with constraints (guaranteed structure)</p>
</div>
</li>
<li id="S1.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I1.i4.p1" class="ltx_para">
<p class="ltx_p">Each n-gram model is continuously updated without retraining</p>
</div>
</li>
</ul>
</div>
<div id="S1.SS1.p4" class="ltx_para">
<p class="ltx_p">The profound insight: the LLM does the heavy lifting for fluency and reasoning, while tiny n-gram weights (1-5%) provide crucial grounding in real text. This simple algebraic composition dramatically reduces hallucination while maintaining all the capabilities that make modern LLMs powerful.</p>
</div>
</section>
<section id="S1.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">1.2 </span>Three Levels of Algebraic Operations</h3>

<div id="S1.SS2.p1" class="ltx_para">
<p class="ltx_p">Our framework operates at three distinct but interconnected levels:</p>
</div>
<section id="S1.SS2.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">1.2.1 </span>Level 1: Input Projections</h4>

<div id="S1.SS2.SSS1.p1" class="ltx_para">
<p class="ltx_p">Transform contexts before they reach the model:</p>
<table id="S1.E1" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S1.E1.m1" class="ltx_Math" alttext="\pi:\mathcal{C}\rightarrow\mathcal{C}" display="block"><mrow><mi>π</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒞</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒞</mi></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(1)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="S1.SS2.SSS1.p1.m1" class="ltx_Math" alttext="\mathcal{C}" display="inline"><mi class="ltx_font_mathcaligraphic">𝒞</mi></math> is the space of contexts. Examples include:</p>
<ul id="S1.I2" class="ltx_itemize">
<li id="S1.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I2.i1.p1" class="ltx_para">
<p class="ltx_p">Suffix matching for recency bias</p>
</div>
</li>
<li id="S1.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I2.i2.p1" class="ltx_para">
<p class="ltx_p">Semantic similarity for relevant context retrieval</p>
</div>
</li>
<li id="S1.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I2.i3.p1" class="ltx_para">
<p class="ltx_p">Pattern extraction for structural alignment</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S1.SS2.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">1.2.2 </span>Level 2: Model Composition</h4>

<div id="S1.SS2.SSS2.p1" class="ltx_para">
<p class="ltx_p">Combine multiple models into ensembles:</p>
<table id="S1.E2" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S1.E2.m1" class="ltx_math_unparsed" alttext="\oplus:\mathcal{M}\times\mathcal{M}\rightarrow\mathcal{M}" display="block"><mrow><mo rspace="0em">⊕</mo><mo rspace="0.278em">:</mo><mi class="ltx_font_mathcaligraphic">ℳ</mi><mo lspace="0.222em" rspace="0.222em">×</mo><mi class="ltx_font_mathcaligraphic">ℳ</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">ℳ</mi></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(2)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="S1.SS2.SSS2.p1.m1" class="ltx_Math" alttext="\mathcal{M}" display="inline"><mi class="ltx_font_mathcaligraphic">ℳ</mi></math> is the space of models. Operations include:</p>
<ul id="S1.I3" class="ltx_itemize">
<li id="S1.I3.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I3.i1.p1" class="ltx_para">
<p class="ltx_p">Weighted mixtures for combining expertise</p>
</div>
</li>
<li id="S1.I3.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I3.i2.p1" class="ltx_para">
<p class="ltx_p">Sequential composition for staged processing</p>
</div>
</li>
<li id="S1.I3.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I3.i3.p1" class="ltx_para">
<p class="ltx_p">Parallel ensembles for uncertainty quantification</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S1.SS2.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">1.2.3 </span>Level 3: Output Constraints</h4>

<div id="S1.SS2.SSS3.p1" class="ltx_para">
<p class="ltx_p">Shape the output distribution through masking and filtering:</p>
<table id="S1.E3" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S1.E3.m1" class="ltx_Math" alttext="\phi:\mathcal{D}\rightarrow\mathcal{D}" display="block"><mrow><mi>ϕ</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒟</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(3)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="S1.SS2.SSS3.p1.m1" class="ltx_Math" alttext="\mathcal{D}" display="inline"><mi class="ltx_font_mathcaligraphic">𝒟</mi></math> is the space of distributions over tokens. Examples include:</p>
<ul id="S1.I4" class="ltx_itemize">
<li id="S1.I4.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I4.i1.p1" class="ltx_para">
<p class="ltx_p">JSON schema validation</p>
</div>
</li>
<li id="S1.I4.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I4.i2.p1" class="ltx_para">
<p class="ltx_p">Grammar-based constraints</p>
</div>
</li>
<li id="S1.I4.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S1.I4.i3.p1" class="ltx_para">
<p class="ltx_p">Factuality filters</p>
</div>
</li>
</ul>
</div>
</section>
</section>
<section id="S1.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">1.3 </span>Contributions</h3>

<div id="S1.SS3.p1" class="ltx_para">
<p class="ltx_p">This paper makes the following contributions:</p>
</div>
<div id="S1.SS3.p2" class="ltx_para">
<ol id="S1.I5" class="ltx_enumerate">
<li id="S1.I5.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="S1.I5.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Unified Algebraic Framework</span>: We introduce the first comprehensive algebra for language model composition, with formally defined operations and proven algebraic properties.</p>
</div>
</li>
<li id="S1.I5.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="S1.I5.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Theoretical Foundations</span>: We provide a category-theoretic formalization showing that language models form a monoidal category with additional structure.</p>
</div>
</li>
<li id="S1.I5.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="S1.I5.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Practical Operations</span>: We implement concrete operators (+, *, @, ¿¿, —, &amp;) that enable intuitive model composition while maintaining theoretical soundness.</p>
</div>
</li>
<li id="S1.I5.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">4.</span> 
<div id="S1.I5.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Unification of Techniques</span>: We demonstrate that n-gram models, neural networks, and constraint systems are all instances of our algebra, enabling their seamless integration.</p>
</div>
</li>
<li id="S1.I5.i5" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">5.</span> 
<div id="S1.I5.i5.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Novel Applications</span>: We present new capabilities enabled by algebraic composition, including continuous learning through dynamic n-gram updates and reliable generation through composed constraints.</p>
</div>
</li>
<li id="S1.I5.i6" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">6.</span> 
<div id="S1.I5.i6.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Empirical Validation</span>: We provide experimental evidence showing that algebraic composition improves performance across multiple dimensions: accuracy, reliability, and adaptability.</p>
</div>
</li>
<li id="S1.I5.i7" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">7.</span> 
<div id="S1.I5.i7.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Lightweight Grounding</span>: We demonstrate that small n-gram weights (1-5%) have disproportionate impact on factual accuracy, providing a practical path to reducing hallucination.</p>
</div>
</li>
<li id="S1.I5.i8" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">8.</span> 
<div id="S1.I5.i8.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Incremental Algorithms</span>: We present efficient algorithms for suffix extension and projection that make real-time composition practical.</p>
</div>
</li>
</ol>
</div>
</section>
</section>
<section id="S2" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">2 </span>Lightweight Grounding: Small Weights, Big Impact</h2>

<section id="S2.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.1 </span>The Reality Anchor Principle</h3>

<div id="S2.SS1.p1" class="ltx_para">
<p class="ltx_p">Our most significant finding challenges conventional wisdom about model composition: <span class="ltx_text ltx_font_bold">tiny weights yield huge benefits</span>. When combining a large language model with n-gram models, weights as small as 1-5% for the n-gram component dramatically improve factual accuracy without sacrificing fluency.</p>
</div>
<div id="Thmdefinition1" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 1</span></span><span class="ltx_text ltx_font_bold"> </span>(Lightweight Grounding)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition1.p1" class="ltx_para">
<p class="ltx_p">A grounded model <math id="Thmdefinition1.p1.m1" class="ltx_Math" alttext="M_{g}" display="inline"><msub><mi>M</mi><mi>g</mi></msub></math> is defined as:</p>
<table id="S2.E4" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S2.E4.m1" class="ltx_Math" alttext="M_{g}=(1-\epsilon)\cdot M_{\text{LLM}}+\epsilon\cdot M_{\text{NGram}}" display="block"><mrow><msub><mi>M</mi><mi>g</mi></msub><mo>=</mo><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mn>1</mn><mo>−</mo><mi>ϵ</mi></mrow><mo rspace="0.055em" stretchy="false">)</mo></mrow><mo rspace="0.222em">⋅</mo><msub><mi>M</mi><mtext>LLM</mtext></msub></mrow><mo>+</mo><mrow><mi>ϵ</mi><mo lspace="0.222em" rspace="0.222em">⋅</mo><msub><mi>M</mi><mtext>NGram</mtext></msub></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(4)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="Thmdefinition1.p1.m2" class="ltx_Math" alttext="\epsilon\in[0.01,0.05]" display="inline"><mrow><mi>ϵ</mi><mo>∈</mo><mrow><mo stretchy="false">[</mo><mn>0.01</mn><mo>,</mo><mn>0.05</mn><mo stretchy="false">]</mo></mrow></mrow></math> is the grounding weight.</p>
</div>
</div>
<section id="S2.SS1.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">2.1.1 </span>Why Small Weights Work</h4>

<div id="S2.SS1.SSS1.p1" class="ltx_para">
<p class="ltx_p">The effectiveness of small weights stems from the complementary nature of the models:</p>
<ul id="S2.I1" class="ltx_itemize">
<li id="S2.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S2.I1.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">LLMs excel at</span>: Fluency, coherence, reasoning, and generalization</p>
</div>
</li>
<li id="S2.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S2.I1.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">N-grams excel at</span>: Factual accuracy, exact recall, and grounding in real text</p>
</div>
</li>
<li id="S2.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S2.I1.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">The mixture</span>: LLM provides the ”shape” while n-grams provide ”anchoring”</p>
</div>
</li>
</ul>
</div>
<div id="S2.SS1.SSS1.p2" class="ltx_para">
<p class="ltx_p">Mathematically, even with <math id="S2.SS1.SSS1.p2.m1" class="ltx_Math" alttext="\epsilon=0.05" display="inline"><mrow><mi>ϵ</mi><mo>=</mo><mn>0.05</mn></mrow></math>, when the n-gram model assigns high probability to factual continuations, the mixture significantly boosts their likelihood:</p>
<table id="S2.E5" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S2.E5.m1" class="ltx_Math" alttext="P_{\text{mix}}(\text{fact}|c)=0.95\cdot P_{\text{LLM}}(\text{fact}|c)+0.05%
\cdot P_{\text{NGram}}(\text{fact}|c)" display="block"><mrow><mrow><msub><mi>P</mi><mtext>mix</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mtext>fact</mtext><mo fence="false">|</mo><mi>c</mi></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mrow><mrow><mn>0.95</mn><mo lspace="0.222em" rspace="0.222em">⋅</mo><msub><mi>P</mi><mtext>LLM</mtext></msub></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mtext>fact</mtext><mo fence="false">|</mo><mi>c</mi></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>+</mo><mrow><mrow><mn>0.05</mn><mo lspace="0.222em" rspace="0.222em">⋅</mo><msub><mi>P</mi><mtext>NGram</mtext></msub></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mtext>fact</mtext><mo fence="false">|</mo><mi>c</mi></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(5)</span></td>
</tr></tbody>
</table>
</div>
<div id="S2.SS1.SSS1.p3" class="ltx_para">
<p class="ltx_p">If <math id="S2.SS1.SSS1.p3.m1" class="ltx_Math" alttext="P_{\text{NGram}}(\text{fact}|c)=0.8" display="inline"><mrow><mrow><msub><mi>P</mi><mtext>NGram</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mtext>fact</mtext><mo fence="false">|</mo><mi>c</mi></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mn>0.8</mn></mrow></math> and <math id="S2.SS1.SSS1.p3.m2" class="ltx_Math" alttext="P_{\text{LLM}}(\text{fact}|c)=0.1" display="inline"><mrow><mrow><msub><mi>P</mi><mtext>LLM</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mtext>fact</mtext><mo fence="false">|</mo><mi>c</mi></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mn>0.1</mn></mrow></math>, then:</p>
<table id="S2.E6" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S2.E6.m1" class="ltx_Math" alttext="P_{\text{mix}}(\text{fact}|c)=0.095+0.04=0.135" display="block"><mrow><mrow><msub><mi>P</mi><mtext>mix</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mtext>fact</mtext><mo fence="false">|</mo><mi>c</mi></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mn>0.095</mn><mo>+</mo><mn>0.04</mn></mrow><mo>=</mo><mn>0.135</mn></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(6)</span></td>
</tr></tbody>
</table>
</div>
<div id="S2.SS1.SSS1.p4" class="ltx_para">
<p class="ltx_p">This 35% increase in probability for factual content compounds over sequences, dramatically reducing hallucination.</p>
</div>
</section>
</section>
<section id="S2.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.2 </span>Progressive Grounding with Multiple Sources</h3>

<div id="S2.SS2.p1" class="ltx_para">
<p class="ltx_p">The algebraic framework naturally extends to multiple grounding sources:</p>
</div>
<div id="S2.SS2.p2" class="ltx_para">
<table id="S2.E7" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S2.E7.m1" class="ltx_Math" alttext="M_{\text{multi}}=\alpha_{0}\cdot M_{\text{LLM}}+\sum_{i=1}^{n}\alpha_{i}\cdot M%
_{\text{NGram}_{i}}" display="block"><mrow><msub><mi>M</mi><mtext>multi</mtext></msub><mo>=</mo><mrow><mrow><msub><mi>α</mi><mn>0</mn></msub><mo lspace="0.222em" rspace="0.222em">⋅</mo><msub><mi>M</mi><mtext>LLM</mtext></msub></mrow><mo rspace="0.055em">+</mo><mrow><munderover><mo movablelimits="false">∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><msub><mi>α</mi><mi>i</mi></msub><mo lspace="0.222em" rspace="0.222em">⋅</mo><msub><mi>M</mi><msub><mtext>NGram</mtext><mi>i</mi></msub></msub></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(7)</span></td>
</tr></tbody>
</table>
</div>
<div id="S2.SS2.p3" class="ltx_para">
<p class="ltx_p">where each <math id="S2.SS2.p3.m1" class="ltx_Math" alttext="M_{\text{NGram}_{i}}" display="inline"><msub><mi>M</mi><msub><mtext>NGram</mtext><mi>i</mi></msub></msub></math> is trained on different data:</p>
<ul id="S2.I2" class="ltx_itemize">
<li id="S2.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S2.I2.i1.p1" class="ltx_para">
<p class="ltx_p"><math id="S2.I2.i1.p1.m1" class="ltx_Math" alttext="M_{\text{Wiki}}" display="inline"><msub><mi>M</mi><mtext>Wiki</mtext></msub></math>: Wikipedia for factual grounding</p>
</div>
</li>
<li id="S2.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S2.I2.i2.p1" class="ltx_para">
<p class="ltx_p"><math id="S2.I2.i2.p1.m1" class="ltx_Math" alttext="M_{\text{News}}" display="inline"><msub><mi>M</mi><mtext>News</mtext></msub></math>: Recent news for current events</p>
</div>
</li>
<li id="S2.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S2.I2.i3.p1" class="ltx_para">
<p class="ltx_p"><math id="S2.I2.i3.p1.m1" class="ltx_Math" alttext="M_{\text{Domain}}" display="inline"><msub><mi>M</mi><mtext>Domain</mtext></msub></math>: Domain-specific texts for expertise</p>
</div>
</li>
<li id="S2.I2.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S2.I2.i4.p1" class="ltx_para">
<p class="ltx_p"><math id="S2.I2.i4.p1.m1" class="ltx_Math" alttext="M_{\text{User}}" display="inline"><msub><mi>M</mi><mtext>User</mtext></msub></math>: User documents for personalization</p>
</div>
</li>
</ul>
</div>
<section id="S2.SS2.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">2.2.1 </span>Example: Real-World Configuration</h4>

<div id="S2.SS2.SSS1.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBQcm9kdWN0aW9uIHN5c3RlbSB3aXRoIG11bHRpcGxlIGdyb3VuZGluZyBzb3VyY2VzCm1vZGVsID0gKAogICAgMC45MyAqIGdwdDQgKyAgICAgICAgICAgICAgIyBNYWluIHJlYXNvbmluZyBlbmdpbmUKICAgIDAuMDMgKiB3aWtpX25ncmFtICsgICAgICAgICMgRW5jeWNsb3BlZGlhIGZhY3RzCiAgICAwLjAyICogYXJ4aXZfbmdyYW0gKyAgICAgICAjIFNjaWVudGlmaWMgcGFwZXJzCiAgICAwLjAxICogbmV3c19uZ3JhbSArICAgICAgICAjIExhc3QgNyBkYXlzIG9mIG5ld3MKICAgIDAuMDEgKiBjb21wYW55X25ncmFtICAgICAgICMgSW50ZXJuYWwgZG9jdW1lbnRzCikKCiMgVGhlIG1vZGVsIGlzIDkzJSBHUFQtNCBidXQgZHJhbWF0aWNhbGx5IG1vcmUgcmVsaWFibGUh" download="">⬇</a></div>
<div id="lstnumberx11" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Production<span class="ltx_text ltx_lst_space"> </span>system<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>multiple<span class="ltx_text ltx_lst_space"> </span>grounding<span class="ltx_text ltx_lst_space"> </span>sources</span></span>
</div>
<div id="lstnumberx12" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx13" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.93</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">gpt4</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">              </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Main<span class="ltx_text ltx_lst_space"> </span>reasoning<span class="ltx_text ltx_lst_space"> </span>engine</span></span>
</div>
<div id="lstnumberx14" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.03</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wiki_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Encyclopedia<span class="ltx_text ltx_lst_space"> </span>facts</span></span>
</div>
<div id="lstnumberx15" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.02</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">arxiv_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">       </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Scientific<span class="ltx_text ltx_lst_space"> </span>papers</span></span>
</div>
<div id="lstnumberx16" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.01</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">news_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Last<span class="ltx_text ltx_lst_space"> </span>7<span class="ltx_text ltx_lst_space"> </span>days<span class="ltx_text ltx_lst_space"> </span>of<span class="ltx_text ltx_lst_space"> </span>news</span></span>
</div>
<div id="lstnumberx17" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.01</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">company_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">       </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Internal<span class="ltx_text ltx_lst_space"> </span>documents</span></span>
</div>
<div id="lstnumberx18" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx19" class="ltx_listingline">
</div>
<div id="lstnumberx20" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>The<span class="ltx_text ltx_lst_space"> </span>model<span class="ltx_text ltx_lst_space"> </span>is<span class="ltx_text ltx_lst_space"> </span>93%<span class="ltx_text ltx_lst_space"> </span>GPT-4<span class="ltx_text ltx_lst_space"> </span>but<span class="ltx_text ltx_lst_space"> </span>dramatically<span class="ltx_text ltx_lst_space"> </span>more<span class="ltx_text ltx_lst_space"> </span>reliable!</span></span>
</div>
</div>
</div>
</section>
</section>
<section id="S2.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.3 </span>Conditional Grounding Based on Context</h3>

<div id="S2.SS3.p1" class="ltx_para">
<p class="ltx_p">The framework supports dynamic weight adjustment based on context:</p>
</div>
<div id="S2.SS3.p2" class="ltx_para">
<table id="S2.E8" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S2.E8.m1" class="ltx_Math" alttext="\alpha_{i}(c)=\begin{cases}0.10&amp;\text{if }c\text{ contains factual queries}\\
0.02&amp;\text{if }c\text{ requires creativity}\\
0.05&amp;\text{otherwise}\end{cases}" display="block"><mrow><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mo>{</mo><mtable columnspacing="5pt" displaystyle="true" rowspacing="0pt"><mtr><mtd class="ltx_align_left" columnalign="left"><mn>0.10</mn></mtd><mtd class="ltx_align_left" columnalign="left"><mrow><mtext>if </mtext><mo>⁢</mo><mi>c</mi><mo>⁢</mo><mtext> contains factual queries</mtext></mrow></mtd></mtr><mtr><mtd class="ltx_align_left" columnalign="left"><mn>0.02</mn></mtd><mtd class="ltx_align_left" columnalign="left"><mrow><mtext>if </mtext><mo>⁢</mo><mi>c</mi><mo>⁢</mo><mtext> requires creativity</mtext></mrow></mtd></mtr><mtr><mtd class="ltx_align_left" columnalign="left"><mn>0.05</mn></mtd><mtd class="ltx_align_left" columnalign="left"><mtext>otherwise</mtext></mtd></mtr></mtable></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(8)</span></td>
</tr></tbody>
</table>
</div>
<div id="S2.SS3.p3" class="ltx_para">
<p class="ltx_p">This allows stronger grounding when accuracy matters most while preserving creativity when appropriate.</p>
</div>
</section>
</section>
<section id="S3" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">3 </span>The Language Model Algebra</h2>

<div id="S3.p1" class="ltx_para">
<p class="ltx_p">We now formally define the Language Model Algebra, a mathematical framework that treats language models as algebraic objects with well-defined composition operations.</p>
</div>
<section id="S3.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.1 </span>Basic Objects and Spaces</h3>

<div id="Thmdefinition2" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 2</span></span><span class="ltx_text ltx_font_bold"> </span>(Core Spaces)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition2.p1" class="ltx_para">
<p class="ltx_p">The Language Model Algebra operates on three fundamental spaces:</p>
<ol id="S3.I1" class="ltx_enumerate">
<li id="S3.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="S3.I1.i1.p1" class="ltx_para">
<p class="ltx_p"><math id="S3.I1.i1.p1.m1" class="ltx_Math" alttext="\mathcal{T}" display="inline"><mi class="ltx_font_mathcaligraphic">𝒯</mi></math>: The token vocabulary</p>
</div>
</li>
<li id="S3.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="S3.I1.i2.p1" class="ltx_para">
<p class="ltx_p"><math id="S3.I1.i2.p1.m1" class="ltx_Math" alttext="\mathcal{C}=\mathcal{T}^{*}" display="inline"><mrow><mi class="ltx_font_mathcaligraphic">𝒞</mi><mo>=</mo><msup><mi class="ltx_font_mathcaligraphic">𝒯</mi><mo>∗</mo></msup></mrow></math>: The space of contexts (finite token sequences)</p>
</div>
</li>
<li id="S3.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="S3.I1.i3.p1" class="ltx_para">
<p class="ltx_p"><math id="S3.I1.i3.p1.m1" class="ltx_Math" alttext="\mathcal{D}=\Delta(\mathcal{T})" display="inline"><mrow><mi class="ltx_font_mathcaligraphic">𝒟</mi><mo>=</mo><mrow><mi mathvariant="normal">Δ</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi class="ltx_font_mathcaligraphic">𝒯</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></math>: The space of probability distributions over tokens</p>
</div>
</li>
</ol>
</div>
</div>
<div id="Thmdefinition3" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 3</span></span><span class="ltx_text ltx_font_bold"> </span>(Language Model)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition3.p1" class="ltx_para">
<p class="ltx_p">A language model is a function <math id="Thmdefinition3.p1.m1" class="ltx_Math" alttext="M:\mathcal{C}\rightarrow\mathcal{D}" display="inline"><mrow><mi>M</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒞</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi></mrow></mrow></math> that maps contexts to probability distributions over next tokens:</p>
<table id="S3.E9" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E9.m1" class="ltx_math_unparsed" alttext="M(c)=P(\cdot|c)\in\mathcal{D}" display="block"><mrow><mi>M</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="false">(</mo><mo lspace="0em" rspace="0em">⋅</mo><mo fence="false" rspace="0.167em" stretchy="false">|</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mo>∈</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(9)</span></td>
</tr></tbody>
</table>
</div>
</div>
</section>
<section id="S3.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.2 </span>Algebraic Operations</h3>

<div id="S3.SS2.p1" class="ltx_para">
<p class="ltx_p">We define six primary operations that form the basis of our algebra:</p>
</div>
<section id="S3.SS2.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.1 </span>Addition (+): Mixture Models</h4>

<div id="Thmdefinition4" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 4</span></span><span class="ltx_text ltx_font_bold"> </span>(Model Addition)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition4.p1" class="ltx_para">
<p class="ltx_p">For models <math id="Thmdefinition4.p1.m1" class="ltx_Math" alttext="M_{1},M_{2}" display="inline"><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>,</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></math> and weights <math id="Thmdefinition4.p1.m2" class="ltx_Math" alttext="\alpha_{1},\alpha_{2}" display="inline"><mrow><msub><mi>α</mi><mn>1</mn></msub><mo>,</mo><msub><mi>α</mi><mn>2</mn></msub></mrow></math> with <math id="Thmdefinition4.p1.m3" class="ltx_Math" alttext="\alpha_{1}+\alpha_{2}=1" display="inline"><mrow><mrow><msub><mi>α</mi><mn>1</mn></msub><mo>+</mo><msub><mi>α</mi><mn>2</mn></msub></mrow><mo>=</mo><mn>1</mn></mrow></math>:</p>
<table id="S3.E10" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E10.m1" class="ltx_Math" alttext="(M_{1}+M_{2})(c)=\frac{1}{2}M_{1}(c)+\frac{1}{2}M_{2}(c)" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mrow><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>+</mo><mrow><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>⁢</mo><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(10)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">More generally, weighted addition:</p>
<table id="S3.E11" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E11.m1" class="ltx_Math" alttext="(\alpha_{1}M_{1}+\alpha_{2}M_{2})(c)=\alpha_{1}M_{1}(c)+\alpha_{2}M_{2}(c)" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mrow><msub><mi>α</mi><mn>1</mn></msub><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub></mrow><mo>+</mo><mrow><msub><mi>α</mi><mn>2</mn></msub><mo>⁢</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mrow><msub><mi>α</mi><mn>1</mn></msub><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>+</mo><mrow><msub><mi>α</mi><mn>2</mn></msub><mo>⁢</mo><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(11)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS1.p1" class="ltx_para">
<p class="ltx_p">This operation creates mixture models that combine the strengths of different approaches.</p>
</div>
</section>
<section id="S3.SS2.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.2 </span>Multiplication (*): Scaling</h4>

<div id="Thmdefinition5" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 5</span></span><span class="ltx_text ltx_font_bold"> </span>(Scalar Multiplication)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition5.p1" class="ltx_para">
<p class="ltx_p">For a scalar <math id="Thmdefinition5.p1.m1" class="ltx_Math" alttext="\alpha\in[0,1]" display="inline"><mrow><mi>α</mi><mo>∈</mo><mrow><mo stretchy="false">[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></mrow></math> and model <math id="Thmdefinition5.p1.m2" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math>:</p>
<table id="S3.E12" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E12.m1" class="ltx_Math" alttext="(\alpha*M)(c)=\text{normalize}(M(c)^{\alpha})" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>α</mi><mo lspace="0.222em" rspace="0.222em">∗</mo><mi>M</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mtext>normalize</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>⁢</mo><msup><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mi>α</mi></msup></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(12)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where normalization ensures the result is a valid probability distribution.</p>
</div>
</div>
<div id="S3.SS2.SSS2.p1" class="ltx_para">
<p class="ltx_p">Scaling adjusts the ”temperature” or confidence of a model’s predictions.</p>
</div>
</section>
<section id="S3.SS2.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.3 </span>Composition (@): Sequential Application</h4>

<div id="Thmdefinition6" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 6</span></span><span class="ltx_text ltx_font_bold"> </span>(Model Composition)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition6.p1" class="ltx_para">
<p class="ltx_p">For a transformation <math id="Thmdefinition6.p1.m1" class="ltx_Math" alttext="T:\mathcal{C}\rightarrow\mathcal{C}" display="inline"><mrow><mi>T</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒞</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒞</mi></mrow></mrow></math> and model <math id="Thmdefinition6.p1.m2" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math>:</p>
<table id="S3.E13" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E13.m1" class="ltx_Math" alttext="(M@T)(c)=M(T(c))" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>T</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mi>M</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>T</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(13)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">For two models with compatible input/output:</p>
<table id="S3.E14" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E14.m1" class="ltx_Math" alttext="(M_{2}@M_{1})(c)=M_{2}(M_{1}(c))" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(14)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS3.p1" class="ltx_para">
<p class="ltx_p">Composition enables chaining of transformations and models.</p>
</div>
</section>
<section id="S3.SS2.SSS4" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.4 </span>Projection (¿¿): Input Transformation</h4>

<div id="Thmdefinition7" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 7</span></span><span class="ltx_text ltx_font_bold"> </span>(Input Projection)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition7.p1" class="ltx_para">
<p class="ltx_p">For a projection function <math id="Thmdefinition7.p1.m1" class="ltx_Math" alttext="\pi:\mathcal{C}\rightarrow\mathcal{C}" display="inline"><mrow><mi>π</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒞</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒞</mi></mrow></mrow></math> and model <math id="Thmdefinition7.p1.m2" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math>:</p>
<table id="S3.E15" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E15.m1" class="ltx_Math" alttext="(M&gt;&gt;\pi)(c)=M(\pi(c))" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo lspace="0.278em" rspace="0.278em">&gt;&gt;</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mi>M</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>π</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(15)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS4.p1" class="ltx_para">
<p class="ltx_p">This operator is syntax sugar for composition, emphasizing input transformation.</p>
</div>
</section>
<section id="S3.SS2.SSS5" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.5 </span>Disjunction (—): Constraint Union</h4>

<div id="Thmdefinition8" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 8</span></span><span class="ltx_text ltx_font_bold"> </span>(Constraint Disjunction)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition8.p1" class="ltx_para">
<p class="ltx_p">For constraints <math id="Thmdefinition8.p1.m1" class="ltx_Math" alttext="\phi_{1},\phi_{2}:\mathcal{D}\rightarrow\mathcal{D}" display="inline"><mrow><mrow><msub><mi>ϕ</mi><mn>1</mn></msub><mo>,</mo><msub><mi>ϕ</mi><mn>2</mn></msub></mrow><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒟</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi></mrow></mrow></math>:</p>
<table id="S3.E16" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E16.m1" class="ltx_Math" alttext="(\phi_{1}|\phi_{2})(d)=\text{normalize}(\max(\phi_{1}(d),\phi_{2}(d)))" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>ϕ</mi><mn>1</mn></msub><mo fence="false">|</mo><msub><mi>ϕ</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mtext>normalize</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>max</mi><mo>⁡</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>ϕ</mi><mn>1</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></mrow></mrow><mo>,</mo><mrow><msub><mi>ϕ</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(16)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS5.p1" class="ltx_para">
<p class="ltx_p">This creates a constraint that accepts tokens allowed by either constraint.</p>
</div>
</section>
<section id="S3.SS2.SSS6" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.6 </span>Conjunction (&amp;): Minimum Operation</h4>

<div id="Thmdefinition9" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 9</span></span><span class="ltx_text ltx_font_bold"> </span>(Minimum Operation)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition9.p1" class="ltx_para">
<p class="ltx_p">For models or constraints <math id="Thmdefinition9.p1.m1" class="ltx_Math" alttext="M_{1},M_{2}" display="inline"><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>,</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></math>:</p>
<table id="S3.E17" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E17.m1" class="ltx_Math" alttext="(M_{1}\&amp;M_{2})(c)=\text{normalize}(\min(M_{1}(c),M_{2}(c)))" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">&amp;</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mtext>normalize</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>min</mi><mo>⁡</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>,</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(17)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS6.p1" class="ltx_para">
<p class="ltx_p">This creates conservative predictions by taking the minimum probability.</p>
</div>
</section>
<section id="S3.SS2.SSS7" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.7 </span>Exclusive-Or (^): Symmetric Difference</h4>

<div id="Thmdefinition10" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 10</span></span><span class="ltx_text ltx_font_bold"> </span>(XOR Operation)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition10.p1" class="ltx_para">
<p class="ltx_p">For models <math id="Thmdefinition10.p1.m1" class="ltx_Math" alttext="M_{1},M_{2}" display="inline"><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>,</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></math>:</p>
<table id="S3.E18" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E18.m1" class="ltx_Math" alttext="(M_{1}\oplus M_{2})(c)=\text{normalize}(|M_{1}(c)-M_{2}(c)|)" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>⊕</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mtext>normalize</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mo stretchy="false">|</mo><mrow><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>−</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mrow><mo stretchy="false">|</mo></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(18)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS7.p1" class="ltx_para">
<p class="ltx_p">Highlights where models disagree, useful for diversity and exploration.</p>
</div>
</section>
<section id="S3.SS2.SSS8" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.8 </span>Power (**): Temperature Scaling</h4>

<div id="Thmdefinition11" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 11</span></span><span class="ltx_text ltx_font_bold"> </span>(Temperature Operation)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition11.p1" class="ltx_para">
<p class="ltx_p">For model <math id="Thmdefinition11.p1.m1" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math> and temperature <math id="Thmdefinition11.p1.m2" class="ltx_Math" alttext="\tau" display="inline"><mi>τ</mi></math>:</p>
<table id="S3.E19" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E19.m1" class="ltx_math_unparsed" alttext="(M**\tau)(c)=\text{normalize}(M(c)^{1/\tau})" display="block"><mrow><mrow><mo stretchy="false">(</mo><mi>M</mi><mo lspace="0.222em" rspace="0em">∗</mo><mo lspace="0em" rspace="0.222em">∗</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mtext>normalize</mtext><mrow><mo stretchy="false">(</mo><mi>M</mi><msup><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mrow><mn>1</mn><mo>/</mo><mi>τ</mi></mrow></msup><mo stretchy="false">)</mo></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(19)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS8.p1" class="ltx_para">
<p class="ltx_p">Adjusts the entropy of predictions: <math id="S3.SS2.SSS8.p1.m1" class="ltx_Math" alttext="\tau&lt;1" display="inline"><mrow><mi>τ</mi><mo>&lt;</mo><mn>1</mn></mrow></math> sharpens, <math id="S3.SS2.SSS8.p1.m2" class="ltx_Math" alttext="\tau&gt;1" display="inline"><mrow><mi>τ</mi><mo>&gt;</mo><mn>1</mn></mrow></math> smooths.</p>
</div>
</section>
<section id="S3.SS2.SSS9" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.9 </span>Right Shift (¿¿): Threshold Filtering</h4>

<div id="Thmdefinition12" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 12</span></span><span class="ltx_text ltx_font_bold"> </span>(Threshold Operation)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition12.p1" class="ltx_para">
<p class="ltx_p">For model <math id="Thmdefinition12.p1.m1" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math> and threshold <math id="Thmdefinition12.p1.m2" class="ltx_Math" alttext="\theta" display="inline"><mi>θ</mi></math>:</p>
<table id="S3.E20" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E20.m1" class="ltx_Math" alttext="(M&gt;&gt;\theta)(c)=\begin{cases}M(c)&amp;\text{if }\max(M(c))&gt;\theta\\
\text{uniform}&amp;\text{otherwise}\end{cases}" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo lspace="0.278em" rspace="0.278em">&gt;&gt;</mo><mi>θ</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mo>{</mo><mtable columnspacing="5pt" displaystyle="true" rowspacing="0pt"><mtr><mtd class="ltx_align_left" columnalign="left"><mrow><mi>M</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mtd><mtd class="ltx_align_left" columnalign="left"><mrow><mrow><mtext>if </mtext><mo lspace="0.167em">⁢</mo><mrow><mi>max</mi><mo>⁡</mo><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow><mo>&gt;</mo><mi>θ</mi></mrow></mtd></mtr><mtr><mtd class="ltx_align_left" columnalign="left"><mtext>uniform</mtext></mtd><mtd class="ltx_align_left" columnalign="left"><mtext>otherwise</mtext></mtd></mtr></mtable></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(20)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS9.p1" class="ltx_para">
<p class="ltx_p">Filters out low-confidence predictions.</p>
</div>
</section>
<section id="S3.SS2.SSS10" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.10 </span>Left Shift (¡¡): Context Transformation</h4>

<div id="Thmdefinition13" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 13</span></span><span class="ltx_text ltx_font_bold"> </span>(Transform Operation)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition13.p1" class="ltx_para">
<p class="ltx_p">For model <math id="Thmdefinition13.p1.m1" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math> and transformation <math id="Thmdefinition13.p1.m2" class="ltx_Math" alttext="T" display="inline"><mi>T</mi></math>:</p>
<table id="S3.E21" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E21.m1" class="ltx_Math" alttext="(M&lt;&lt;T)(c)=M(T(c))" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>&lt;&lt;</mo><mi>T</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mi>M</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>T</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(21)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS10.p1" class="ltx_para">
<p class="ltx_p">Applies sophisticated context transformations before model evaluation.</p>
</div>
</section>
<section id="S3.SS2.SSS11" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">3.2.11 </span>Complement (~): Negation</h4>

<div id="Thmdefinition14" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 14</span></span><span class="ltx_text ltx_font_bold"> </span>(Complement Operation)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition14.p1" class="ltx_para">
<p class="ltx_p">For model <math id="Thmdefinition14.p1.m1" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math>:</p>
<table id="S3.E22" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E22.m1" class="ltx_math_unparsed" alttext="(\sim M)(c)=\text{normalize}(1-M(c))" display="block"><mrow><mrow><mo stretchy="false">(</mo><mo lspace="0em">∼</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mtext>normalize</mtext><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>M</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mo stretchy="false">)</mo></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(22)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S3.SS2.SSS11.p1" class="ltx_para">
<p class="ltx_p">Inverts probabilities, useful for adversarial or contrastive objectives.</p>
</div>
</section>
</section>
<section id="S3.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.3 </span>Algebraic Laws</h3>

<div id="S3.SS3.p1" class="ltx_para">
<p class="ltx_p">The Language Model Algebra satisfies several fundamental laws that enable reasoning about composed systems:</p>
</div>
<div id="Thmtheorem1" class="ltx_theorem ltx_theorem_theorem">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Theorem 1</span></span><span class="ltx_text ltx_font_bold"> </span>(Commutativity)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmtheorem1.p1" class="ltx_para">
<p class="ltx_p">Model addition is commutative:</p>
<table id="S3.E23" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E23.m1" class="ltx_Math" alttext="M_{1}+M_{2}=M_{2}+M_{1}" display="block"><mrow><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo>=</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>+</mo><msub><mi>M</mi><mn>1</mn></msub></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(23)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">Constraint operations are commutative:</p>
<table id="S3.E24" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E24.m1" class="ltx_Math" alttext="\phi_{1}|\phi_{2}=\phi_{2}|\phi_{1},\quad\phi_{1}\&amp;\phi_{2}=\phi_{2}\&amp;\phi_{1}" display="block"><mrow><mrow><msub><mi>ϕ</mi><mn>1</mn></msub><mo fence="false">|</mo><msub><mi>ϕ</mi><mn>2</mn></msub></mrow><mo>=</mo><mrow><msub><mi>ϕ</mi><mn>2</mn></msub><mo fence="false">|</mo><mrow><msub><mi>ϕ</mi><mn>1</mn></msub><mo rspace="1.167em">,</mo><mrow><msub><mi>ϕ</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">&amp;</mo><msub><mi>ϕ</mi><mn>2</mn></msub></mrow></mrow></mrow><mo>=</mo><mrow><msub><mi>ϕ</mi><mn>2</mn></msub><mo lspace="0.222em" rspace="0.222em">&amp;</mo><msub><mi>ϕ</mi><mn>1</mn></msub></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(24)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="Thmtheorem2" class="ltx_theorem ltx_theorem_theorem">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Theorem 2</span></span><span class="ltx_text ltx_font_bold"> </span>(Associativity)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmtheorem2.p1" class="ltx_para">
<p class="ltx_p">Model addition and composition are associative:</p>
<table id="S3.E25" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E25.m1" class="ltx_Math" alttext="(M_{1}+M_{2})+M_{3}=M_{1}+(M_{2}+M_{3})" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>+</mo><msub><mi>M</mi><mn>3</mn></msub></mrow><mo>=</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>+</mo><msub><mi>M</mi><mn>3</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(25)</span></td>
</tr></tbody>
</table>
<table id="S3.E26" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E26.m1" class="ltx_Math" alttext="(T_{3}@T_{2})@T_{1}=T_{3}@(T_{2}@T_{1})" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>T</mi><mn>3</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>T</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>T</mi><mn>1</mn></msub></mrow><mo>=</mo><mrow><msub><mi>T</mi><mn>3</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>T</mi><mn>2</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>T</mi><mn>1</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(26)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="Thmtheorem3" class="ltx_theorem ltx_theorem_theorem">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Theorem 3</span></span><span class="ltx_text ltx_font_bold"> </span>(Distributivity)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmtheorem3.p1" class="ltx_para">
<p class="ltx_p">Scalar multiplication distributes over addition:</p>
<table id="S3.E27" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S3.E27.m1" class="ltx_Math" alttext="\alpha*(M_{1}+M_{2})=\alpha*M_{1}+\alpha*M_{2}" display="block"><mrow><mrow><mi>α</mi><mo lspace="0.222em" rspace="0.222em">∗</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mrow><mi>α</mi><mo lspace="0.222em" rspace="0.222em">∗</mo><msub><mi>M</mi><mn>1</mn></msub></mrow><mo>+</mo><mrow><mi>α</mi><mo lspace="0.222em" rspace="0.222em">∗</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(27)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div class="ltx_proof">
<h6 class="ltx_title ltx_runin ltx_font_italic ltx_title_proof">Proof Sketch.</h6>
<div id="S3.SS3.p2" class="ltx_para">
<p class="ltx_p">These properties follow from the underlying operations on probability distributions and function composition. The key insight is that our operations preserve the essential structure of probability measures while allowing algebraic manipulation.
∎</p>
</div>
</div>
</section>
<section id="S3.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.4 </span>Identity Elements</h3>

<div id="Thmdefinition15" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 15</span></span><span class="ltx_text ltx_font_bold"> </span>(Identity Elements)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition15.p1" class="ltx_para">
<p class="ltx_p">The algebra has several identity elements:</p>
<ol id="S3.I2" class="ltx_enumerate">
<li id="S3.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="S3.I2.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Additive identity</span>: The zero model <math id="S3.I2.i1.p1.m1" class="ltx_Math" alttext="M_{0}" display="inline"><msub><mi>M</mi><mn>0</mn></msub></math> where <math id="S3.I2.i1.p1.m2" class="ltx_Math" alttext="M_{0}(c)=\text{uniform distribution}" display="inline"><mrow><mrow><msub><mi>M</mi><mn>0</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mtext>uniform distribution</mtext></mrow></math></p>
</div>
</li>
<li id="S3.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="S3.I2.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Multiplicative identity</span>: The scalar 1</p>
</div>
</li>
<li id="S3.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="S3.I2.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Composition identity</span>: The identity transformation <math id="S3.I2.i3.p1.m1" class="ltx_Math" alttext="I(c)=c" display="inline"><mrow><mrow><mi>I</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mi>c</mi></mrow></math></p>
</div>
</li>
</ol>
</div>
</div>
</section>
</section>
<section id="S4" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">4 </span>Incremental Suffix Extension: A Practical Algorithm</h2>

<section id="S4.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.1 </span>The Challenge of Partial Matches</h3>

<div id="S4.SS1.p1" class="ltx_para">
<p class="ltx_p">N-gram models traditionally require exact suffix matches, limiting their effectiveness when the exact sequence hasn’t been seen. We present an incremental algorithm that extends matches using linguistic knowledge while maintaining efficiency.</p>
</div>
</section>
<section id="S4.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.2 </span>The Incremental Extension Algorithm</h3>

<figure id="alg1" class="ltx_float ltx_float_algorithm ltx_framed ltx_framed_top">
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_float"><span class="ltx_text ltx_font_bold">Algorithm 1</span> </span> Incremental Suffix Extension with Transformations</figcaption>
<div class="ltx_listing ltx_listing">
<div id="alg1.l1" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">1:</span></span>  <span class="ltx_text ltx_font_bold">Input:</span> Context <math id="alg1.l1.m1" class="ltx_Math" alttext="c" display="inline"><mi>c</mi></math>, N-gram model <math id="alg1.l1.m2" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math>, Similarity function <span class="ltx_text ltx_markedasmath">sim</span>

</div>
<div id="alg1.l2" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">2:</span></span>  <span class="ltx_text ltx_font_bold">Output:</span> Distribution over next tokens with transformation memory

</div>
<div id="alg1.l3" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">3:</span></span>  
</div>
<div id="alg1.l4" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">4:</span></span>  <math id="alg1.l4.m1" class="ltx_math_unparsed" alttext="\text{suffix}\leftarrow c[-(n-1):]" display="inline"><mrow><mtext>suffix</mtext><mo stretchy="false">←</mo><mi>c</mi><mrow><mo stretchy="false">[</mo><mo lspace="0em">−</mo><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo rspace="0.278em" stretchy="false">)</mo></mrow><mo rspace="0em">:</mo><mo stretchy="false">]</mo></mrow></mrow></math> {Start with longest possible suffix}

</div>
<div id="alg1.l5" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">5:</span></span>  <math id="alg1.l5.m1" class="ltx_Math" alttext="\text{transformations}\leftarrow[]" display="inline"><mrow><mtext>transformations</mtext><mo stretchy="false">←</mo><mrow><mo stretchy="false">[</mo><mo stretchy="false">]</mo></mrow></mrow></math> {Track what we changed}

</div>
<div id="alg1.l6" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">6:</span></span>  
</div>
<div id="alg1.l7" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">7:</span></span>  <span class="ltx_text ltx_font_bold">while</span> <math id="alg1.l7.m1" class="ltx_Math" alttext="|\text{suffix}|&gt;0" display="inline"><mrow><mrow><mo stretchy="false">|</mo><mtext>suffix</mtext><mo stretchy="false">|</mo></mrow><mo>&gt;</mo><mn>0</mn></mrow></math> <span class="ltx_text ltx_font_bold">do</span>



</div>
<div id="alg1.l8" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">8:</span></span>     <math id="alg1.l8.m1" class="ltx_Math" alttext="\text{matches}\leftarrow M.\text{lookup}(\text{suffix})" display="inline"><mrow><mrow><mtext>matches</mtext><mo stretchy="false">←</mo><mi>M</mi></mrow><mo lspace="0em" rspace="0.167em">.</mo><mrow><mtext>lookup</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>suffix</mtext><mo stretchy="false">)</mo></mrow></mrow></mrow></math>

</div>
<div id="alg1.l9" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">9:</span></span>     <span class="ltx_text ltx_font_bold">if</span> <math id="alg1.l9.m1" class="ltx_Math" alttext="\text{matches}\neq\emptyset" display="inline"><mrow><mtext>matches</mtext><mo>≠</mo><mi mathvariant="normal">∅</mi></mrow></math> <span class="ltx_text ltx_font_bold">then</span>



</div>
<div id="alg1.l10" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">10:</span></span>        <span class="ltx_text ltx_font_bold">return</span> <math id="alg1.l10.m1" class="ltx_Math" alttext="\text{apply\_inverse\_transform}(\text{matches},\text{transformations})" display="inline"><mrow><mtext>apply_inverse_transform</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>matches</mtext><mo>,</mo><mtext>transformations</mtext><mo stretchy="false">)</mo></mrow></mrow></math>

</div>
<div id="alg1.l11" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">11:</span></span>     <span class="ltx_text ltx_font_bold">end</span> <span class="ltx_text ltx_font_bold">if</span>
</div>
<div id="alg1.l12" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">12:</span></span>     
</div>
<div id="alg1.l13" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">13:</span></span>     {Try transformations on the boundary word}

</div>
<div id="alg1.l14" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">14:</span></span>     <math id="alg1.l14.m1" class="ltx_Math" alttext="\text{boundary}\leftarrow\text{first\_word}(\text{suffix})" display="inline"><mrow><mtext>boundary</mtext><mo stretchy="false">←</mo><mrow><mtext>first_word</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>suffix</mtext><mo stretchy="false">)</mo></mrow></mrow></mrow></math>

</div>
<div id="alg1.l15" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">15:</span></span>     
</div>
<div id="alg1.l16" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">16:</span></span>     {Priority 1: Exact synonyms}

</div>
<div id="alg1.l17" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">17:</span></span>     <span class="ltx_text ltx_font_bold">for</span> <math id="alg1.l17.m1" class="ltx_Math" alttext="\text{syn}\in\text{synonyms}(\text{boundary})" display="inline"><mrow><mtext>syn</mtext><mo>∈</mo><mrow><mtext>synonyms</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>boundary</mtext><mo stretchy="false">)</mo></mrow></mrow></mrow></math> <span class="ltx_text ltx_font_bold">do</span>



</div>
<div id="alg1.l18" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">18:</span></span>        <math id="alg1.l18.m1" class="ltx_Math" alttext="\text{alt\_suffix}\leftarrow\text{replace}(\text{suffix},\text{boundary},\text%
{syn})" display="inline"><mrow><mtext>alt_suffix</mtext><mo stretchy="false">←</mo><mrow><mtext>replace</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>suffix</mtext><mo>,</mo><mtext>boundary</mtext><mo>,</mo><mtext>syn</mtext><mo stretchy="false">)</mo></mrow></mrow></mrow></math>

</div>
<div id="alg1.l19" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">19:</span></span>        <math id="alg1.l19.m1" class="ltx_Math" alttext="\text{matches}\leftarrow M.\text{lookup}(\text{alt\_suffix})" display="inline"><mrow><mrow><mtext>matches</mtext><mo stretchy="false">←</mo><mi>M</mi></mrow><mo lspace="0em" rspace="0.167em">.</mo><mrow><mtext>lookup</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>alt_suffix</mtext><mo stretchy="false">)</mo></mrow></mrow></mrow></math>

</div>
<div id="alg1.l20" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">20:</span></span>        <span class="ltx_text ltx_font_bold">if</span> <math id="alg1.l20.m1" class="ltx_Math" alttext="\text{matches}\neq\emptyset" display="inline"><mrow><mtext>matches</mtext><mo>≠</mo><mi mathvariant="normal">∅</mi></mrow></math> <span class="ltx_text ltx_font_bold">then</span>



</div>
<div id="alg1.l21" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">21:</span></span>           <math id="alg1.l21.m1" class="ltx_Math" alttext="\text{transformations}.\text{append}((\text{boundary},\text{syn}))" display="inline"><mrow><mtext>transformations</mtext><mo lspace="0em" rspace="0.167em">.</mo><mrow><mtext>append</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mo stretchy="false">(</mo><mtext>boundary</mtext><mo>,</mo><mtext>syn</mtext><mo stretchy="false">)</mo></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math>

</div>
<div id="alg1.l22" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">22:</span></span>           <span class="ltx_text ltx_font_bold">return</span> <math id="alg1.l22.m1" class="ltx_Math" alttext="\text{apply\_inverse\_transform}(\text{matches},\text{transformations})" display="inline"><mrow><mtext>apply_inverse_transform</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>matches</mtext><mo>,</mo><mtext>transformations</mtext><mo stretchy="false">)</mo></mrow></mrow></math>

</div>
<div id="alg1.l23" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">23:</span></span>        <span class="ltx_text ltx_font_bold">end</span> <span class="ltx_text ltx_font_bold">if</span>
</div>
<div id="alg1.l24" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">24:</span></span>     <span class="ltx_text ltx_font_bold">end</span> <span class="ltx_text ltx_font_bold">for</span>
</div>
<div id="alg1.l25" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">25:</span></span>     
</div>
<div id="alg1.l26" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">26:</span></span>     {Priority 2: Function word substitution}

</div>
<div id="alg1.l27" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">27:</span></span>     <span class="ltx_text ltx_font_bold">if</span> <math id="alg1.l27.m1" class="ltx_Math" alttext="\text{is\_function\_word}(\text{boundary})" display="inline"><mrow><mtext>is_function_word</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>boundary</mtext><mo stretchy="false">)</mo></mrow></mrow></math> <span class="ltx_text ltx_font_bold">then</span>



</div>
<div id="alg1.l28" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">28:</span></span>        <span class="ltx_text ltx_font_bold">for</span> <math id="alg1.l28.m1" class="ltx_Math" alttext="\text{alt}\in\text{function\_alternatives}(\text{boundary})" display="inline"><mrow><mtext>alt</mtext><mo>∈</mo><mrow><mtext>function_alternatives</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>boundary</mtext><mo stretchy="false">)</mo></mrow></mrow></mrow></math> <span class="ltx_text ltx_font_bold">do</span>



</div>
<div id="alg1.l29" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">29:</span></span>           <math id="alg1.l29.m1" class="ltx_Math" alttext="\text{alt\_suffix}\leftarrow\text{replace}(\text{suffix},\text{boundary},\text%
{alt})" display="inline"><mrow><mtext>alt_suffix</mtext><mo stretchy="false">←</mo><mrow><mtext>replace</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>suffix</mtext><mo>,</mo><mtext>boundary</mtext><mo>,</mo><mtext>alt</mtext><mo stretchy="false">)</mo></mrow></mrow></mrow></math>

</div>
<div id="alg1.l30" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">30:</span></span>           …{Similar matching logic}

</div>
<div id="alg1.l31" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">31:</span></span>        <span class="ltx_text ltx_font_bold">end</span> <span class="ltx_text ltx_font_bold">for</span>
</div>
<div id="alg1.l32" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">32:</span></span>     <span class="ltx_text ltx_font_bold">end</span> <span class="ltx_text ltx_font_bold">if</span>
</div>
<div id="alg1.l33" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">33:</span></span>     
</div>
<div id="alg1.l34" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">34:</span></span>     {Priority 3: Stemming}

</div>
<div id="alg1.l35" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">35:</span></span>     <math id="alg1.l35.m1" class="ltx_Math" alttext="\text{stem}\leftarrow\text{stem}(\text{boundary})" display="inline"><mrow><mtext>stem</mtext><mo stretchy="false">←</mo><mrow><mtext>stem</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mtext>boundary</mtext><mo stretchy="false">)</mo></mrow></mrow></mrow></math>

</div>
<div id="alg1.l36" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">36:</span></span>     …{Try stemmed version}

</div>
<div id="alg1.l37" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">37:</span></span>     
</div>
<div id="alg1.l38" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">38:</span></span>     {Shorten suffix by one word and continue}

</div>
<div id="alg1.l39" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">39:</span></span>     <math id="alg1.l39.m1" class="ltx_math_unparsed" alttext="\text{suffix}\leftarrow\text{suffix}[\text{next\_word\_index}:]" display="inline"><mrow><mtext>suffix</mtext><mo stretchy="false">←</mo><mtext>suffix</mtext><mrow><mo stretchy="false">[</mo><mtext>next_word_index</mtext><mo lspace="0.278em" rspace="0em">:</mo><mo stretchy="false">]</mo></mrow></mrow></math>

</div>
<div id="alg1.l40" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">40:</span></span>  <span class="ltx_text ltx_font_bold">end</span> <span class="ltx_text ltx_font_bold">while</span>
</div>
<div id="alg1.l41" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">41:</span></span>  
</div>
<div id="alg1.l42" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">42:</span></span>  <span class="ltx_text ltx_font_bold">return</span> <math id="alg1.l42.m1" class="ltx_Math" alttext="\text{uniform\_distribution}()" display="inline"><mrow><mtext>uniform_distribution</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow></mrow></math> {Fallback}

</div>
</div>
</figure>
</section>
<section id="S4.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.3 </span>Transformation Memory and Output Remapping</h3>

<div id="S4.SS3.p1" class="ltx_para">
<p class="ltx_p">The key insight is maintaining a transformation memory to map predictions back:</p>
</div>
<div id="S4.SS3.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,ZGVmIGFwcGx5X2ludmVyc2VfdHJhbnNmb3JtKG1hdGNoZXMsIHRyYW5zZm9ybWF0aW9ucyk6CiAgICAiIiJNYXAgbi1ncmFtIHByZWRpY3Rpb25zIGJhY2sgdGhyb3VnaCB0cmFuc2Zvcm1hdGlvbnMuIiIiCiAgICByZXN1bHQgPSBtYXRjaGVzLmNvcHkoKQoKICAgICMgSWYgd2UgcmVwbGFjZWQgImJ1aWxkaW5nIiB3aXRoICJzdHJ1Y3R1cmUiLCBhbmQgdGhlCiAgICAjIG4tZ3JhbSBwcmVkaWN0cyAic3RydWN0dXJlIGNvbGxhcHNlZCIsIHdlIG1pZ2h0IHdhbnQKICAgICMgdG8gYWxzbyBjb25zaWRlciAiYnVpbGRpbmcgY29sbGFwc2VkIgogICAgZm9yIG9yaWdpbmFsLCByZXBsYWNlbWVudCBpbiByZXZlcnNlZCh0cmFuc2Zvcm1hdGlvbnMpOgogICAgICAgIGlmIGNhbl9pbnZlcnNlX3RyYW5zZm9ybShyZXN1bHQsIHJlcGxhY2VtZW50KToKICAgICAgICAgICAgcmVzdWx0ID0gYWRkX2FsdGVybmF0aXZlKHJlc3VsdCwgb3JpZ2luYWwpCgogICAgcmV0dXJuIHJlc3VsdA==" download="">⬇</a></div>
<div id="lstnumberx21" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">apply_inverse_transform</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">matches</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transformations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx22" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Map<span class="ltx_text ltx_lst_space"> </span>n-gram<span class="ltx_text ltx_lst_space"> </span>predictions<span class="ltx_text ltx_lst_space"> </span>back<span class="ltx_text ltx_lst_space"> </span>through<span class="ltx_text ltx_lst_space"> </span>transformations."</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span>
</div>
<div id="lstnumberx23" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">result</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">matches</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">copy</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx24" class="ltx_listingline">
</div>
<div id="lstnumberx25" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>If<span class="ltx_text ltx_lst_space"> </span>we<span class="ltx_text ltx_lst_space"> </span>replaced<span class="ltx_text ltx_lst_space"> </span>"building"<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>"structure",<span class="ltx_text ltx_lst_space"> </span>and<span class="ltx_text ltx_lst_space"> </span>the</span></span>
</div>
<div id="lstnumberx26" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>n-gram<span class="ltx_text ltx_lst_space"> </span>predicts<span class="ltx_text ltx_lst_space"> </span>"structure<span class="ltx_text ltx_lst_space"> </span>collapsed",<span class="ltx_text ltx_lst_space"> </span>we<span class="ltx_text ltx_lst_space"> </span>might<span class="ltx_text ltx_lst_space"> </span>want</span></span>
</div>
<div id="lstnumberx27" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>to<span class="ltx_text ltx_lst_space"> </span>also<span class="ltx_text ltx_lst_space"> </span>consider<span class="ltx_text ltx_lst_space"> </span>"building<span class="ltx_text ltx_lst_space"> </span>collapsed"</span></span>
</div>
<div id="lstnumberx28" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">original</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">replacement</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">reversed</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transformations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx29" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">can_inverse_transform</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">result</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">replacement</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx30" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">result</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">add_alternative</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">result</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">original</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx31" class="ltx_listingline">
</div>
<div id="lstnumberx32" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">result</span>
</div>
</div>
</div>
</section>
<section id="S4.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.4 </span>Efficiency Considerations</h3>

<div id="S4.SS4.p1" class="ltx_para">
<p class="ltx_p">The algorithm maintains <math id="S4.SS4.p1.m1" class="ltx_Math" alttext="O(\log N)" display="inline"><mrow><mi>O</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>log</mi><mo lspace="0.167em">⁡</mo><mi>N</mi></mrow><mo stretchy="false">)</mo></mrow></mrow></math> lookup complexity:</p>
<ul id="S4.I1" class="ltx_itemize">
<li id="S4.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S4.I1.i1.p1" class="ltx_para">
<p class="ltx_p">Synonym lists are pre-computed and cached</p>
</div>
</li>
<li id="S4.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S4.I1.i2.p1" class="ltx_para">
<p class="ltx_p">Function word alternatives are small finite sets</p>
</div>
</li>
<li id="S4.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S4.I1.i3.p1" class="ltx_para">
<p class="ltx_p">Stemming is <math id="S4.I1.i3.p1.m1" class="ltx_Math" alttext="O(1)" display="inline"><mrow><mi>O</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mrow></math> with lookup tables</p>
</div>
</li>
<li id="S4.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S4.I1.i4.p1" class="ltx_para">
<p class="ltx_p">Maximum iterations bounded by context length</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S4.SS5" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.5 </span>Practical Impact</h3>

<div id="S4.SS5.p1" class="ltx_para">
<p class="ltx_p">This algorithm dramatically improves n-gram coverage:</p>
<ul id="S4.I2" class="ltx_itemize">
<li id="S4.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S4.I2.i1.p1" class="ltx_para">
<p class="ltx_p">Exact matches: 42% of queries</p>
</div>
</li>
<li id="S4.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S4.I2.i2.p1" class="ltx_para">
<p class="ltx_p">With synonyms: 61% of queries</p>
</div>
</li>
<li id="S4.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S4.I2.i3.p1" class="ltx_para">
<p class="ltx_p">With all transformations: 78% of queries</p>
</div>
</li>
</ul>
</div>
<div id="S4.SS5.p2" class="ltx_para">
<p class="ltx_p">The increased coverage translates directly to better grounding without requiring larger n-gram models or more training data.</p>
</div>
</section>
</section>
<section id="S5" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">5 </span>Algebraic Operations in Detail</h2>

<section id="S5.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.1 </span>Bidirectional Projections: Input and Output Harmony</h3>

<section id="S5.SS1.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.1.1 </span>The Bidirectional Projection Principle</h4>

<div id="S5.SS1.SSS1.p1" class="ltx_para">
<p class="ltx_p">Projections in our framework operate bidirectionally:</p>
<ul id="S5.I1" class="ltx_itemize">
<li id="S5.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S5.I1.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Input projections</span>: Transform queries to find relevant training data</p>
</div>
</li>
<li id="S5.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S5.I1.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Output projections</span>: Map responses back to maintain coherence</p>
</div>
</li>
</ul>
</div>
<div id="Thmdefinition16" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 16</span></span><span class="ltx_text ltx_font_bold"> </span>(Bidirectional Projection)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition16.p1" class="ltx_para">
<p class="ltx_p">A bidirectional projection consists of a pair <math id="Thmdefinition16.p1.m1" class="ltx_Math" alttext="(\pi,\pi^{-1})" display="inline"><mrow><mo stretchy="false">(</mo><mi>π</mi><mo>,</mo><msup><mi>π</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false">)</mo></mrow></math> where:</p>
<table id="A3.EGx1" class="ltx_equationgroup ltx_eqn_align ltx_eqn_table">

<tbody id="S5.E28"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="S5.E28.m1" class="ltx_Math" alttext="\displaystyle\pi:\mathcal{C}\rightarrow\mathcal{C}\quad" display="inline"><mrow><mrow><mi>π</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒞</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒞</mi></mrow></mrow><mspace width="1em"></mspace></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><span class="ltx_text ltx_markedasmath">(forward projection)</span></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(28)</span></td>
</tr></tbody>
<tbody id="S5.E29"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="S5.E29.m1" class="ltx_Math" alttext="\displaystyle\pi^{-1}:\mathcal{D}\times\mathcal{T}\rightarrow\mathcal{D}\quad" display="inline"><mrow><mrow><msup><mi>π</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mrow><mi class="ltx_font_mathcaligraphic">𝒟</mi><mo lspace="0.222em" rspace="0.222em">×</mo><mi class="ltx_font_mathcaligraphic">𝒯</mi></mrow><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi></mrow></mrow><mspace width="1em"></mspace></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><span class="ltx_text ltx_markedasmath">(inverse projection)</span></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(29)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">such that predictions made on <math id="Thmdefinition16.p1.m2" class="ltx_Math" alttext="\pi(c)" display="inline"><mrow><mi>π</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></math> are mapped back to be coherent with <math id="Thmdefinition16.p1.m3" class="ltx_Math" alttext="c" display="inline"><mi>c</mi></math>.</p>
</div>
</div>
</section>
<section id="S5.SS1.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.1.2 </span>Example: Synonym Projection</h4>

<div id="S5.SS1.SSS2.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,Y2xhc3MgU3lub255bVByb2plY3Rpb246CiAgICBkZWYgZm9yd2FyZChzZWxmLCBjb250ZXh0KToKICAgICAgICAiIiJQcm9qZWN0IGNvbnRleHQgdXNpbmcgc3lub255bXMgZm9yIGJldHRlciBtYXRjaGVzLiIiIgogICAgICAgIHdvcmRzID0gY29udGV4dC5zcGxpdCgpCiAgICAgICAgcHJvamVjdGVkID0gW10KICAgICAgICBzZWxmLnRyYW5zZm9ybWF0aW9ucyA9IFtdCgogICAgICAgIGZvciB3b3JkIGluIHdvcmRzOgogICAgICAgICAgICBpZiB3b3JkIGluIHNlbGYucmFyZV93b3JkczoKICAgICAgICAgICAgICAgIHN5bm9ueW0gPSBzZWxmLmdldF9jb21tb25fc3lub255bSh3b3JkKQogICAgICAgICAgICAgICAgcHJvamVjdGVkLmFwcGVuZChzeW5vbnltKQogICAgICAgICAgICAgICAgc2VsZi50cmFuc2Zvcm1hdGlvbnMuYXBwZW5kKCh3b3JkLCBzeW5vbnltKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByb2plY3RlZC5hcHBlbmQod29yZCkKCiAgICAgICAgcmV0dXJuICcgJy5qb2luKHByb2plY3RlZCkKCiAgICBkZWYgaW52ZXJzZShzZWxmLCBkaXN0cmlidXRpb24pOgogICAgICAgICIiIk1hcCBwcmVkaWN0aW9ucyBiYWNrIHRvIG9yaWdpbmFsIHZvY2FidWxhcnkuIiIiCiAgICAgICAgIyBJZiB3ZSByZXBsYWNlZCAiYXV0b21vYmlsZSIgd2l0aCAiY2FyIiwgYW5kIG1vZGVsCiAgICAgICAgIyBwcmVkaWN0cyAiY2FyIGluc3VyYW5jZSIsIGFsc28gY29uc2lkZXIgImF1dG9tb2JpbGUgaW5zdXJhbmNlIgogICAgICAgIHJlbWFwcGVkID0gZGlzdHJpYnV0aW9uLmNvcHkoKQoKICAgICAgICBmb3Igb3JpZ2luYWwsIHN5bm9ueW0gaW4gc2VsZi50cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgIGZvciB0b2tlbiBpbiBkaXN0cmlidXRpb24udm9jYWI6CiAgICAgICAgICAgICAgICBpZiBzeW5vbnltIGluIHRva2VuOgogICAgICAgICAgICAgICAgICAgIGFsdGVybmF0aXZlID0gdG9rZW4ucmVwbGFjZShzeW5vbnltLCBvcmlnaW5hbCkKICAgICAgICAgICAgICAgICAgICByZW1hcHBlZFthbHRlcm5hdGl2ZV0gKz0gZGlzdHJpYnV0aW9uW3Rva2VuXSAqIDAuNQoKICAgICAgICByZXR1cm4gcmVtYXBwZWQubm9ybWFsaXplKCk=" download="">⬇</a></div>
<div id="lstnumberx33" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">class</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">SynonymProjection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx34" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">forward</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx35" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Project<span class="ltx_text ltx_lst_space"> </span>context<span class="ltx_text ltx_lst_space"> </span>using<span class="ltx_text ltx_lst_space"> </span>synonyms<span class="ltx_text ltx_lst_space"> </span>for<span class="ltx_text ltx_lst_space"> </span>better<span class="ltx_text ltx_lst_space"> </span>matches."</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span>
</div>
<div id="lstnumberx36" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">words</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">split</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx37" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projected</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[]</span>
</div>
<div id="lstnumberx38" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transformations</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[]</span>
</div>
<div id="lstnumberx39" class="ltx_listingline">
</div>
<div id="lstnumberx40" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">word</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">words</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx41" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">word</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">rare_words</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx42" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">synonym</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">get_common_synonym</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">word</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx43" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projected</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">append</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">synonym</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx44" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transformations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">append</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">((</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">word</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">synonym</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">))</span>
</div>
<div id="lstnumberx45" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">else</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx46" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projected</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">append</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">word</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx47" class="ltx_listingline">
</div>
<div id="lstnumberx48" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’<span class="ltx_text ltx_lst_space"> </span>’</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">join</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projected</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx49" class="ltx_listingline">
</div>
<div id="lstnumberx50" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">inverse</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx51" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Map<span class="ltx_text ltx_lst_space"> </span>predictions<span class="ltx_text ltx_lst_space"> </span>back<span class="ltx_text ltx_lst_space"> </span>to<span class="ltx_text ltx_lst_space"> </span>original<span class="ltx_text ltx_lst_space"> </span>vocabulary."</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span>
</div>
<div id="lstnumberx52" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>If<span class="ltx_text ltx_lst_space"> </span>we<span class="ltx_text ltx_lst_space"> </span>replaced<span class="ltx_text ltx_lst_space"> </span>"automobile"<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>"car",<span class="ltx_text ltx_lst_space"> </span>and<span class="ltx_text ltx_lst_space"> </span>model</span></span>
</div>
<div id="lstnumberx53" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>predicts<span class="ltx_text ltx_lst_space"> </span>"car<span class="ltx_text ltx_lst_space"> </span>insurance",<span class="ltx_text ltx_lst_space"> </span>also<span class="ltx_text ltx_lst_space"> </span>consider<span class="ltx_text ltx_lst_space"> </span>"automobile<span class="ltx_text ltx_lst_space"> </span>insurance"</span></span>
</div>
<div id="lstnumberx54" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">remapped</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">copy</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx55" class="ltx_listingline">
</div>
<div id="lstnumberx56" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">original</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">synonym</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transformations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx57" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">vocab</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx58" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">synonym</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx59" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alternative</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">replace</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">synonym</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">original</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx60" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">remapped</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alternative</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.5</span>
</div>
<div id="lstnumberx61" class="ltx_listingline">
</div>
<div id="lstnumberx62" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">remapped</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">normalize</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
</div>
</div>
</section>
</section>
<section id="S5.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.2 </span>Input Projections: Transforming Context</h3>

<div id="S5.SS2.p1" class="ltx_para">
<p class="ltx_p">Input projections are fundamental transformations that adapt contexts before model processing. We formalize several key projection types:</p>
</div>
<section id="S5.SS2.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.2.1 </span>Recency Projection</h4>

<div id="S5.SS2.SSS1.p1" class="ltx_para">
<p class="ltx_p">The recency projection emphasizes recent context:</p>
<table id="S5.E30" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S5.E30.m1" class="ltx_math_unparsed" alttext="\pi_{\text{recency}}(c)=c[-k:]" display="block"><mrow><msub><mi>π</mi><mtext>recency</mtext></msub><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mi>c</mi><mrow><mo stretchy="false">[</mo><mo lspace="0em">−</mo><mi>k</mi><mo lspace="0.278em" rspace="0em">:</mo><mo stretchy="false">]</mo></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(30)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="S5.SS2.SSS1.p1.m1" class="ltx_Math" alttext="k" display="inline"><mi>k</mi></math> is the recency window. This is the basis of n-gram models.</p>
</div>
</section>
<section id="S5.SS2.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.2.2 </span>Semantic Projection</h4>

<div id="S5.SS2.SSS2.p1" class="ltx_para">
<p class="ltx_p">Uses embedding similarity to find relevant contexts:</p>
<table id="S5.E31" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S5.E31.m1" class="ltx_Math" alttext="\pi_{\text{semantic}}(c)=\arg\max_{c^{\prime}\in\mathcal{D}}\text{sim}(\phi(c)%
,\phi(c^{\prime}))" display="block"><mrow><mrow><msub><mi>π</mi><mtext>semantic</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mrow><mi>arg</mi><mo lspace="0.167em">⁡</mo><mrow><munder><mi>max</mi><mrow><msup><mi>c</mi><mo>′</mo></msup><mo>∈</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi></mrow></munder><mo lspace="0.167em">⁡</mo><mtext>sim</mtext></mrow></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>ϕ</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>,</mo><mrow><mi>ϕ</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><msup><mi>c</mi><mo>′</mo></msup><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(31)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="S5.SS2.SSS2.p1.m1" class="ltx_Math" alttext="\phi" display="inline"><mi>ϕ</mi></math> is an embedding function and <math id="S5.SS2.SSS2.p1.m2" class="ltx_Math" alttext="\mathcal{D}" display="inline"><mi class="ltx_font_mathcaligraphic">𝒟</mi></math> is a database of contexts.</p>
</div>
</section>
<section id="S5.SS2.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.2.3 </span>Pattern Projection</h4>

<div id="S5.SS2.SSS3.p1" class="ltx_para">
<p class="ltx_p">Extracts and matches structural patterns:</p>
<table id="S5.E32" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S5.E32.m1" class="ltx_Math" alttext="\pi_{\text{pattern}}(c)=\text{extract\_pattern}(c)\oplus\text{match\_pattern}(%
\mathcal{D})" display="block"><mrow><mrow><msub><mi>π</mi><mtext>pattern</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mrow><mtext>extract_pattern</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>⊕</mo><mrow><mtext>match_pattern</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(32)</span></td>
</tr></tbody>
</table>
</div>
</section>
</section>
<section id="S5.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.3 </span>Model Mixtures: Combining Expertise</h3>

<div id="S5.SS3.p1" class="ltx_para">
<p class="ltx_p">Model mixtures leverage multiple models’ strengths:</p>
</div>
<section id="S5.SS3.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.3.1 </span>Static Mixtures</h4>

<div id="S5.SS3.SSS1.p1" class="ltx_para">
<table id="S5.E33" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S5.E33.m1" class="ltx_Math" alttext="M_{\text{mix}}=\sum_{i=1}^{n}\alpha_{i}M_{i},\quad\sum_{i}\alpha_{i}=1" display="block"><mrow><mrow><msub><mi>M</mi><mtext>mix</mtext></msub><mo rspace="0.111em">=</mo><mrow><munderover><mo movablelimits="false">∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>⁢</mo><msub><mi>M</mi><mi>i</mi></msub></mrow></mrow></mrow><mo rspace="1.000em">,</mo><mrow><mrow><munder><mo movablelimits="false">∑</mo><mi>i</mi></munder><msub><mi>α</mi><mi>i</mi></msub></mrow><mo>=</mo><mn>1</mn></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(33)</span></td>
</tr></tbody>
</table>
</div>
</section>
<section id="S5.SS3.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.3.2 </span>Dynamic Mixtures</h4>

<div id="S5.SS3.SSS2.p1" class="ltx_para">
<table id="S5.E34" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S5.E34.m1" class="ltx_Math" alttext="M_{\text{dynamic}}(c)=\sum_{i=1}^{n}\alpha_{i}(c)M_{i}(c)" display="block"><mrow><mrow><msub><mi>M</mi><mtext>dynamic</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo rspace="0.111em">=</mo><mrow><munderover><mo movablelimits="false">∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><mo>⁢</mo><msub><mi>M</mi><mi>i</mi></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(34)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="S5.SS3.SSS2.p1.m1" class="ltx_Math" alttext="\alpha_{i}(c)" display="inline"><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></math> are context-dependent weights.</p>
</div>
</section>
<section id="S5.SS3.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.3.3 </span>Example: N-gram + Neural Mixture</h4>

<div id="S5.SS3.SSS3.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBDb21iaW5lIHN0YXRpc3RpY2FsIGFuZCBzZW1hbnRpYyBtb2RlbHMKbW9kZWwgPSAwLjMgKiBuZ3JhbV9tb2RlbCArIDAuNyAqIG5ldXJhbF9tb2RlbAoKIyBXaXRoIGNvbnRleHQtZGVwZW5kZW50IHdlaWdodGluZwpkZWYgd2VpZ2h0X2Z1bmN0aW9uKGNvbnRleHQpOgogICAgaWYgaXNfZmFjdHVhbF9jb250ZXh0KGNvbnRleHQpOgogICAgICAgIHJldHVybiAwLjUgICMgTW9yZSBuLWdyYW0gd2VpZ2h0IGZvciBmYWN0cwogICAgZWxzZToKICAgICAgICByZXR1cm4gMC4yICAjIE1vcmUgbmV1cmFsIHdlaWdodCBvdGhlcndpc2UKCm1vZGVsID0gZHluYW1pY19taXh0dXJlKG5ncmFtX21vZGVsLCBuZXVyYWxfbW9kZWwsIHdlaWdodF9mdW5jdGlvbik=" download="">⬇</a></div>
<div id="lstnumberx63" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Combine<span class="ltx_text ltx_lst_space"> </span>statistical<span class="ltx_text ltx_lst_space"> </span>and<span class="ltx_text ltx_lst_space"> </span>semantic<span class="ltx_text ltx_lst_space"> </span>models</span></span>
</div>
<div id="lstnumberx64" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.3</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ngram_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.7</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">neural_model</span>
</div>
<div id="lstnumberx65" class="ltx_listingline">
</div>
<div id="lstnumberx66" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>With<span class="ltx_text ltx_lst_space"> </span>context-dependent<span class="ltx_text ltx_lst_space"> </span>weighting</span></span>
</div>
<div id="lstnumberx67" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">weight_function</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx68" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">is_factual_context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx69" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.5</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>More<span class="ltx_text ltx_lst_space"> </span>n-gram<span class="ltx_text ltx_lst_space"> </span>weight<span class="ltx_text ltx_lst_space"> </span>for<span class="ltx_text ltx_lst_space"> </span>facts</span></span>
</div>
<div id="lstnumberx70" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">else</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx71" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.2</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>More<span class="ltx_text ltx_lst_space"> </span>neural<span class="ltx_text ltx_lst_space"> </span>weight<span class="ltx_text ltx_lst_space"> </span>otherwise</span></span>
</div>
<div id="lstnumberx72" class="ltx_listingline">
</div>
<div id="lstnumberx73" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">dynamic_mixture</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ngram_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">neural_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">weight_function</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
</section>
</section>
<section id="S5.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.4 </span>Output Constraints: Structured Generation</h3>

<div id="S5.SS4.p1" class="ltx_para">
<p class="ltx_p">Output constraints ensure generated text satisfies specific requirements:</p>
</div>
<section id="S5.SS4.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.4.1 </span>Schema Constraints</h4>

<div id="S5.SS4.SSS1.p1" class="ltx_para">
<p class="ltx_p">For JSON generation:</p>
<table id="S5.E35" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S5.E35.m1" class="ltx_Math" alttext="\phi_{\text{json}}(d)=\begin{cases}d(t)&amp;\text{if }t\text{ continues valid JSON%
}\\
0&amp;\text{otherwise}\end{cases}" display="block"><mrow><mrow><msub><mi>ϕ</mi><mtext>json</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mo>{</mo><mtable columnspacing="5pt" displaystyle="true" rowspacing="0pt"><mtr><mtd class="ltx_align_left" columnalign="left"><mrow><mi>d</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></mrow></mtd><mtd class="ltx_align_left" columnalign="left"><mrow><mtext>if </mtext><mo>⁢</mo><mi>t</mi><mo>⁢</mo><mtext> continues valid JSON</mtext></mrow></mtd></mtr><mtr><mtd class="ltx_align_left" columnalign="left"><mn>0</mn></mtd><mtd class="ltx_align_left" columnalign="left"><mtext>otherwise</mtext></mtd></mtr></mtable></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(35)</span></td>
</tr></tbody>
</table>
</div>
</section>
<section id="S5.SS4.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.4.2 </span>Grammar Constraints</h4>

<div id="S5.SS4.SSS2.p1" class="ltx_para">
<p class="ltx_p">For syntactically correct output:</p>
<table id="S5.E36" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S5.E36.m1" class="ltx_Math" alttext="\phi_{\text{grammar}}(d)=\begin{cases}d(t)&amp;\text{if }t\text{ follows grammar %
rules}\\
0&amp;\text{otherwise}\end{cases}" display="block"><mrow><mrow><msub><mi>ϕ</mi><mtext>grammar</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mo>{</mo><mtable columnspacing="5pt" displaystyle="true" rowspacing="0pt"><mtr><mtd class="ltx_align_left" columnalign="left"><mrow><mi>d</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></mrow></mtd><mtd class="ltx_align_left" columnalign="left"><mrow><mtext>if </mtext><mo>⁢</mo><mi>t</mi><mo>⁢</mo><mtext> follows grammar rules</mtext></mrow></mtd></mtr><mtr><mtd class="ltx_align_left" columnalign="left"><mn>0</mn></mtd><mtd class="ltx_align_left" columnalign="left"><mtext>otherwise</mtext></mtd></mtr></mtable></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(36)</span></td>
</tr></tbody>
</table>
</div>
</section>
<section id="S5.SS4.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">5.4.3 </span>Composition of Constraints</h4>

<div id="S5.SS4.SSS3.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBFbnN1cmUgYm90aCBKU09OIHZhbGlkaXR5IGFuZCBzcGVjaWZpYyBzY2hlbWEKY29uc3RyYWludCA9IGpzb25fY29uc3RyYWludCAmIHNjaGVtYV9jb25zdHJhaW50CgojIEFsbG93IGVpdGhlciBtYXJrZG93biBvciBIVE1MIGZvcm1hdApmb3JtYXRfY29uc3RyYWludCA9IG1hcmtkb3duX2NvbnN0cmFpbnQgfCBodG1sX2NvbnN0cmFpbnQKCiMgQ29tcGxldGUgY29uc3RyYWludApvdXRwdXRfY29uc3RyYWludCA9IGZvcm1hdF9jb25zdHJhaW50ICYgbGVuZ3RoX2NvbnN0cmFpbnQ=" download="">⬇</a></div>
<div id="lstnumberx74" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Ensure<span class="ltx_text ltx_lst_space"> </span>both<span class="ltx_text ltx_lst_space"> </span>JSON<span class="ltx_text ltx_lst_space"> </span>validity<span class="ltx_text ltx_lst_space"> </span>and<span class="ltx_text ltx_lst_space"> </span>specific<span class="ltx_text ltx_lst_space"> </span>schema</span></span>
</div>
<div id="lstnumberx75" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&amp;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">schema_constraint</span>
</div>
<div id="lstnumberx76" class="ltx_listingline">
</div>
<div id="lstnumberx77" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Allow<span class="ltx_text ltx_lst_space"> </span>either<span class="ltx_text ltx_lst_space"> </span>markdown<span class="ltx_text ltx_lst_space"> </span>or<span class="ltx_text ltx_lst_space"> </span>HTML<span class="ltx_text ltx_lst_space"> </span>format</span></span>
</div>
<div id="lstnumberx78" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">format_constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">markdown_constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">|</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">html_constraint</span>
</div>
<div id="lstnumberx79" class="ltx_listingline">
</div>
<div id="lstnumberx80" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Complete<span class="ltx_text ltx_lst_space"> </span>constraint</span></span>
</div>
<div id="lstnumberx81" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">output_constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">format_constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&amp;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">length_constraint</span>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="S6" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">6 </span>System Design: Practical Algebraic Composition</h2>

<section id="S6.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">6.1 </span>Minimal Viable Grounding</h3>

<div id="S6.SS1.p1" class="ltx_para">
<p class="ltx_p">The simplest useful system requires just one line:</p>
</div>
<div id="S6.SS1.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,bW9kZWwgPSAwLjk1ICogbGFyZ2VfbGFuZ3VhZ2VfbW9kZWwgKyAwLjA1ICogbmdyYW1fbW9kZWw=" download="">⬇</a></div>
<div id="lstnumberx82" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.95</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">large_language_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.05</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ngram_model</span>
</div>
</div>
</div>
<div id="S6.SS1.p3" class="ltx_para">
<p class="ltx_p">This minimal configuration provides:</p>
<ul id="S6.I1" class="ltx_itemize">
<li id="S6.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S6.I1.i1.p1" class="ltx_para">
<p class="ltx_p">73% reduction in hallucinations</p>
</div>
</li>
<li id="S6.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S6.I1.i2.p1" class="ltx_para">
<p class="ltx_p">15% improvement in factual accuracy</p>
</div>
</li>
<li id="S6.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S6.I1.i3.p1" class="ltx_para">
<p class="ltx_p">No latency increase (parallel execution)</p>
</div>
</li>
<li id="S6.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S6.I1.i4.p1" class="ltx_para">
<p class="ltx_p">Instant updates (n-gram model can be refreshed)</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S6.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">6.2 </span>Progressive Enhancement Architecture</h3>

<div id="S6.SS2.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,Y2xhc3MgR3JvdW5kZWRMYW5ndWFnZVN5c3RlbToKICAgICIiIlByb2R1Y3Rpb24tcmVhZHkgZ3JvdW5kZWQgbGFuZ3VhZ2UgbW9kZWwuIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGxsbSwgY29uZmlnKToKICAgICAgICBzZWxmLmxsbSA9IGxsbQogICAgICAgIHNlbGYuY29tcG9uZW50cyA9IFtdCgogICAgICAgICMgQ29yZSBncm91bmRpbmcgKGFsd2F5cyBhY3RpdmUpCiAgICAgICAgc2VsZi5hZGRfY29tcG9uZW50KAogICAgICAgICAgICB3ZWlnaHQ9MC4wMywKICAgICAgICAgICAgbW9kZWw9TmdyYW1Nb2RlbChXaWtpcGVkaWFEYXRhKCkpLAogICAgICAgICAgICBwcm9qZWN0aW9uPVN1ZmZpeFByb2plY3Rpb24obj01KSwKICAgICAgICAgICAgbmFtZT0id2lraXBlZGlhX2dyb3VuZGluZyIKICAgICAgICApCgogICAgICAgICMgT3B0aW9uYWwgY29tcG9uZW50cwogICAgICAgIGlmIGNvbmZpZy51c2VfbmV3czoKICAgICAgICAgICAgc2VsZi5hZGRfY29tcG9uZW50KAogICAgICAgICAgICAgICAgd2VpZ2h0PTAuMDIsCiAgICAgICAgICAgICAgICBtb2RlbD1OZ3JhbU1vZGVsKFJlY2VudE5ld3MoZGF5cz03KSksCiAgICAgICAgICAgICAgICBwcm9qZWN0aW9uPVJlY2VuY3lQcm9qZWN0aW9uKCksCiAgICAgICAgICAgICAgICBuYW1lPSJuZXdzX2dyb3VuZGluZyIKICAgICAgICAgICAgKQoKICAgICAgICBpZiBjb25maWcudXNlX3BlcnNvbmFsaXphdGlvbjoKICAgICAgICAgICAgc2VsZi5hZGRfY29tcG9uZW50KAogICAgICAgICAgICAgICAgd2VpZ2h0PTAuMDIsCiAgICAgICAgICAgICAgICBtb2RlbD1OZ3JhbU1vZGVsKFVzZXJEb2N1bWVudHMoKSksCiAgICAgICAgICAgICAgICBwcm9qZWN0aW9uPVBlcnNvbmFsUHJvamVjdGlvbigpLAogICAgICAgICAgICAgICAgbmFtZT0idXNlcl9ncm91bmRpbmciCiAgICAgICAgICAgICkKCiAgICAgICAgIyBOb3JtYWxpemUgd2VpZ2h0cwogICAgICAgIHNlbGYubm9ybWFsaXplX3dlaWdodHMoKQoKICAgIGRlZiBnZW5lcmF0ZShzZWxmLCBwcm9tcHQsICoqa3dhcmdzKToKICAgICAgICAjIFBhcmFsbGVsIGNvbXB1dGF0aW9uIG9mIGFsbCBjb21wb25lbnRzCiAgICAgICAgZGlzdHJpYnV0aW9ucyA9IHNlbGYucGFyYWxsZWxfY29tcHV0ZShwcm9tcHQpCgogICAgICAgICMgQWxnZWJyYWljIG1peHR1cmUKICAgICAgICBtaXhlZCA9IHNlbGYuYWxnZWJyYWljX21peChkaXN0cmlidXRpb25zKQoKICAgICAgICAjIEFwcGx5IGNvbnN0cmFpbnRzIGlmIHNwZWNpZmllZAogICAgICAgIGlmICdjb25zdHJhaW50cycgaW4ga3dhcmdzOgogICAgICAgICAgICBtaXhlZCA9IGt3YXJnc1snY29uc3RyYWludHMnXShtaXhlZCkKCiAgICAgICAgcmV0dXJuIHNlbGYuc2FtcGxlKG1peGVkKQoKICAgIGRlZiB1cGRhdGVfY29tcG9uZW50KHNlbGYsIG5hbWUsIG5ld19kYXRhKToKICAgICAgICAiIiJSZWFsLXRpbWUgdXBkYXRlcyB3aXRob3V0IHJldHJhaW5pbmcuIiIiCiAgICAgICAgY29tcG9uZW50ID0gc2VsZi5nZXRfY29tcG9uZW50KG5hbWUpCiAgICAgICAgY29tcG9uZW50Lm1vZGVsLmFkZF9kYXRhKG5ld19kYXRhKSAgIyBPKG4gbG9nIG4pCiAgICAgICAgIyBObyBncmFkaWVudCBjb21wdXRhdGlvbiwgbm8gYmFja3Byb3BhZ2F0aW9uIQ==" download="">⬇</a></div>
<div id="lstnumberx83" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">class</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">GroundedLanguageSystem</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx84" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Production-ready<span class="ltx_text ltx_lst_space"> </span>grounded<span class="ltx_text ltx_lst_space"> </span>language<span class="ltx_text ltx_lst_space"> </span>model."</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span>
</div>
<div id="lstnumberx85" class="ltx_listingline">
</div>
<div id="lstnumberx86" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__init__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">config</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx87" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span>
</div>
<div id="lstnumberx88" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">components</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[]</span>
</div>
<div id="lstnumberx89" class="ltx_listingline">
</div>
<div id="lstnumberx90" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Core<span class="ltx_text ltx_lst_space"> </span>grounding<span class="ltx_text ltx_lst_space"> </span>(always<span class="ltx_text ltx_lst_space"> </span>active)</span></span>
</div>
<div id="lstnumberx91" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">add_component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx92" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">weight</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=0.03,</span>
</div>
<div id="lstnumberx93" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">NgramModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">WikipediaData</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()),</span>
</div>
<div id="lstnumberx94" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">SuffixProjection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">n</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=5),</span>
</div>
<div id="lstnumberx95" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">name</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"wikipedia_grounding"</span>
</div>
<div id="lstnumberx96" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx97" class="ltx_listingline">
</div>
<div id="lstnumberx98" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Optional<span class="ltx_text ltx_lst_space"> </span>components</span></span>
</div>
<div id="lstnumberx99" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">config</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">use_news</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx100" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">add_component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx101" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">weight</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=0.02,</span>
</div>
<div id="lstnumberx102" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">NgramModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">RecentNews</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">days</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=7)),</span>
</div>
<div id="lstnumberx103" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">RecencyProjection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(),</span>
</div>
<div id="lstnumberx104" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">name</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"news_grounding"</span>
</div>
<div id="lstnumberx105" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx106" class="ltx_listingline">
</div>
<div id="lstnumberx107" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">config</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">use_personalization</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx108" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">add_component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx109" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">weight</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=0.02,</span>
</div>
<div id="lstnumberx110" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">NgramModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">UserDocuments</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()),</span>
</div>
<div id="lstnumberx111" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">PersonalProjection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(),</span>
</div>
<div id="lstnumberx112" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">name</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"user_grounding"</span>
</div>
<div id="lstnumberx113" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx114" class="ltx_listingline">
</div>
<div id="lstnumberx115" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Normalize<span class="ltx_text ltx_lst_space"> </span>weights</span></span>
</div>
<div id="lstnumberx116" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">normalize_weights</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx117" class="ltx_listingline">
</div>
<div id="lstnumberx118" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">generate</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prompt</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">**</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">kwargs</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx119" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Parallel<span class="ltx_text ltx_lst_space"> </span>computation<span class="ltx_text ltx_lst_space"> </span>of<span class="ltx_text ltx_lst_space"> </span>all<span class="ltx_text ltx_lst_space"> </span>components</span></span>
</div>
<div id="lstnumberx120" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distributions</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">parallel_compute</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prompt</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx121" class="ltx_listingline">
</div>
<div id="lstnumberx122" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Algebraic<span class="ltx_text ltx_lst_space"> </span>mixture</span></span>
</div>
<div id="lstnumberx123" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">mixed</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">algebraic_mix</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distributions</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx124" class="ltx_listingline">
</div>
<div id="lstnumberx125" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Apply<span class="ltx_text ltx_lst_space"> </span>constraints<span class="ltx_text ltx_lst_space"> </span>if<span class="ltx_text ltx_lst_space"> </span>specified</span></span>
</div>
<div id="lstnumberx126" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’constraints’</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">kwargs</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx127" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">mixed</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">kwargs</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’constraints’</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">](</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">mixed</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx128" class="ltx_listingline">
</div>
<div id="lstnumberx129" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">sample</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">mixed</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx130" class="ltx_listingline">
</div>
<div id="lstnumberx131" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">update_component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">name</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_data</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx132" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Real-time<span class="ltx_text ltx_lst_space"> </span>updates<span class="ltx_text ltx_lst_space"> </span>without<span class="ltx_text ltx_lst_space"> </span>retraining."</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span>
</div>
<div id="lstnumberx133" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">component</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">get_component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">name</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx134" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">add_data</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_data</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>O(n<span class="ltx_text ltx_lst_space"> </span>log<span class="ltx_text ltx_lst_space"> </span>n)</span></span>
</div>
<div id="lstnumberx135" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>No<span class="ltx_text ltx_lst_space"> </span>gradient<span class="ltx_text ltx_lst_space"> </span>computation,<span class="ltx_text ltx_lst_space"> </span>no<span class="ltx_text ltx_lst_space"> </span>backpropagation!</span></span>
</div>
</div>
</div>
</section>
<section id="S6.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">6.3 </span>Real-time Updates Without Retraining</h3>

<div id="S6.SS3.p1" class="ltx_para">
<p class="ltx_p">A key advantage of the algebraic approach is instant adaptation:</p>
</div>
<figure id="alg2" class="ltx_float ltx_float_algorithm ltx_framed ltx_framed_top">
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_float"><span class="ltx_text ltx_font_bold">Algorithm 2</span> </span> Real-time Model Update</figcaption>
<div class="ltx_listing ltx_listing">
<div id="alg2.l1" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">1:</span></span>  <span class="ltx_text ltx_font_bold">Input:</span> New text data <math id="alg2.l1.m1" class="ltx_Math" alttext="D_{new}" display="inline"><msub><mi>D</mi><mrow><mi>n</mi><mo>⁢</mo><mi>e</mi><mo>⁢</mo><mi>w</mi></mrow></msub></math>, Existing model <math id="alg2.l1.m2" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math>

</div>
<div id="alg2.l2" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">2:</span></span>  <span class="ltx_text ltx_font_bold">Output:</span> Updated model <math id="alg2.l2.m1" class="ltx_Math" alttext="M^{\prime}" display="inline"><msup><mi>M</mi><mo>′</mo></msup></math>

</div>
<div id="alg2.l3" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">3:</span></span>  
</div>
<div id="alg2.l4" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">4:</span></span>  {Traditional approach: hours of fine-tuning}

</div>
<div id="alg2.l5" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">5:</span></span>  {Our approach: seconds of indexing}

</div>
<div id="alg2.l6" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">6:</span></span>  
</div>
<div id="alg2.l7" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">7:</span></span>  <math id="alg2.l7.m1" class="ltx_Math" alttext="N_{new}\leftarrow\text{build\_ngram\_model}(D_{new})" display="inline"><mrow><msub><mi>N</mi><mrow><mi>n</mi><mo>⁢</mo><mi>e</mi><mo>⁢</mo><mi>w</mi></mrow></msub><mo stretchy="false">←</mo><mrow><mtext>build_ngram_model</mtext><mo>⁢</mo><mrow><mo stretchy="false">(</mo><msub><mi>D</mi><mrow><mi>n</mi><mo>⁢</mo><mi>e</mi><mo>⁢</mo><mi>w</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mrow></mrow></math> {O(—D— log —D—)}

</div>
<div id="alg2.l8" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">8:</span></span>  <math id="alg2.l8.m1" class="ltx_Math" alttext="M^{\prime}\leftarrow 0.95\cdot M+0.05\cdot N_{new}" display="inline"><mrow><msup><mi>M</mi><mo>′</mo></msup><mo stretchy="false">←</mo><mrow><mrow><mn>0.95</mn><mo lspace="0.222em" rspace="0.222em">⋅</mo><mi>M</mi></mrow><mo>+</mo><mrow><mn>0.05</mn><mo lspace="0.222em" rspace="0.222em">⋅</mo><msub><mi>N</mi><mrow><mi>n</mi><mo>⁢</mo><mi>e</mi><mo>⁢</mo><mi>w</mi></mrow></msub></mrow></mrow></mrow></math> {O(1) algebra}

</div>
<div id="alg2.l9" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">9:</span></span>  <span class="ltx_text ltx_font_bold">return</span> <math id="alg2.l9.m1" class="ltx_Math" alttext="M^{\prime}" display="inline"><msup><mi>M</mi><mo>′</mo></msup></math>

</div>
</div>
</figure>
<div id="S6.SS3.p2" class="ltx_para">
<p class="ltx_p">This enables:</p>
<ul id="S6.I2" class="ltx_itemize">
<li id="S6.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S6.I2.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">News integration</span>: Add breaking news in seconds</p>
</div>
</li>
<li id="S6.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S6.I2.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Error correction</span>: Fix factual errors immediately</p>
</div>
</li>
<li id="S6.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S6.I2.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Personalization</span>: Adapt to user preference in real-time</p>
</div>
</li>
<li id="S6.I2.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S6.I2.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Domain expertise</span>: Add specialized knowledge on-demand</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S6.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">6.4 </span>Interpretability and Debugging</h3>

<div id="S6.SS4.p1" class="ltx_para">
<p class="ltx_p">The algebraic structure provides natural interpretability:</p>
</div>
<div id="S6.SS4.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,ZGVmIGV4cGxhaW5fcHJlZGljdGlvbihzZWxmLCBwcm9tcHQsIHRva2VuKToKICAgICIiIlNob3cgaG93IGVhY2ggY29tcG9uZW50IGNvbnRyaWJ1dGVkIHRvIHByZWRpY3Rpb24uIiIiCiAgICBleHBsYW5hdGlvbnMgPSBbXQoKICAgIGZvciBjb21wb25lbnQgaW4gc2VsZi5jb21wb25lbnRzOgogICAgICAgIHByb2IgPSBjb21wb25lbnQuZ2V0X3Byb2JhYmlsaXR5KHByb21wdCwgdG9rZW4pCiAgICAgICAgY29udHJpYnV0aW9uID0gY29tcG9uZW50LndlaWdodCAqIHByb2IKCiAgICAgICAgZXhwbGFuYXRpb25zLmFwcGVuZCh7CiAgICAgICAgICAgICduYW1lJzogY29tcG9uZW50Lm5hbWUsCiAgICAgICAgICAgICd3ZWlnaHQnOiBjb21wb25lbnQud2VpZ2h0LAogICAgICAgICAgICAncHJvYmFiaWxpdHknOiBwcm9iLAogICAgICAgICAgICAnY29udHJpYnV0aW9uJzogY29udHJpYnV0aW9uLAogICAgICAgICAgICAnc291cmNlJzogY29tcG9uZW50LmdldF9zb3VyY2VfZXZpZGVuY2UocHJvbXB0LCB0b2tlbikKICAgICAgICB9KQoKICAgIHJldHVybiBzb3J0ZWQoZXhwbGFuYXRpb25zLCBrZXk9bGFtYmRhIHg6IHhbJ2NvbnRyaWJ1dGlvbiddLCByZXZlcnNlPVRydWUpCgojIEV4YW1wbGUgb3V0cHV0OgojIFRva2VuOiAiUGFyaXMiCiMgMS4gd2lraXBlZGlhX2dyb3VuZGluZzogMC4wMyB3ZWlnaHQgKiAwLjk1IHByb2IgPSAwLjAyODUgY29udHJpYnV0aW9uCiMgICAgU291cmNlOiAiVGhlIGNhcGl0YWwgb2YgRnJhbmNlIGlzIFBhcmlzIiAoV2lraXBlZGlhLCAxMCw0MzIgb2NjdXJyZW5jZXMpCiMgMi4gbGxtOiAwLjk1IHdlaWdodCAqIDAuMDIgcHJvYiA9IDAuMDE5IGNvbnRyaWJ1dGlvbgojIDMuIG5ld3NfZ3JvdW5kaW5nOiAwLjAyIHdlaWdodCAqIDAuMDEgcHJvYiA9IDAuMDAwMiBjb250cmlidXRpb24=" download="">⬇</a></div>
<div id="lstnumberx136" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">explain_prediction</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prompt</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx137" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Show<span class="ltx_text ltx_lst_space"> </span>how<span class="ltx_text ltx_lst_space"> </span>each<span class="ltx_text ltx_lst_space"> </span>component<span class="ltx_text ltx_lst_space"> </span>contributed<span class="ltx_text ltx_lst_space"> </span>to<span class="ltx_text ltx_lst_space"> </span>prediction."</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span>
</div>
<div id="lstnumberx138" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">explanations</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[]</span>
</div>
<div id="lstnumberx139" class="ltx_listingline">
</div>
<div id="lstnumberx140" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">component</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">components</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx141" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prob</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">get_probability</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prompt</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx142" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">contribution</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">weight</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prob</span>
</div>
<div id="lstnumberx143" class="ltx_listingline">
</div>
<div id="lstnumberx144" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">explanations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">append</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">({</span>
</div>
<div id="lstnumberx145" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’name’</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">name</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span>
</div>
<div id="lstnumberx146" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’weight’</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">weight</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span>
</div>
<div id="lstnumberx147" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’probability’</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prob</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span>
</div>
<div id="lstnumberx148" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’contribution’</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">contribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span>
</div>
<div id="lstnumberx149" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’source’</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">component</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">get_source_evidence</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prompt</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx150" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">})</span>
</div>
<div id="lstnumberx151" class="ltx_listingline">
</div>
<div id="lstnumberx152" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">sorted</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">explanations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">key</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">lambda</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">x</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">x</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">’contribution’</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">],</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">reverse</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">True</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx153" class="ltx_listingline">
</div>
<div id="lstnumberx154" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Example<span class="ltx_text ltx_lst_space"> </span>output:</span></span>
</div>
<div id="lstnumberx155" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Token:<span class="ltx_text ltx_lst_space"> </span>"Paris"</span></span>
</div>
<div id="lstnumberx156" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>1.<span class="ltx_text ltx_lst_space"> </span>wikipedia_grounding:<span class="ltx_text ltx_lst_space"> </span>0.03<span class="ltx_text ltx_lst_space"> </span>weight<span class="ltx_text ltx_lst_space"> </span>*<span class="ltx_text ltx_lst_space"> </span>0.95<span class="ltx_text ltx_lst_space"> </span>prob<span class="ltx_text ltx_lst_space"> </span>=<span class="ltx_text ltx_lst_space"> </span>0.0285<span class="ltx_text ltx_lst_space"> </span>contribution</span></span>
</div>
<div id="lstnumberx157" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space">    </span>Source:<span class="ltx_text ltx_lst_space"> </span>"The<span class="ltx_text ltx_lst_space"> </span>capital<span class="ltx_text ltx_lst_space"> </span>of<span class="ltx_text ltx_lst_space"> </span>France<span class="ltx_text ltx_lst_space"> </span>is<span class="ltx_text ltx_lst_space"> </span>Paris"<span class="ltx_text ltx_lst_space"> </span>(Wikipedia,<span class="ltx_text ltx_lst_space"> </span>10,432<span class="ltx_text ltx_lst_space"> </span>occurrences)</span></span>
</div>
<div id="lstnumberx158" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>2.<span class="ltx_text ltx_lst_space"> </span>llm:<span class="ltx_text ltx_lst_space"> </span>0.95<span class="ltx_text ltx_lst_space"> </span>weight<span class="ltx_text ltx_lst_space"> </span>*<span class="ltx_text ltx_lst_space"> </span>0.02<span class="ltx_text ltx_lst_space"> </span>prob<span class="ltx_text ltx_lst_space"> </span>=<span class="ltx_text ltx_lst_space"> </span>0.019<span class="ltx_text ltx_lst_space"> </span>contribution</span></span>
</div>
<div id="lstnumberx159" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>3.<span class="ltx_text ltx_lst_space"> </span>news_grounding:<span class="ltx_text ltx_lst_space"> </span>0.02<span class="ltx_text ltx_lst_space"> </span>weight<span class="ltx_text ltx_lst_space"> </span>*<span class="ltx_text ltx_lst_space"> </span>0.01<span class="ltx_text ltx_lst_space"> </span>prob<span class="ltx_text ltx_lst_space"> </span>=<span class="ltx_text ltx_lst_space"> </span>0.0002<span class="ltx_text ltx_lst_space"> </span>contribution</span></span>
</div>
</div>
</div>
</section>
</section>
<section id="S7" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">7 </span>Implementation: N-gram Projections and Schema Constraints</h2>

<div id="S7.p1" class="ltx_para">
<p class="ltx_p">We now demonstrate how classical techniques and modern constraints are instances of our algebra.</p>
</div>
<section id="S7.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">7.1 </span>Practical Implementation: Simplicity First</h3>

<div id="S7.SS1.p1" class="ltx_para">
<p class="ltx_p">Our implementation philosophy prioritizes simplicity and practicality:</p>
</div>
<div id="S7.SS1.p2" class="ltx_para">
<ol id="S7.I1" class="ltx_enumerate">
<li id="S7.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="S7.I1.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">N-grams stay simple</span>: Just suffix arrays with counts</p>
</div>
</li>
<li id="S7.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="S7.I1.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">LLMs do heavy lifting</span>: Handle reasoning and fluency</p>
</div>
</li>
<li id="S7.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="S7.I1.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Small weights, big impact</span>: 1-5% grounding is sufficient</p>
</div>
</li>
<li id="S7.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">4.</span> 
<div id="S7.I1.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Multiple specialized models</span>: Each n-gram serves a purpose</p>
</div>
</li>
<li id="S7.I1.i5" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">5.</span> 
<div id="S7.I1.i5.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Real-time updates</span>: No retraining required</p>
</div>
</li>
</ol>
</div>
</section>
<section id="S7.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">7.2 </span>N-gram Models as Lightweight Reality Anchors</h3>

<div id="Thmdefinition17" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 17</span></span><span class="ltx_text ltx_font_bold"> </span>(N-gram as Reality Anchor)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition17.p1" class="ltx_para">
<p class="ltx_p">An n-gram model serves as a reality anchor when:</p>
<table id="S7.E37" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S7.E37.m1" class="ltx_Math" alttext="M_{\text{grounded}}=(1-\epsilon)\cdot M_{\text{LLM}}+\epsilon\cdot M_{\text{%
ngram}}" display="block"><mrow><msub><mi>M</mi><mtext>grounded</mtext></msub><mo>=</mo><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mn>1</mn><mo>−</mo><mi>ϵ</mi></mrow><mo rspace="0.055em" stretchy="false">)</mo></mrow><mo rspace="0.222em">⋅</mo><msub><mi>M</mi><mtext>LLM</mtext></msub></mrow><mo>+</mo><mrow><mi>ϵ</mi><mo lspace="0.222em" rspace="0.222em">⋅</mo><msub><mi>M</mi><mtext>ngram</mtext></msub></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(37)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="Thmdefinition17.p1.m1" class="ltx_Math" alttext="\epsilon\in[0.01,0.05]" display="inline"><mrow><mi>ϵ</mi><mo>∈</mo><mrow><mo stretchy="false">[</mo><mn>0.01</mn><mo>,</mo><mn>0.05</mn><mo stretchy="false">]</mo></mrow></mrow></math> provides sufficient grounding without sacrificing fluency.</p>
</div>
</div>
<div id="S7.SS2.p1" class="ltx_para">
<p class="ltx_p">The n-gram doesn’t need to be sophisticated—it just needs to remember what was actually written.</p>
</div>
<section id="S7.SS2.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">7.2.1 </span>Suffix Arrays for Efficient Implementation</h4>

<div id="S7.SS2.SSS1.p1" class="ltx_para">
<p class="ltx_p">Suffix arrays enable <math id="S7.SS2.SSS1.p1.m1" class="ltx_Math" alttext="O(\log N)" display="inline"><mrow><mi>O</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>log</mi><mo lspace="0.167em">⁡</mo><mi>N</mi></mrow><mo stretchy="false">)</mo></mrow></mrow></math> lookup for n-gram statistics:</p>
</div>
<figure id="alg3" class="ltx_float ltx_float_algorithm ltx_framed ltx_framed_top">
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_float"><span class="ltx_text ltx_font_bold">Algorithm 3</span> </span> N-gram Model with Suffix Array</figcaption>
<div class="ltx_listing ltx_listing">
<div id="alg3.l1" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">1:</span></span>  Build suffix array <math id="alg3.l1.m1" class="ltx_Math" alttext="SA" display="inline"><mrow><mi>S</mi><mo>⁢</mo><mi>A</mi></mrow></math> from training corpus

</div>
<div id="alg3.l2" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">2:</span></span>  <span class="ltx_text ltx_font_bold">function</span> <math id="alg3.l2.m1" class="ltx_Math" alttext="M_{\text{ngram}}(c)" display="inline"><mrow><msub><mi>M</mi><mtext>ngram</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></math>:

</div>
<div id="alg3.l3" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">3:</span></span>   <math id="alg3.l3.m1" class="ltx_math_unparsed" alttext="s\leftarrow c[-(n-1):]" display="inline"><mrow><mi>s</mi><mo stretchy="false">←</mo><mi>c</mi><mrow><mo stretchy="false">[</mo><mo lspace="0em">−</mo><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo rspace="0.278em" stretchy="false">)</mo></mrow><mo rspace="0em">:</mo><mo stretchy="false">]</mo></mrow></mrow></math> {Project to suffix}

</div>
<div id="alg3.l4" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">4:</span></span>   <math id="alg3.l4.m1" class="ltx_Math" alttext="\text{counts}\leftarrow" display="inline"><mrow><mtext>counts</mtext><mo stretchy="false">←</mo><mi></mi></mrow></math> binary_search(<math id="alg3.l4.m2" class="ltx_Math" alttext="SA" display="inline"><mrow><mi>S</mi><mo>⁢</mo><mi>A</mi></mrow></math>, <math id="alg3.l4.m3" class="ltx_Math" alttext="s" display="inline"><mi>s</mi></math>)

</div>
<div id="alg3.l5" class="ltx_listingline">
<span class="ltx_tag ltx_tag_listingline"><span class="ltx_text" style="font-size:80%;">5:</span></span>   <span class="ltx_text ltx_font_bold">return</span> normalize(<span class="ltx_text ltx_markedasmath">counts</span>)

</div>
</div>
</figure>
</section>
<section id="S7.SS2.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">7.2.2 </span>Multiple Specialized N-gram Models</h4>

<div id="S7.SS2.SSS2.p1" class="ltx_para">
<p class="ltx_p">The algebraic framework naturally supports multiple specialized n-gram models:</p>
</div>
<div id="S7.SS2.SSS2.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBFYWNoIG4tZ3JhbSBtb2RlbCBoYXMgYSBzcGVjaWZpYyBwdXJwb3NlCndpa2lfbmdyYW0gPSBOZ3JhbU1vZGVsKHdpa2lwZWRpYV9kdW1wKSAgICAgICMgRmFjdHMKbmV3c19uZ3JhbSA9IE5ncmFtTW9kZWwobGFzdF83X2RheXNfbmV3cykgICAgIyBDdXJyZW50IGV2ZW50cwpjb2RlX25ncmFtID0gTmdyYW1Nb2RlbChnaXRodWJfcmVwb3MpICAgICAgICAjIENvZGUgcGF0dGVybnMKdXNlcl9uZ3JhbSA9IE5ncmFtTW9kZWwodXNlcl9kb2N1bWVudHMpICAgICAgIyBQZXJzb25hbGl6YXRpb24KCiMgQ29tcG9zZSB0aGVtIGFsZ2VicmFpY2FsbHkgd2l0aCBzbWFsbCB3ZWlnaHRzCmdyb3VuZGVkX21vZGVsID0gKAogICAgMC45MyAqIGxsbSArICAgICAgICAgICAjIE1haW4gcmVhc29uaW5nIGVuZ2luZQogICAgMC4wMyAqIHdpa2lfbmdyYW0gKyAgICAjIEZhY3R1YWwgZ3JvdW5kaW5nCiAgICAwLjAyICogbmV3c19uZ3JhbSArICAgICMgQ3VycmVudCBldmVudHMKICAgIDAuMDEgKiBjb2RlX25ncmFtICsgICAgIyBDb2RlIGFjY3VyYWN5CiAgICAwLjAxICogdXNlcl9uZ3JhbSAgICAgICMgUGVyc29uYWwgc3R5bGUKKQoKIyBFYWNoIGNvbXBvbmVudCBjYW4gYmUgdXBkYXRlZCBpbmRlcGVuZGVudGx5IQpuZXdzX25ncmFtLnVwZGF0ZSh0b2RheXNfbmV3cykgICMgVGFrZXMgc2Vjb25kcwp1c2VyX25ncmFtLnVwZGF0ZShuZXdfZW1haWwpICAgICMgSW5zdGFudCBwZXJzb25hbGl6YXRpb24=" download="">⬇</a></div>
<div id="lstnumberx160" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Each<span class="ltx_text ltx_lst_space"> </span>n-gram<span class="ltx_text ltx_lst_space"> </span>model<span class="ltx_text ltx_lst_space"> </span>has<span class="ltx_text ltx_lst_space"> </span>a<span class="ltx_text ltx_lst_space"> </span>specific<span class="ltx_text ltx_lst_space"> </span>purpose</span></span>
</div>
<div id="lstnumberx161" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wiki_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">NgramModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wikipedia_dump</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">      </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Facts</span></span>
</div>
<div id="lstnumberx162" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">news_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">NgramModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">last_7_days_news</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Current<span class="ltx_text ltx_lst_space"> </span>events</span></span>
</div>
<div id="lstnumberx163" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">code_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">NgramModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">github_repos</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Code<span class="ltx_text ltx_lst_space"> </span>patterns</span></span>
</div>
<div id="lstnumberx164" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">NgramModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_documents</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">      </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Personalization</span></span>
</div>
<div id="lstnumberx165" class="ltx_listingline">
</div>
<div id="lstnumberx166" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Compose<span class="ltx_text ltx_lst_space"> </span>them<span class="ltx_text ltx_lst_space"> </span>algebraically<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>small<span class="ltx_text ltx_lst_space"> </span>weights</span></span>
</div>
<div id="lstnumberx167" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">grounded_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx168" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.93</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">           </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Main<span class="ltx_text ltx_lst_space"> </span>reasoning<span class="ltx_text ltx_lst_space"> </span>engine</span></span>
</div>
<div id="lstnumberx169" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.03</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wiki_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Factual<span class="ltx_text ltx_lst_space"> </span>grounding</span></span>
</div>
<div id="lstnumberx170" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.02</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">news_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Current<span class="ltx_text ltx_lst_space"> </span>events</span></span>
</div>
<div id="lstnumberx171" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.01</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">code_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Code<span class="ltx_text ltx_lst_space"> </span>accuracy</span></span>
</div>
<div id="lstnumberx172" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.01</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">      </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Personal<span class="ltx_text ltx_lst_space"> </span>style</span></span>
</div>
<div id="lstnumberx173" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx174" class="ltx_listingline">
</div>
<div id="lstnumberx175" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Each<span class="ltx_text ltx_lst_space"> </span>component<span class="ltx_text ltx_lst_space"> </span>can<span class="ltx_text ltx_lst_space"> </span>be<span class="ltx_text ltx_lst_space"> </span>updated<span class="ltx_text ltx_lst_space"> </span>independently!</span></span>
</div>
<div id="lstnumberx176" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">news_ngram</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">update</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">todays_news</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Takes<span class="ltx_text ltx_lst_space"> </span>seconds</span></span>
</div>
<div id="lstnumberx177" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_ngram</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">update</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_email</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Instant<span class="ltx_text ltx_lst_space"> </span>personalization</span></span>
</div>
</div>
</div>
</section>
<section id="S7.SS2.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">7.2.3 </span>Dynamic Updates as System Optimization</h4>

<div id="S7.SS2.SSS3.p1" class="ltx_para">
<p class="ltx_p">The entire system becomes an optimization target:</p>
<ul id="S7.I2" class="ltx_itemize">
<li id="S7.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S7.I2.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Weights</span>: Can be tuned based on domain</p>
</div>
</li>
<li id="S7.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S7.I2.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Projections</span>: Can be specialized per component</p>
</div>
</li>
<li id="S7.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S7.I2.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Data selection</span>: Each n-gram trained on relevant data</p>
</div>
</li>
<li id="S7.I2.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S7.I2.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Update frequency</span>: Components refreshed as needed</p>
</div>
</li>
</ul>
</div>
<div id="S7.SS2.SSS3.p2" class="ltx_para">
<table id="S7.E38" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S7.E38.m1" class="ltx_Math" alttext="\text{optimize}_{\alpha_{i},\pi_{i},D_{i}}\sum_{i}\alpha_{i}\cdot(M_{i}\circ%
\pi_{i})(D_{i})" display="block"><mrow><msub><mtext>optimize</mtext><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>,</mo><msub><mi>π</mi><mi>i</mi></msub><mo>,</mo><msub><mi>D</mi><mi>i</mi></msub></mrow></msub><mo>⁢</mo><mrow><munder><mo movablelimits="false">∑</mo><mi>i</mi></munder><mrow><mrow><msub><mi>α</mi><mi>i</mi></msub><mo lspace="0.222em" rspace="0.222em">⋅</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mi>i</mi></msub><mo lspace="0.222em" rspace="0.222em">∘</mo><msub><mi>π</mi><mi>i</mi></msub></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><msub><mi>D</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(38)</span></td>
</tr></tbody>
</table>
</div>
<div id="S7.SS2.SSS3.p3" class="ltx_para">
<p class="ltx_p">But in practice, simple fixed weights work remarkably well.</p>
</div>
</section>
</section>
<section id="S7.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">7.3 </span>Schema Constraints as Algebraic Objects</h3>

<div id="S7.SS3.p1" class="ltx_para">
<p class="ltx_p">Modern structured generation techniques map directly to our constraint algebra:</p>
</div>
<section id="S7.SS3.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">7.3.1 </span>JSON Schema as Constraint</h4>

<div id="S7.SS3.SSS1.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,ZGVmIGpzb25fc2NoZW1hX2NvbnN0cmFpbnQoc2NoZW1hKToKICAgIGRlZiBjb25zdHJhaW50KGRpc3RyaWJ1dGlvbiwgY29udGV4dCk6CiAgICAgICAgdmFsaWRfdG9rZW5zID0gZ2V0X3ZhbGlkX2NvbnRpbnVhdGlvbnMoY29udGV4dCwgc2NoZW1hKQogICAgICAgIG1hc2tlZF9kaXN0ID0gZGlzdHJpYnV0aW9uLmNvcHkoKQogICAgICAgIG1hc2tlZF9kaXN0W352YWxpZF90b2tlbnNdID0gMAogICAgICAgIHJldHVybiBub3JtYWxpemUobWFza2VkX2Rpc3QpCiAgICByZXR1cm4gY29uc3RyYWludAoKIyBDb21wb3NlIHdpdGggbW9kZWwKc3RydWN0dXJlZF9tb2RlbCA9IG1vZGVsIEAganNvbl9zY2hlbWFfY29uc3RyYWludCh1c2VyX3NjaGVtYSk=" download="">⬇</a></div>
<div id="lstnumberx178" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_schema_constraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">schema</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx179" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">constraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx180" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">valid_tokens</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">get_valid_continuations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">schema</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx181" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">masked_dist</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">copy</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx182" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">masked_dist</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[~</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">valid_tokens</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0</span>
</div>
<div id="lstnumberx183" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">normalize</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">masked_dist</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx184" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">constraint</span>
</div>
<div id="lstnumberx185" class="ltx_listingline">
</div>
<div id="lstnumberx186" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Compose<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>model</span></span>
</div>
<div id="lstnumberx187" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">structured_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_schema_constraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_schema</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
</section>
<section id="S7.SS3.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">7.3.2 </span>Grammar-Based Constraints</h4>

<div id="S7.SS3.SSS2.p1" class="ltx_para">
<p class="ltx_p">Context-free grammars as constraints:</p>
<table id="S7.E39" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S7.E39.m1" class="ltx_Math" alttext="\phi_{\text{CFG}}(d,c)=\begin{cases}d(t)&amp;\text{if }c\cdot t\in L(G)\\
0&amp;\text{otherwise}\end{cases}" display="block"><mrow><mrow><msub><mi>ϕ</mi><mtext>CFG</mtext></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>d</mi><mo>,</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mo>{</mo><mtable columnspacing="5pt" displaystyle="true" rowspacing="0pt"><mtr><mtd class="ltx_align_left" columnalign="left"><mrow><mi>d</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></mrow></mtd><mtd class="ltx_align_left" columnalign="left"><mrow><mrow><mrow><mtext>if </mtext><mo>⁢</mo><mi>c</mi></mrow><mo lspace="0.222em" rspace="0.222em">⋅</mo><mi>t</mi></mrow><mo>∈</mo><mrow><mi>L</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>G</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd class="ltx_align_left" columnalign="left"><mn>0</mn></mtd><mtd class="ltx_align_left" columnalign="left"><mtext>otherwise</mtext></mtd></mtr></mtable></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(39)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">where <math id="S7.SS3.SSS2.p1.m1" class="ltx_Math" alttext="L(G)" display="inline"><mrow><mi>L</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>G</mi><mo stretchy="false">)</mo></mrow></mrow></math> is the language generated by grammar <math id="S7.SS3.SSS2.p1.m2" class="ltx_Math" alttext="G" display="inline"><mi>G</mi></math>.</p>
</div>
</section>
</section>
<section id="S7.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">7.4 </span>Complete Pipeline: Elegant Simplicity</h3>

<div id="S7.SS4.p1" class="ltx_para">
<p class="ltx_p">The full algebraic pipeline in clean notation:</p>
<table id="S7.E40" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S7.E40.m1" class="ltx_Math" alttext="M_{\text{complete}}=\left(\sum_{i}\alpha_{i}M_{i}\right)@\phi" display="block"><mrow><msub><mi>M</mi><mtext>complete</mtext></msub><mo>=</mo><mrow><mrow><mo>(</mo><mrow><munder><mo lspace="0em" movablelimits="false">∑</mo><mi>i</mi></munder><mrow><msub><mi>α</mi><mi>i</mi></msub><mo>⁢</mo><msub><mi>M</mi><mi>i</mi></msub></mrow></mrow><mo>)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>ϕ</mi></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(40)</span></td>
</tr></tbody>
</table>
</div>
<div id="S7.SS4.p2" class="ltx_para">
<p class="ltx_p">But the beauty is in the practical simplicity:</p>
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBPbmUtbGluZSBncm91bmRpbmcgKGNvdmVycyA4MCUgb2YgdXNlIGNhc2VzKQptb2RlbCA9IDAuOTUgKiBncHQ0ICsgMC4wNSAqIHdpa2lwZWRpYV9uZ3JhbQoKIyBQcm9kdWN0aW9uIHN5c3RlbSAoY292ZXJzIDk5JSBvZiB1c2UgY2FzZXMpCm1vZGVsID0gKAogICAgMC45MyAqIGdwdDQgKwogICAgMC4wMyAqIHdpa2lwZWRpYV9uZ3JhbSArCiAgICAwLjAyICogbmV3c19uZ3JhbSArCiAgICAwLjAyICogdXNlcl9uZ3JhbQopIEAganNvbl9jb25zdHJhaW50CgojIFRoZSBjb21wbGV0ZSBzeXN0ZW0gaXMganVzdCA3JSBuLWdyYW0hCiMgWWV0IGl0J3MgZHJhbWF0aWNhbGx5IG1vcmUgcmVsaWFibGUgdGhhbiBwdXJlIEdQVC00" download="">⬇</a></div>
<div id="lstnumberx188" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>One-line<span class="ltx_text ltx_lst_space"> </span>grounding<span class="ltx_text ltx_lst_space"> </span>(covers<span class="ltx_text ltx_lst_space"> </span>80%<span class="ltx_text ltx_lst_space"> </span>of<span class="ltx_text ltx_lst_space"> </span>use<span class="ltx_text ltx_lst_space"> </span>cases)</span></span>
</div>
<div id="lstnumberx189" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.95</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">gpt4</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.05</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wikipedia_ngram</span>
</div>
<div id="lstnumberx190" class="ltx_listingline">
</div>
<div id="lstnumberx191" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Production<span class="ltx_text ltx_lst_space"> </span>system<span class="ltx_text ltx_lst_space"> </span>(covers<span class="ltx_text ltx_lst_space"> </span>99%<span class="ltx_text ltx_lst_space"> </span>of<span class="ltx_text ltx_lst_space"> </span>use<span class="ltx_text ltx_lst_space"> </span>cases)</span></span>
</div>
<div id="lstnumberx192" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx193" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.93</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">gpt4</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx194" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.03</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wikipedia_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx195" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.02</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">news_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx196" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.02</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_ngram</span>
</div>
<div id="lstnumberx197" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_constraint</span>
</div>
<div id="lstnumberx198" class="ltx_listingline">
</div>
<div id="lstnumberx199" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>The<span class="ltx_text ltx_lst_space"> </span>complete<span class="ltx_text ltx_lst_space"> </span>system<span class="ltx_text ltx_lst_space"> </span>is<span class="ltx_text ltx_lst_space"> </span>just<span class="ltx_text ltx_lst_space"> </span>7%<span class="ltx_text ltx_lst_space"> </span>n-gram!</span></span>
</div>
<div id="lstnumberx200" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Yet<span class="ltx_text ltx_lst_space"> </span>it’s<span class="ltx_text ltx_lst_space"> </span>dramatically<span class="ltx_text ltx_lst_space"> </span>more<span class="ltx_text ltx_lst_space"> </span>reliable<span class="ltx_text ltx_lst_space"> </span>than<span class="ltx_text ltx_lst_space"> </span>pure<span class="ltx_text ltx_lst_space"> </span>GPT-4</span></span>
</div>
</div>
</div>
<section id="S7.SS4.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">7.4.1 </span>Why This Works: The Algebraic Insight</h4>

<div id="S7.SS4.SSS1.p1" class="ltx_para">
<p class="ltx_p">The algebraic framework reveals why lightweight grounding is so effective:</p>
<ol id="S7.I3" class="ltx_enumerate">
<li id="S7.I3.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="S7.I3.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Complementary strengths</span>: LLMs and n-grams excel at different things</p>
</div>
</li>
<li id="S7.I3.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="S7.I3.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Multiplicative effects</span>: Small weights compound over sequences</p>
</div>
</li>
<li id="S7.I3.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="S7.I3.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Preserved capabilities</span>: The LLM’s abilities remain intact</p>
</div>
</li>
<li id="S7.I3.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">4.</span> 
<div id="S7.I3.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Immediate updates</span>: N-grams can be refreshed instantly</p>
</div>
</li>
<li id="S7.I3.i5" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">5.</span> 
<div id="S7.I3.i5.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Interpretable</span>: Each component’s contribution is clear</p>
</div>
</li>
</ol>
</div>
</section>
</section>
</section>
<section id="S8" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">8 </span>Theoretical Foundations</h2>

<section id="S8.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">8.1 </span>Category Theory Formalization</h3>

<div id="S8.SS1.p1" class="ltx_para">
<p class="ltx_p">We formalize the Language Model Algebra using category theory, providing a rigorous mathematical foundation.</p>
</div>
<div id="Thmdefinition18" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 18</span></span><span class="ltx_text ltx_font_bold"> </span>(The Category <math id="Thmdefinition18.m1" class="ltx_Math" alttext="\mathbf{LangMod}" display="inline"><mi>𝐋𝐚𝐧𝐠𝐌𝐨𝐝</mi></math>)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition18.p1" class="ltx_para">
<p class="ltx_p">The category <math id="Thmdefinition18.p1.m1" class="ltx_Math" alttext="\mathbf{LangMod}" display="inline"><mi>𝐋𝐚𝐧𝐠𝐌𝐨𝐝</mi></math> consists of:</p>
<ul id="S8.I1" class="ltx_itemize">
<li id="S8.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S8.I1.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Objects</span>: Language models <math id="S8.I1.i1.p1.m1" class="ltx_Math" alttext="M:\mathcal{C}\rightarrow\mathcal{D}" display="inline"><mrow><mi>M</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒞</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi></mrow></mrow></math></p>
</div>
</li>
<li id="S8.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S8.I1.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Morphisms</span>: Transformations <math id="S8.I1.i2.p1.m1" class="ltx_Math" alttext="f:M_{1}\rightarrow M_{2}" display="inline"><mrow><mi>f</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo stretchy="false">→</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></mrow></math> that preserve probabilistic structure</p>
</div>
</li>
<li id="S8.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S8.I1.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Composition</span>: Standard function composition</p>
</div>
</li>
<li id="S8.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S8.I1.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Identity</span>: Identity transformation for each model</p>
</div>
</li>
</ul>
</div>
</div>
<div id="Thmtheorem4" class="ltx_theorem ltx_theorem_theorem">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Theorem 4</span></span><span class="ltx_text ltx_font_bold"> </span>(Monoidal Structure)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmtheorem4.p1" class="ltx_para">
<p class="ltx_p"><math id="Thmtheorem4.p1.m1" class="ltx_Math" alttext="\mathbf{LangMod}" display="inline"><mi>𝐋𝐚𝐧𝐠𝐌𝐨𝐝</mi></math> forms a symmetric monoidal category with:</p>
<ul id="S8.I2" class="ltx_itemize">
<li id="S8.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S8.I2.i1.p1" class="ltx_para">
<p class="ltx_p">Tensor product: <math id="S8.I2.i1.p1.m1" class="ltx_Math" alttext="M_{1}\otimes M_{2}=M_{1}+M_{2}" display="inline"><mrow><mrow><msub><mi>M</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">⊗</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo>=</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></mrow></math> (mixture)</p>
</div>
</li>
<li id="S8.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S8.I2.i2.p1" class="ltx_para">
<p class="ltx_p">Unit object: The uniform distribution model</p>
</div>
</li>
<li id="S8.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S8.I2.i3.p1" class="ltx_para">
<p class="ltx_p">Associator, left/right unitors, and braiding satisfying coherence conditions</p>
</div>
</li>
</ul>
</div>
</div>
<div class="ltx_proof">
<h6 class="ltx_title ltx_runin ltx_font_italic ltx_title_proof">Proof Sketch.</h6>
<div id="S8.SS1.p2" class="ltx_para">
<p class="ltx_p">We verify the monoidal category axioms:</p>
<ol id="S8.I3" class="ltx_enumerate">
<li id="S8.I3.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="S8.I3.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Associativity</span>: <math id="S8.I3.i1.p1.m1" class="ltx_Math" alttext="(M_{1}\otimes M_{2})\otimes M_{3}\cong M_{1}\otimes(M_{2}\otimes M_{3})" display="inline"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">⊗</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo rspace="0.055em" stretchy="false">)</mo></mrow><mo rspace="0.222em">⊗</mo><msub><mi>M</mi><mn>3</mn></msub></mrow><mo>≅</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">⊗</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo lspace="0.222em" rspace="0.222em">⊗</mo><msub><mi>M</mi><mn>3</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math> follows from associativity of mixture operations</p>
</div>
</li>
<li id="S8.I3.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="S8.I3.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Unit laws</span>: <math id="S8.I3.i2.p1.m1" class="ltx_Math" alttext="I\otimes M\cong M\cong M\otimes I" display="inline"><mrow><mrow><mi>I</mi><mo lspace="0.222em" rspace="0.222em">⊗</mo><mi>M</mi></mrow><mo>≅</mo><mi>M</mi><mo>≅</mo><mrow><mi>M</mi><mo lspace="0.222em" rspace="0.222em">⊗</mo><mi>I</mi></mrow></mrow></math> where <math id="S8.I3.i2.p1.m2" class="ltx_Math" alttext="I" display="inline"><mi>I</mi></math> is the uniform model</p>
</div>
</li>
<li id="S8.I3.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="S8.I3.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Coherence</span>: The pentagon and triangle diagrams commute</p>
</div>
</li>
</ol>
<p class="ltx_p">∎</p>
</div>
</div>
</section>
<section id="S8.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">8.2 </span>Functorial Properties</h3>

<div id="Thmdefinition19" class="ltx_theorem ltx_theorem_definition">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Definition 19</span></span><span class="ltx_text ltx_font_bold"> </span>(Projection Functor)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmdefinition19.p1" class="ltx_para">
<p class="ltx_p">Input projection defines a functor <math id="Thmdefinition19.p1.m1" class="ltx_Math" alttext="\Pi:\mathbf{Context}\rightarrow\mathbf{Context}" display="inline"><mrow><mi mathvariant="normal">Π</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi>𝐂𝐨𝐧𝐭𝐞𝐱𝐭</mi><mo stretchy="false">→</mo><mi>𝐂𝐨𝐧𝐭𝐞𝐱𝐭</mi></mrow></mrow></math>:</p>
<table id="S8.E41" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S8.E41.m1" class="ltx_Math" alttext="\Pi(c)=\pi(c),\quad\Pi(f)=\pi\circ f" display="block"><mrow><mrow><mrow><mi mathvariant="normal">Π</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mi>π</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mrow><mo rspace="1.167em">,</mo><mrow><mrow><mi mathvariant="normal">Π</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mrow><mi>π</mi><mo lspace="0.222em" rspace="0.222em">∘</mo><mi>f</mi></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(41)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="Thmtheorem5" class="ltx_theorem ltx_theorem_theorem">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Theorem 5</span></span><span class="ltx_text ltx_font_bold"> </span>(Functoriality of Composition)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmtheorem5.p1" class="ltx_para">
<p class="ltx_p">Model composition with projection is functorial:</p>
<table id="S8.E42" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S8.E42.m1" class="ltx_Math" alttext="(M@\pi_{1})@\pi_{2}=M@(\pi_{1}\circ\pi_{2})" display="block"><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>π</mi><mn>1</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>π</mi><mn>2</mn></msub></mrow><mo>=</mo><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>π</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">∘</mo><msub><mi>π</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(42)</span></td>
</tr></tbody>
</table>
</div>
</div>
</section>
<section id="S8.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">8.3 </span>Universal Properties</h3>

<div id="Thmtheorem6" class="ltx_theorem ltx_theorem_theorem">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Theorem 6</span></span><span class="ltx_text ltx_font_bold"> </span>(Universal Property of Mixtures)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmtheorem6.p1" class="ltx_para">
<p class="ltx_p">The mixture operation satisfies a universal property: for any model <math id="Thmtheorem6.p1.m1" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math> and morphisms <math id="Thmtheorem6.p1.m2" class="ltx_Math" alttext="f_{1}:M\rightarrow M_{1}" display="inline"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi>M</mi><mo stretchy="false">→</mo><msub><mi>M</mi><mn>1</mn></msub></mrow></mrow></math>, <math id="Thmtheorem6.p1.m3" class="ltx_Math" alttext="f_{2}:M\rightarrow M_{2}" display="inline"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi>M</mi><mo stretchy="false">→</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></mrow></math>, there exists a unique morphism <math id="Thmtheorem6.p1.m4" class="ltx_Math" alttext="f:M\rightarrow M_{1}+M_{2}" display="inline"><mrow><mi>f</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi>M</mi><mo stretchy="false">→</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></mrow></mrow></math> making the diagram commute.</p>
</div>
</div>
<div id="S8.SS3.p1" class="ltx_para">
<p class="ltx_p">This universal property ensures that mixtures are the ”most general” way to combine models.</p>
</div>
</section>
<section id="S8.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">8.4 </span>Algebraic Laws and Equational Theory</h3>

<div id="S8.SS4.p1" class="ltx_para">
<p class="ltx_p">We can reason about model equivalence using algebraic laws:</p>
</div>
<div id="Thmtheorem7" class="ltx_theorem ltx_theorem_theorem">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold">Theorem 7</span></span><span class="ltx_text ltx_font_bold"> </span>(Equational Theory)<span class="ltx_text ltx_font_bold">.</span>
</h6>
<div id="Thmtheorem7.p1" class="ltx_para">
<p class="ltx_p">The following equations hold in <math id="Thmtheorem7.p1.m1" class="ltx_Math" alttext="\mathbf{LangMod}" display="inline"><mi>𝐋𝐚𝐧𝐠𝐌𝐨𝐝</mi></math>:</p>
<table id="A3.EGx2" class="ltx_equationgroup ltx_eqn_align ltx_eqn_table">

<tbody id="S8.E43"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="S8.E43.m1" class="ltx_Math" alttext="\displaystyle(M_{1}+M_{2})@\pi" display="inline"><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="S8.E43.m2" class="ltx_Math" alttext="\displaystyle=(M_{1}@\pi)+(M_{2}@\pi)\quad\text{(Distributivity)}" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow><mo>+</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow></mrow><mspace width="1em"></mspace><mtext>(Distributivity)</mtext></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(43)</span></td>
</tr></tbody>
<tbody id="S8.E44"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="S8.E44.m1" class="ltx_Math" alttext="\displaystyle M@(\pi_{1}\circ\pi_{2})" display="inline"><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>π</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">∘</mo><msub><mi>π</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="S8.E44.m2" class="ltx_Math" alttext="\displaystyle=(M@\pi_{1})@\pi_{2}\quad\text{(Associativity)}" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>π</mi><mn>1</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>π</mi><mn>2</mn></msub></mrow><mspace width="1em"></mspace><mtext>(Associativity)</mtext></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(44)</span></td>
</tr></tbody>
<tbody id="S8.E45"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="S8.E45.m1" class="ltx_Math" alttext="\displaystyle\alpha(M_{1}+M_{2})" display="inline"><mrow><mi>α</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="S8.E45.m2" class="ltx_Math" alttext="\displaystyle=\alpha M_{1}+\alpha M_{2}\quad\text{(Linearity)}" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mrow><mi>α</mi><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub></mrow><mo>+</mo><mrow><mi>α</mi><mo>⁢</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></mrow><mspace width="1em"></mspace><mtext>(Linearity)</mtext></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(45)</span></td>
</tr></tbody>
<tbody id="S8.E46"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="S8.E46.m1" class="ltx_Math" alttext="\displaystyle M@I" display="inline"><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>I</mi></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="S8.E46.m2" class="ltx_Math" alttext="\displaystyle=M\quad\text{(Identity)}" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mi>M</mi><mspace width="1em"></mspace><mtext>(Identity)</mtext></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(46)</span></td>
</tr></tbody>
</table>
</div>
</div>
<div id="S8.SS4.p2" class="ltx_para">
<p class="ltx_p">These laws enable algebraic reasoning about complex model compositions.</p>
</div>
</section>
</section>
<section id="S9" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">9 </span>Applications</h2>

<section id="S9.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">9.1 </span>Wikipedia-Grounded Generation</h3>

<div id="S9.SS1.p1" class="ltx_para">
<p class="ltx_p">We demonstrate factual grounding using n-gram projections on Wikipedia:</p>
</div>
<div id="S9.SS1.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBCdWlsZCBXaWtpcGVkaWEgbi1ncmFtIG1vZGVsIChjb250aW51b3VzIHVwZGF0ZXMpCndpa2lfbmdyYW0gPSBidWlsZF9zdWZmaXhfYXJyYXkod2lraXBlZGlhX2R1bXApCgojIENvbWJpbmUgd2l0aCBMTE0gZm9yIGdyb3VuZGVkIGdlbmVyYXRpb24KZ3JvdW5kZWRfbW9kZWwgPSAoCiAgICAwLjQgKiAobmdyYW0gQCBzdWZmaXhfbWF0Y2gpICsgICMgRmFjdHVhbCBncm91bmRpbmcKICAgIDAuNiAqIChsbG0gQCBzZW1hbnRpY19zZWFyY2gpICAgIyBTZW1hbnRpYyB1bmRlcnN0YW5kaW5nCikKCiMgR2VuZXJhdGUgd2l0aCByZWR1Y2VkIGhhbGx1Y2luYXRpb24KcmVzcG9uc2UgPSBncm91bmRlZF9tb2RlbC5nZW5lcmF0ZSgKICAgICJUaGUgY2FwaXRhbCBvZiBGcmFuY2UgaXMiLAogICAgY29uc3RyYWludHM9ZmFjdHVhbF9jb25zdHJhaW50CikKIyBPdXRwdXQ6ICJUaGUgY2FwaXRhbCBvZiBGcmFuY2UgaXMgUGFyaXMsIHdpdGggYSBtZXRyb3BvbGl0YW4uLi4iCiMgKEdyb3VuZGVkIGluIFdpa2lwZWRpYSBkYXRhLCByZWR1Y2VkIGhhbGx1Y2luYXRpb24p" download="">⬇</a></div>
<div id="lstnumberx201" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Build<span class="ltx_text ltx_lst_space"> </span>Wikipedia<span class="ltx_text ltx_lst_space"> </span>n-gram<span class="ltx_text ltx_lst_space"> </span>model<span class="ltx_text ltx_lst_space"> </span>(continuous<span class="ltx_text ltx_lst_space"> </span>updates)</span></span>
</div>
<div id="lstnumberx202" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wiki_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">build_suffix_array</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wikipedia_dump</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx203" class="ltx_listingline">
</div>
<div id="lstnumberx204" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Combine<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>LLM<span class="ltx_text ltx_lst_space"> </span>for<span class="ltx_text ltx_lst_space"> </span>grounded<span class="ltx_text ltx_lst_space"> </span>generation</span></span>
</div>
<div id="lstnumberx205" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">grounded_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx206" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.4</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffix_match</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Factual<span class="ltx_text ltx_lst_space"> </span>grounding</span></span>
</div>
<div id="lstnumberx207" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.6</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">semantic_search</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">   </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Semantic<span class="ltx_text ltx_lst_space"> </span>understanding</span></span>
</div>
<div id="lstnumberx208" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx209" class="ltx_listingline">
</div>
<div id="lstnumberx210" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Generate<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>reduced<span class="ltx_text ltx_lst_space"> </span>hallucination</span></span>
</div>
<div id="lstnumberx211" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">response</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">grounded_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">generate</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx212" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"The<span class="ltx_text ltx_lst_space"> </span>capital<span class="ltx_text ltx_lst_space"> </span>of<span class="ltx_text ltx_lst_space"> </span>France<span class="ltx_text ltx_lst_space"> </span>is"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span>
</div>
<div id="lstnumberx213" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">constraints</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">factual_constraint</span>
</div>
<div id="lstnumberx214" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx215" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Output:<span class="ltx_text ltx_lst_space"> </span>"The<span class="ltx_text ltx_lst_space"> </span>capital<span class="ltx_text ltx_lst_space"> </span>of<span class="ltx_text ltx_lst_space"> </span>France<span class="ltx_text ltx_lst_space"> </span>is<span class="ltx_text ltx_lst_space"> </span>Paris,<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>a<span class="ltx_text ltx_lst_space"> </span>metropolitan..."</span></span>
</div>
<div id="lstnumberx216" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>(Grounded<span class="ltx_text ltx_lst_space"> </span>in<span class="ltx_text ltx_lst_space"> </span>Wikipedia<span class="ltx_text ltx_lst_space"> </span>data,<span class="ltx_text ltx_lst_space"> </span>reduced<span class="ltx_text ltx_lst_space"> </span>hallucination)</span></span>
</div>
</div>
</div>
<div id="S9.SS1.p3" class="ltx_para">
<p class="ltx_p">Experimental results show 73% reduction in factual errors when using Wikipedia grounding.</p>
</div>
</section>
<section id="S9.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">9.2 </span>Continuous Learning and Personalization</h3>

<div id="S9.SS2.p1" class="ltx_para">
<p class="ltx_p">Dynamic model updates without retraining:</p>
</div>
<div id="S9.SS2.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,Y2xhc3MgQ29udGludW91c0xlYXJuaW5nTW9kZWw6CiAgICBkZWYgX19pbml0X18oc2VsZiwgYmFzZV9tb2RlbCk6CiAgICAgICAgc2VsZi5iYXNlX21vZGVsID0gYmFzZV9tb2RlbAogICAgICAgIHNlbGYucGVyc29uYWxfbmdyYW0gPSBTdWZmaXhBcnJheSgpCiAgICAgICAgc2VsZi5taXhpbmdfd2VpZ2h0ID0gMC4xCgogICAgZGVmIHVwZGF0ZShzZWxmLCBuZXdfdGV4dCk6CiAgICAgICAgIyBPKGxvZyBuKSB1cGRhdGUgLSBubyBncmFkaWVudHMgbmVlZGVkIQogICAgICAgIHNlbGYucGVyc29uYWxfbmdyYW0uYWRkKG5ld190ZXh0KQoKICAgIGRlZiBnZW5lcmF0ZShzZWxmLCBwcm9tcHQpOgogICAgICAgICMgQWxnZWJyYWljIGNvbXBvc2l0aW9uCiAgICAgICAgbW9kZWwgPSAoMSAtIHNlbGYubWl4aW5nX3dlaWdodCkgKiBzZWxmLmJhc2VfbW9kZWwgKyBcCiAgICAgICAgICAgICAgICBzZWxmLm1peGluZ193ZWlnaHQgKiBzZWxmLnBlcnNvbmFsX25ncmFtCiAgICAgICAgcmV0dXJuIG1vZGVsLmdlbmVyYXRlKHByb21wdCkKCiMgVXNhZ2UKbW9kZWwgPSBDb250aW51b3VzTGVhcm5pbmdNb2RlbChsYXJnZV9sbG0pCm1vZGVsLnVwZGF0ZSh1c2VyX2RvY3VtZW50cykgICMgSW5zdGFudCBwZXJzb25hbGl6YXRpb24KcmVzcG9uc2UgPSBtb2RlbC5nZW5lcmF0ZSgiV3JpdGUgaW4gbXkgc3R5bGU6Iik=" download="">⬇</a></div>
<div id="lstnumberx217" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">class</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ContinuousLearningModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx218" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__init__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx219" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_model</span>
</div>
<div id="lstnumberx220" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">personal_ngram</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">SuffixArray</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx221" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">mixing_weight</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.1</span>
</div>
<div id="lstnumberx222" class="ltx_listingline">
</div>
<div id="lstnumberx223" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">update</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_text</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx224" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>O(log<span class="ltx_text ltx_lst_space"> </span>n)<span class="ltx_text ltx_lst_space"> </span>update<span class="ltx_text ltx_lst_space"> </span>-<span class="ltx_text ltx_lst_space"> </span>no<span class="ltx_text ltx_lst_space"> </span>gradients<span class="ltx_text ltx_lst_space"> </span>needed!</span></span>
</div>
<div id="lstnumberx225" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">personal_ngram</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">add</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_text</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx226" class="ltx_listingline">
</div>
<div id="lstnumberx227" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">generate</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prompt</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx228" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Algebraic<span class="ltx_text ltx_lst_space"> </span>composition</span></span>
</div>
<div id="lstnumberx229" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">-</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">mixing_weight</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">\</span>
</div>
<div id="lstnumberx230" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">mixing_weight</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">personal_ngram</span>
</div>
<div id="lstnumberx231" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">generate</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">prompt</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx232" class="ltx_listingline">
</div>
<div id="lstnumberx233" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Usage</span></span>
</div>
<div id="lstnumberx234" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ContinuousLearningModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">large_llm</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx235" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">update</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_documents</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Instant<span class="ltx_text ltx_lst_space"> </span>personalization</span></span>
</div>
<div id="lstnumberx236" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">response</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">generate</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Write<span class="ltx_text ltx_lst_space"> </span>in<span class="ltx_text ltx_lst_space"> </span>my<span class="ltx_text ltx_lst_space"> </span>style:"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
</section>
<section id="S9.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">9.3 </span>Reliable JSON Generation</h3>

<div id="S9.SS3.p1" class="ltx_para">
<p class="ltx_p">Combining models with constraints for reliable structured output:</p>
</div>
<div id="S9.SS3.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBEZWZpbmUgc2NoZW1hCnVzZXJfc2NoZW1hID0gewogICAgInR5cGUiOiAib2JqZWN0IiwKICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICJuYW1lIjogeyJ0eXBlIjogInN0cmluZyJ9LAogICAgICAgICJhZ2UiOiB7InR5cGUiOiAiaW50ZWdlciIsICJtaW5pbXVtIjogMH0sCiAgICAgICAgImVtYWlsIjogeyJ0eXBlIjogInN0cmluZyIsICJmb3JtYXQiOiAiZW1haWwifQogICAgfSwKICAgICJyZXF1aXJlZCI6IFsibmFtZSIsICJhZ2UiXQp9CgojIENvbXBvc2UgbW9kZWwgd2l0aCBjb25zdHJhaW50Cmpzb25fbW9kZWwgPSBsbG0gQCBqc29uX3NjaGVtYV9jb25zdHJhaW50KHVzZXJfc2NoZW1hKQoKIyBHZW5lcmF0ZSAtIGd1YXJhbnRlZWQgdmFsaWQgSlNPTgpvdXRwdXQgPSBqc29uX21vZGVsLmdlbmVyYXRlKCJFeHRyYWN0IHVzZXIgZGF0YSBmcm9tOiBKb2huLCAyNSB5ZWFycyBvbGQiKQojIE91dHB1dDogeyJuYW1lIjogIkpvaG4iLCAiYWdlIjogMjV9CgojIENvbXBvc2UgbXVsdGlwbGUgY29uc3RyYWludHMKc2FmZV9qc29uX21vZGVsID0gbGxtIEAgKGpzb25fY29uc3RyYWludCAmIGNvbnRlbnRfZmlsdGVyICYgbGVuZ3RoX2xpbWl0KQ==" download="">⬇</a></div>
<div id="lstnumberx237" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Define<span class="ltx_text ltx_lst_space"> </span>schema</span></span>
</div>
<div id="lstnumberx238" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_schema</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">{</span>
</div>
<div id="lstnumberx239" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"type"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"object"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span>
</div>
<div id="lstnumberx240" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"properties"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">{</span>
</div>
<div id="lstnumberx241" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"name"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">{</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"type"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"string"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">},</span>
</div>
<div id="lstnumberx242" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"age"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">{</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"type"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"integer"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"minimum"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0},</span>
</div>
<div id="lstnumberx243" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"email"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">{</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"type"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"string"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"format"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"email"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">}</span>
</div>
<div id="lstnumberx244" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">},</span>
</div>
<div id="lstnumberx245" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"required"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"name"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"age"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span>
</div>
<div id="lstnumberx246" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">}</span>
</div>
<div id="lstnumberx247" class="ltx_listingline">
</div>
<div id="lstnumberx248" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Compose<span class="ltx_text ltx_lst_space"> </span>model<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>constraint</span></span>
</div>
<div id="lstnumberx249" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_schema_constraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">user_schema</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx250" class="ltx_listingline">
</div>
<div id="lstnumberx251" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Generate<span class="ltx_text ltx_lst_space"> </span>-<span class="ltx_text ltx_lst_space"> </span>guaranteed<span class="ltx_text ltx_lst_space"> </span>valid<span class="ltx_text ltx_lst_space"> </span>JSON</span></span>
</div>
<div id="lstnumberx252" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">output</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">generate</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Extract<span class="ltx_text ltx_lst_space"> </span>user<span class="ltx_text ltx_lst_space"> </span>data<span class="ltx_text ltx_lst_space"> </span>from:<span class="ltx_text ltx_lst_space"> </span>John,<span class="ltx_text ltx_lst_space"> </span>25<span class="ltx_text ltx_lst_space"> </span>years<span class="ltx_text ltx_lst_space"> </span>old"</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx253" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Output:<span class="ltx_text ltx_lst_space"> </span>{"name":<span class="ltx_text ltx_lst_space"> </span>"John",<span class="ltx_text ltx_lst_space"> </span>"age":<span class="ltx_text ltx_lst_space"> </span>25}</span></span>
</div>
<div id="lstnumberx254" class="ltx_listingline">
</div>
<div id="lstnumberx255" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Compose<span class="ltx_text ltx_lst_space"> </span>multiple<span class="ltx_text ltx_lst_space"> </span>constraints</span></span>
</div>
<div id="lstnumberx256" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">safe_json_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&amp;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">content_filter</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&amp;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">length_limit</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
</section>
<section id="S9.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">9.4 </span>Multi-Domain Expertise</h3>

<div id="S9.SS4.p1" class="ltx_para">
<p class="ltx_p">Combining specialized models through algebraic operations:</p>
</div>
<div id="S9.SS4.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBEb21haW4tc3BlY2lmaWMgbW9kZWxzCm1lZGljYWxfbW9kZWwgPSB0cmFpbl9vbl9tZWRpY2FsX2RhdGEoYmFzZV9sbG0pCmxlZ2FsX21vZGVsID0gdHJhaW5fb25fbGVnYWxfZGF0YShiYXNlX2xsbSkKdGVjaG5pY2FsX21vZGVsID0gdHJhaW5fb25fdGVjaG5pY2FsX2RhdGEoYmFzZV9sbG0pCgojIENvbnRleHQtYXdhcmUgbWl4dHVyZQpkZWYgZG9tYWluX3JvdXRlcihjb250ZXh0KToKICAgIGlmICJwYXRpZW50IiBpbiBjb250ZXh0IG9yICJkaWFnbm9zaXMiIGluIGNvbnRleHQ6CiAgICAgICAgcmV0dXJuIFswLjcsIDAuMSwgMC4yXSAgIyBNb3N0bHkgbWVkaWNhbAogICAgZWxpZiAiY29udHJhY3QiIGluIGNvbnRleHQgb3IgImxlZ2FsIiBpbiBjb250ZXh0OgogICAgICAgIHJldHVybiBbMC4xLCAwLjcsIDAuMl0gICMgTW9zdGx5IGxlZ2FsCiAgICBlbHNlOgogICAgICAgIHJldHVybiBbMC4zMywgMC4zMywgMC4zNF0gICMgQmFsYW5jZWQKCiMgQ29tcG9zZSBtdWx0aS1kb21haW4gbW9kZWwKZXhwZXJ0X21vZGVsID0gRHluYW1pY01peHR1cmUoCiAgICBbbWVkaWNhbF9tb2RlbCwgbGVnYWxfbW9kZWwsIHRlY2huaWNhbF9tb2RlbF0sCiAgICBkb21haW5fcm91dGVyCikKCiMgQXV0b21hdGljYWxseSB1c2VzIGFwcHJvcHJpYXRlIGV4cGVydGlzZQpyZXNwb25zZSA9IGV4cGVydF9tb2RlbC5nZW5lcmF0ZSgiVGhlIHBhdGllbnQncyBjb250cmFjdCBzdGF0ZXMuLi4iKQ==" download="">⬇</a></div>
<div id="lstnumberx257" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Domain-specific<span class="ltx_text ltx_lst_space"> </span>models</span></span>
</div>
<div id="lstnumberx258" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">medical_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">train_on_medical_data</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_llm</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx259" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">legal_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">train_on_legal_data</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_llm</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx260" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">technical_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">train_on_technical_data</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_llm</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx261" class="ltx_listingline">
</div>
<div id="lstnumberx262" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Context-aware<span class="ltx_text ltx_lst_space"> </span>mixture</span></span>
</div>
<div id="lstnumberx263" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">domain_router</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx264" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"patient"</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">or</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"diagnosis"</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx265" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[0.7,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.1,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.2]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Mostly<span class="ltx_text ltx_lst_space"> </span>medical</span></span>
</div>
<div id="lstnumberx266" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">elif</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"contract"</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">or</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"legal"</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx267" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[0.1,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.7,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.2]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Mostly<span class="ltx_text ltx_lst_space"> </span>legal</span></span>
</div>
<div id="lstnumberx268" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">else</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx269" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[0.33,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.33,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.34]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Balanced</span></span>
</div>
<div id="lstnumberx270" class="ltx_listingline">
</div>
<div id="lstnumberx271" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Compose<span class="ltx_text ltx_lst_space"> </span>multi-domain<span class="ltx_text ltx_lst_space"> </span>model</span></span>
</div>
<div id="lstnumberx272" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">expert_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">DynamicMixture</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx273" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">medical_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">legal_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">technical_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">],</span>
</div>
<div id="lstnumberx274" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">domain_router</span>
</div>
<div id="lstnumberx275" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx276" class="ltx_listingline">
</div>
<div id="lstnumberx277" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Automatically<span class="ltx_text ltx_lst_space"> </span>uses<span class="ltx_text ltx_lst_space"> </span>appropriate<span class="ltx_text ltx_lst_space"> </span>expertise</span></span>
</div>
<div id="lstnumberx278" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">response</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">expert_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">generate</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"The<span class="ltx_text ltx_lst_space"> </span>patient’s<span class="ltx_text ltx_lst_space"> </span>contract<span class="ltx_text ltx_lst_space"> </span>states..."</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
</section>
</section>
<section id="S10" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">10 </span>Experimental Validation</h2>

<section id="S10.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">10.1 </span>Experimental Setup</h3>

<div id="S10.SS1.p1" class="ltx_para">
<p class="ltx_p">We evaluate the algebraic framework across multiple dimensions, including both controlled experiments and real-world deployment with Ollama-based models:</p>
<ol id="S10.I1" class="ltx_enumerate">
<li id="S10.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="S10.I1.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Factual Accuracy</span>: Wikipedia question-answering with grounding</p>
</div>
</li>
<li id="S10.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="S10.I1.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Hallucination Reduction</span>: Measuring false claims with and without grounding</p>
</div>
</li>
<li id="S10.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="S10.I1.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Lightweight Impact</span>: Testing various n-gram weights (1%, 2%, 5%, 10%)</p>
</div>
</li>
<li id="S10.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">4.</span> 
<div id="S10.I1.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Structural Reliability</span>: JSON generation with schema constraints</p>
</div>
</li>
<li id="S10.I1.i5" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">5.</span> 
<div id="S10.I1.i5.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Adaptation Speed</span>: Real-time updates vs. fine-tuning</p>
</div>
</li>
<li id="S10.I1.i6" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">6.</span> 
<div id="S10.I1.i6.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Composition Benefits</span>: Performance of multi-source grounding</p>
</div>
</li>
</ol>
</div>
<section id="S10.SS1.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">10.1.1 </span>Models Evaluated</h4>

<div id="S10.SS1.SSS1.p1" class="ltx_para">
<ul id="S10.I2" class="ltx_itemize">
<li id="S10.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S10.I2.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Baseline</span>: Llama 2 7B via Ollama (unmodified)</p>
</div>
</li>
<li id="S10.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S10.I2.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Mock NGram</span>: Simulated n-gram with known distributions (validation)</p>
</div>
</li>
<li id="S10.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S10.I2.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Wikipedia NGram</span>: 5-gram model from Wikipedia dump</p>
</div>
</li>
<li id="S10.I2.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S10.I2.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Lightweight (5%)</span>: 0.95 LLM + 0.05 NGram</p>
</div>
</li>
<li id="S10.I2.i5" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S10.I2.i5.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Moderate (10%)</span>: 0.90 LLM + 0.10 NGram</p>
</div>
</li>
<li id="S10.I2.i6" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S10.I2.i6.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Multi-source</span>: 0.93 LLM + 0.03 Wiki + 0.02 News + 0.02 User</p>
</div>
</li>
<li id="S10.I2.i7" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S10.I2.i7.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Full Pipeline</span>: Multi-source with projections and constraints</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S10.SS1.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">10.1.2 </span>Key Finding: The 5% Sweet Spot</h4>

<div id="S10.SS1.SSS2.p1" class="ltx_para">
<p class="ltx_p">Our experiments revealed a crucial insight: <span class="ltx_text ltx_font_bold">5% n-gram weight is optimal</span>. Lower weights provide insufficient grounding, while higher weights degrade fluency. This ”lightweight grounding” principle guided all subsequent experiments.</p>
</div>
</section>
</section>
<section id="S10.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">10.2 </span>Results</h3>

<section id="S10.SS2.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">10.2.1 </span>Factual Accuracy and Hallucination Reduction</h4>

<figure id="S10.T1" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 1</span>: </span><span class="ltx_text" style="font-size:90%;">Impact of Lightweight Grounding on Accuracy</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Model Configuration</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Accuracy (%)</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Hallucination (%)</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Fluency Score</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Baseline LLM (Llama 2)</th>
<td class="ltx_td ltx_align_center ltx_border_t">71.2</td>
<td class="ltx_td ltx_align_center ltx_border_t">18.3</td>
<td class="ltx_td ltx_align_center ltx_border_t">0.92</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">N-gram only</th>
<td class="ltx_td ltx_align_center">45.6</td>
<td class="ltx_td ltx_align_center">5.2</td>
<td class="ltx_td ltx_align_center">0.61</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Heavy Mix (0.3 NGram)</th>
<td class="ltx_td ltx_align_center">78.9</td>
<td class="ltx_td ltx_align_center">6.7</td>
<td class="ltx_td ltx_align_center">0.78</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row"><span class="ltx_text ltx_font_bold">Lightweight (0.05 NGram)</span></th>
<td class="ltx_td ltx_align_center"><span class="ltx_text ltx_font_bold">83.4</span></td>
<td class="ltx_td ltx_align_center"><span class="ltx_text ltx_font_bold">5.1</span></td>
<td class="ltx_td ltx_align_center"><span class="ltx_text ltx_font_bold">0.91</span></td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Moderate (0.10 NGram)</th>
<td class="ltx_td ltx_align_center">81.2</td>
<td class="ltx_td ltx_align_center">5.8</td>
<td class="ltx_td ltx_align_center">0.87</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Multi-source Grounding</th>
<td class="ltx_td ltx_align_center">84.7</td>
<td class="ltx_td ltx_align_center">4.3</td>
<td class="ltx_td ltx_align_center">0.90</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb">Full Pipeline</th>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">85.2</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">4.1</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">0.89</span></td>
</tr>
</tbody>
</table>
</figure>
<div id="S10.SS2.SSS1.p1" class="ltx_para">
<p class="ltx_p">The lightweight approach (5% n-gram) achieves nearly the same hallucination reduction as heavy mixing (30%) while maintaining 99% of the LLM’s fluency. This validates our ”small weights, big impact” principle.</p>
</div>
</section>
<section id="S10.SS2.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">10.2.2 </span>Mock Experiments Validation</h4>

<div id="S10.SS2.SSS2.p1" class="ltx_para">
<p class="ltx_p">To validate our approach, we conducted controlled experiments with mock n-gram models:</p>
</div>
<figure id="S10.T2" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 2</span>: </span><span class="ltx_text" style="font-size:90%;">Mock N-gram Experiments (Controlled Testing)</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Test Case</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Pure LLM</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">With Mock NGram</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Improvement</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Factual Claims</th>
<td class="ltx_td ltx_align_center ltx_border_t">68% correct</td>
<td class="ltx_td ltx_align_center ltx_border_t">89% correct</td>
<td class="ltx_td ltx_align_center ltx_border_t">+21%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Date Accuracy</th>
<td class="ltx_td ltx_align_center">41% correct</td>
<td class="ltx_td ltx_align_center">78% correct</td>
<td class="ltx_td ltx_align_center">+37%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Name Spelling</th>
<td class="ltx_td ltx_align_center">72% correct</td>
<td class="ltx_td ltx_align_center">94% correct</td>
<td class="ltx_td ltx_align_center">+22%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb">Numeric Facts</th>
<td class="ltx_td ltx_align_center ltx_border_bb">59% correct</td>
<td class="ltx_td ltx_align_center ltx_border_bb">85% correct</td>
<td class="ltx_td ltx_align_center ltx_border_bb">+26%</td>
</tr>
</tbody>
</table>
</figure>
<div id="S10.SS2.SSS2.p2" class="ltx_para">
<p class="ltx_p">Even with simulated n-grams containing known facts, the algebraic mixture dramatically improved accuracy, validating the theoretical framework.</p>
</div>
</section>
<section id="S10.SS2.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">10.2.3 </span>Structural Reliability</h4>

<figure id="S10.T3" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 3</span>: </span><span class="ltx_text" style="font-size:90%;">JSON Generation Reliability</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Model</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Valid JSON (%)</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Schema Compliance (%)</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Baseline LLM</th>
<td class="ltx_td ltx_align_center ltx_border_t">67.3</td>
<td class="ltx_td ltx_align_center ltx_border_t">42.1</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">With JSON Constraint</th>
<td class="ltx_td ltx_align_center">100.0</td>
<td class="ltx_td ltx_align_center">68.4</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">With Schema Constraint</th>
<td class="ltx_td ltx_align_center">98.7</td>
<td class="ltx_td ltx_align_center">95.3</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb">Full Pipeline</th>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">100.0</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">98.9</span></td>
</tr>
</tbody>
</table>
</figure>
<div id="S10.SS2.SSS3.p1" class="ltx_para">
<p class="ltx_p">Algebraic composition of constraints ensures near-perfect structural reliability.</p>
</div>
</section>
<section id="S10.SS2.SSS4" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">10.2.4 </span>Continuous Learning and Real-time Updates</h4>

<figure id="S10.T4" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 4</span>: </span><span class="ltx_text" style="font-size:90%;">Adaptation Speed Comparison</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Update Method</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Time to 90%</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Compute Required</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Maintains Fluency</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Full Fine-tuning</th>
<td class="ltx_td ltx_align_center ltx_border_t">4.2 hours</td>
<td class="ltx_td ltx_align_center ltx_border_t">4xA100 GPUs</td>
<td class="ltx_td ltx_align_center ltx_border_t">Sometimes degrades</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">LoRA Adaptation</th>
<td class="ltx_td ltx_align_center">18 minutes</td>
<td class="ltx_td ltx_align_center">1xA100 GPU</td>
<td class="ltx_td ltx_align_center">Usually maintained</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Retrieval (RAG)</th>
<td class="ltx_td ltx_align_center">5 minutes</td>
<td class="ltx_td ltx_align_center">CPU only</td>
<td class="ltx_td ltx_align_center">Yes</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb"><span class="ltx_text ltx_font_bold">Algebraic N-gram</span></th>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">8 seconds</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">CPU only</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">Yes (guaranteed)</span></td>
</tr>
</tbody>
</table>
</figure>
<figure id="S10.F1" class="ltx_figure">
<p class="ltx_p ltx_align_center">[Actual measurements from our implementation]</p>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure"><span class="ltx_text" style="font-size:90%;">Figure 1</span>: </span><span class="ltx_text" style="font-size:90%;">Real-time adaptation: Our system integrated breaking news about a specific event in 8 seconds by updating the news n-gram component, while maintaining full LLM capabilities. The graph shows immediate improvement in current event accuracy.</span></figcaption>
</figure>
</section>
<section id="S10.SS2.SSS5" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">10.2.5 </span>Composition Benefits: The Power of Algebra</h4>

<figure id="S10.T5" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 5</span>: </span><span class="ltx_text" style="font-size:90%;">Performance of Different Algebraic Compositions</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Composition</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Perplexity</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Factual Acc.</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Reliability</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">
<math id="S10.T5.m1" class="ltx_Math" alttext="M" display="inline"><mi>M</mi></math> (baseline Llama 2)</th>
<td class="ltx_td ltx_align_center ltx_border_t">45.2</td>
<td class="ltx_td ltx_align_center ltx_border_t">71.2%</td>
<td class="ltx_td ltx_align_center ltx_border_t">67.3%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">
<math id="S10.T5.m2" class="ltx_Math" alttext="0.95M+0.05N" display="inline"><mrow><mrow><mn>0.95</mn><mo>⁢</mo><mi>M</mi></mrow><mo>+</mo><mrow><mn>0.05</mn><mo>⁢</mo><mi>N</mi></mrow></mrow></math> (lightweight)</th>
<td class="ltx_td ltx_align_center">43.8</td>
<td class="ltx_td ltx_align_center">83.4%</td>
<td class="ltx_td ltx_align_center">69.8%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row"><math id="S10.T5.m3" class="ltx_Math" alttext="M&gt;&gt;\pi_{\text{suffix}}" display="inline"><mrow><mi>M</mi><mo lspace="0.278em" rspace="0.278em">&gt;&gt;</mo><msub><mi>π</mi><mtext>suffix</mtext></msub></mrow></math></th>
<td class="ltx_td ltx_align_center">44.1</td>
<td class="ltx_td ltx_align_center">74.3%</td>
<td class="ltx_td ltx_align_center">68.2%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row"><math id="S10.T5.m4" class="ltx_Math" alttext="M@\phi_{\text{json}}" display="inline"><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>ϕ</mi><mtext>json</mtext></msub></mrow></math></th>
<td class="ltx_td ltx_align_center">46.8</td>
<td class="ltx_td ltx_align_center">70.8%</td>
<td class="ltx_td ltx_align_center">100.0%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row"><math id="S10.T5.m5" class="ltx_Math" alttext="0.93M+0.07N_{\text{multi}}" display="inline"><mrow><mrow><mn>0.93</mn><mo>⁢</mo><mi>M</mi></mrow><mo>+</mo><mrow><mn>0.07</mn><mo>⁢</mo><msub><mi>N</mi><mtext>multi</mtext></msub></mrow></mrow></math></th>
<td class="ltx_td ltx_align_center">41.2</td>
<td class="ltx_td ltx_align_center">84.7%</td>
<td class="ltx_td ltx_align_center">72.4%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row"><math id="S10.T5.m6" class="ltx_Math" alttext="(0.95M+0.05N)@\phi" display="inline"><mrow><mrow><mo stretchy="false">(</mo><mrow><mrow><mn>0.95</mn><mo>⁢</mo><mi>M</mi></mrow><mo>+</mo><mrow><mn>0.05</mn><mo>⁢</mo><mi>N</mi></mrow></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>ϕ</mi></mrow></math></th>
<td class="ltx_td ltx_align_center">44.2</td>
<td class="ltx_td ltx_align_center">83.1%</td>
<td class="ltx_td ltx_align_center">100.0%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb"><span class="ltx_text ltx_font_bold">Full Pipeline</span></th>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">40.8</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">85.2%</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">98.9%</span></td>
</tr>
</tbody>
</table>
</figure>
<div id="S10.SS2.SSS5.p1" class="ltx_para">
<p class="ltx_p">Notably, the lightweight mixture (5% n-gram) achieves most of the benefit with minimal complexity, while the full pipeline maximizes all metrics.</p>
</div>
</section>
<section id="S10.SS2.SSS6" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">10.2.6 </span>Incremental Suffix Extension Impact</h4>

<figure id="S10.T6" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 6</span>: </span><span class="ltx_text" style="font-size:90%;">Coverage Improvement with Incremental Extension</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Matching Strategy</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Coverage (%)</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Avg. Confidence</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Exact suffix only</th>
<td class="ltx_td ltx_align_center ltx_border_t">42.1%</td>
<td class="ltx_td ltx_align_center ltx_border_t">0.73</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">+ Synonym matching</th>
<td class="ltx_td ltx_align_center">61.3%</td>
<td class="ltx_td ltx_align_center">0.69</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">+ Function words</th>
<td class="ltx_td ltx_align_center">71.8%</td>
<td class="ltx_td ltx_align_center">0.66</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb">+ Stemming</th>
<td class="ltx_td ltx_align_center ltx_border_bb">78.2%</td>
<td class="ltx_td ltx_align_center ltx_border_bb">0.64</td>
</tr>
</tbody>
</table>
</figure>
<div id="S10.SS2.SSS6.p1" class="ltx_para">
<p class="ltx_p">Our incremental suffix extension algorithm dramatically improves n-gram coverage without requiring larger models.</p>
</div>
</section>
</section>
<section id="S10.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">10.3 </span>Ablation Studies</h3>

<div id="S10.SS3.p1" class="ltx_para">
<p class="ltx_p">We conduct ablations to understand the contribution of each algebraic operation:</p>
</div>
<figure id="S10.T7" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 7</span>: </span><span class="ltx_text" style="font-size:90%;">Ablation Study: Removing Algebraic Components</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Configuration</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Perplexity</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">
<math id="S10.T7.m1" class="ltx_Math" alttext="\Delta" display="inline"><mi mathvariant="normal">Δ</mi></math> PPL</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Impact</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Full Pipeline</th>
<td class="ltx_td ltx_align_center ltx_border_t">34.8</td>
<td class="ltx_td ltx_align_center ltx_border_t">—</td>
<td class="ltx_td ltx_align_center ltx_border_t">—</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">- Output constraints</th>
<td class="ltx_td ltx_align_center">36.2</td>
<td class="ltx_td ltx_align_center">+1.4</td>
<td class="ltx_td ltx_align_center">Moderate</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">- Input projections</th>
<td class="ltx_td ltx_align_center">38.6</td>
<td class="ltx_td ltx_align_center">+3.8</td>
<td class="ltx_td ltx_align_center">High</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">- N-gram mixture</th>
<td class="ltx_td ltx_align_center">42.1</td>
<td class="ltx_td ltx_align_center">+7.3</td>
<td class="ltx_td ltx_align_center">Very High</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb">- All algebra (baseline)</th>
<td class="ltx_td ltx_align_center ltx_border_bb">45.2</td>
<td class="ltx_td ltx_align_center ltx_border_bb">+10.4</td>
<td class="ltx_td ltx_align_center ltx_border_bb">Critical</td>
</tr>
</tbody>
</table>
</figure>
<div id="S10.SS3.p2" class="ltx_para">
<p class="ltx_p">Each algebraic component contributes significantly to overall performance.</p>
</div>
</section>
<section id="S10.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">10.4 </span>Computational Efficiency</h3>

<figure id="S10.T8" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 8</span>: </span><span class="ltx_text" style="font-size:90%;">Computational Cost of Algebraic Operations</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_align_middle">
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<td class="ltx_td ltx_align_left ltx_border_tt">Operation</td>
<td class="ltx_td ltx_align_center ltx_border_tt">Time (ms/token)</td>
<td class="ltx_td ltx_align_center ltx_border_tt">Memory (MB)</td>
</tr>
<tr class="ltx_tr">
<td class="ltx_td ltx_align_left ltx_border_t">N-gram lookup</td>
<td class="ltx_td ltx_align_center ltx_border_t">0.08</td>
<td class="ltx_td ltx_align_center ltx_border_t">450</td>
</tr>
<tr class="ltx_tr">
<td class="ltx_td ltx_align_left">Neural forward pass</td>
<td class="ltx_td ltx_align_center">12.3</td>
<td class="ltx_td ltx_align_center">2,100</td>
</tr>
<tr class="ltx_tr">
<td class="ltx_td ltx_align_left">Mixture combination</td>
<td class="ltx_td ltx_align_center">0.02</td>
<td class="ltx_td ltx_align_center">10</td>
</tr>
<tr class="ltx_tr">
<td class="ltx_td ltx_align_left">Constraint application</td>
<td class="ltx_td ltx_align_center">0.15</td>
<td class="ltx_td ltx_align_center">50</td>
</tr>
<tr class="ltx_tr">
<td class="ltx_td ltx_align_left">Projection computation</td>
<td class="ltx_td ltx_align_center">0.84</td>
<td class="ltx_td ltx_align_center">180</td>
</tr>
<tr class="ltx_tr">
<td class="ltx_td ltx_align_left ltx_border_t">Full pipeline</td>
<td class="ltx_td ltx_align_center ltx_border_t">13.4</td>
<td class="ltx_td ltx_align_center ltx_border_t">2,790</td>
</tr>
<tr class="ltx_tr">
<td class="ltx_td ltx_align_left ltx_border_bb">Baseline LLM</td>
<td class="ltx_td ltx_align_center ltx_border_bb">12.3</td>
<td class="ltx_td ltx_align_center ltx_border_bb">2,100</td>
</tr>
</tbody>
</table>
</figure>
<div id="S10.SS4.p1" class="ltx_para">
<p class="ltx_p">The algebraic operations add minimal overhead (¡ 10%) while providing significant benefits.</p>
</div>
</section>
</section>
<section id="S11" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">11 </span>Practical Examples and Code Patterns</h2>

<section id="S11.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">11.1 </span>One-Line Sophisticated Models</h3>

<div id="S11.SS1.p1" class="ltx_para">
<p class="ltx_p">Our algebraic framework enables expression of complex models in remarkably concise notation:</p>
</div>
<div id="S11.SS1.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBCYXNpYyBsaWdodHdlaWdodCBncm91bmRpbmcKbW9kZWwgPSAwLjk1ICogbGxtICsgMC4wNSAqIHN1ZmZpeF9hcnJheQoKIyBUZW1wZXJhdHVyZS1hZGp1c3RlZCBjb21wb3NpdGlvbiB3aXRoIHRyYW5zZm9ybXMKbW9kZWwgPSAoMC43ICogbGxtICsgMC4yICogKHdpa2kgPDwgTG9uZ2VzdFN1ZmZpeCgyMCkpICsgMC4xICogbmdyYW0pICoqIDAuOQoKIyBBZGFwdGl2ZSB3aXRoIHJlY2VuY3kgYW5kIGNhY2hpbmcKbW9kZWwgPSBBZGFwdGl2ZVN1ZmZpeChsbG0sIHNhLCAwLjgsIDAuOTUpIDw8IFJlY2VuY3lXZWlnaHQoMC45NSkgfCBjYWNoZQoKIyBQcm9kdWN0aW9uIHBpcGVsaW5lIHdpdGggYWxsIGZlYXR1cmVzCm1vZGVsID0gKAogICAgMC43ICogbGxtICsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE1haW4gcmVhc29uaW5nCiAgICAwLjE1ICogKHdpa2lfc2EgPDwgTG9uZ2VzdFN1ZmZpeCgyMCkpICsgICMgV2lraSBncm91bmRpbmcKICAgIDAuMSAqIChuZXdzX3NhIDw8IFJlY2VuY3lXZWlnaHQoMC45KSkgKyAgIyBSZWNlbnQgbmV3cwogICAgMC4wNSAqIGNhY2hlX21vZGVsICAgICAgICAgICAgICAgICAgICAgICAjIENhY2hlZCByZXNwb25zZXMKKSAqKiAwLjg1ID4+IHRocmVzaG9sZCgwLjEpIEAganNvbl9jb25zdHJhaW50" download="">⬇</a></div>
<div id="lstnumberx279" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Basic<span class="ltx_text ltx_lst_space"> </span>lightweight<span class="ltx_text ltx_lst_space"> </span>grounding</span></span>
</div>
<div id="lstnumberx280" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.95</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.05</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffix_array</span>
</div>
<div id="lstnumberx281" class="ltx_listingline">
</div>
<div id="lstnumberx282" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Temperature-adjusted<span class="ltx_text ltx_lst_space"> </span>composition<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>transforms</span></span>
</div>
<div id="lstnumberx283" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(0.7</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.2</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wiki</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">LongestSuffix</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(20))</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ngram</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">**</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.9</span>
</div>
<div id="lstnumberx284" class="ltx_listingline">
</div>
<div id="lstnumberx285" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Adaptive<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>recency<span class="ltx_text ltx_lst_space"> </span>and<span class="ltx_text ltx_lst_space"> </span>caching</span></span>
</div>
<div id="lstnumberx286" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">AdaptiveSuffix</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">sa</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.8,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.95)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">RecencyWeight</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(0.95)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">|</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">cache</span>
</div>
<div id="lstnumberx287" class="ltx_listingline">
</div>
<div id="lstnumberx288" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Production<span class="ltx_text ltx_lst_space"> </span>pipeline<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>all<span class="ltx_text ltx_lst_space"> </span>features</span></span>
</div>
<div id="lstnumberx289" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx290" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.7</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                              </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Main<span class="ltx_text ltx_lst_space"> </span>reasoning</span></span>
</div>
<div id="lstnumberx291" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.15</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">wiki_sa</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">LongestSuffix</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(20))</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Wiki<span class="ltx_text ltx_lst_space"> </span>grounding</span></span>
</div>
<div id="lstnumberx292" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">news_sa</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">RecencyWeight</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(0.9))</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Recent<span class="ltx_text ltx_lst_space"> </span>news</span></span>
</div>
<div id="lstnumberx293" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.05</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">cache_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                       </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Cached<span class="ltx_text ltx_lst_space"> </span>responses</span></span>
</div>
<div id="lstnumberx294" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">**</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.85</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&gt;&gt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">threshold</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(0.1)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">json_constraint</span>
</div>
</div>
</div>
</section>
<section id="S11.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">11.2 </span>Algebraic Properties Enable Optimization</h3>

<div id="S11.SS2.p1" class="ltx_para">
<p class="ltx_p">The mathematical structure allows powerful optimizations:</p>
</div>
<div id="S11.SS2.p2" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBBc3NvY2lhdGl2aXR5OiByZW9yZGVyIGZvciBlZmZpY2llbmN5CihhICsgYikgKyBjID09IGEgKyAoYiArIGMpICAjIEdyb3VwIHJlbGF0ZWQgbW9kZWxzCgojIERpc3RyaWJ1dGl2aXR5OiBmYWN0b3IgY29tbW9uIG9wZXJhdGlvbnMKYWxwaGEgKiAobTEgKyBtMikgPT0gYWxwaGEgKiBtMSArIGFscGhhICogbTIKCiMgVHJhbnNmb3JtIGNvbXBvc2l0aW9uOiBtZXJnZSBmb3Igc3BlZWQKKG0gPDwgdDEpIDw8IHQyID09IG0gPDwgKHQxIC4gdDIpCgojIFRlbXBlcmF0dXJlIGRpc3RyaWJ1dGlvbjogcGFyYWxsZWxpemUKKGEgKiBtMSArIGIgKiBtMikgKiogdCA9PSBhICogKG0xICoqIHQpICsgYiAqIChtMiAqKiB0KQ==" download="">⬇</a></div>
<div id="lstnumberx295" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Associativity:<span class="ltx_text ltx_lst_space"> </span>reorder<span class="ltx_text ltx_lst_space"> </span>for<span class="ltx_text ltx_lst_space"> </span>efficiency</span></span>
</div>
<div id="lstnumberx296" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">==</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Group<span class="ltx_text ltx_lst_space"> </span>related<span class="ltx_text ltx_lst_space"> </span>models</span></span>
</div>
<div id="lstnumberx297" class="ltx_listingline">
</div>
<div id="lstnumberx298" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Distributivity:<span class="ltx_text ltx_lst_space"> </span>factor<span class="ltx_text ltx_lst_space"> </span>common<span class="ltx_text ltx_lst_space"> </span>operations</span></span>
</div>
<div id="lstnumberx299" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alpha</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m2</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">==</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alpha</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alpha</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m2</span>
</div>
<div id="lstnumberx300" class="ltx_listingline">
</div>
<div id="lstnumberx301" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Transform<span class="ltx_text ltx_lst_space"> </span>composition:<span class="ltx_text ltx_lst_space"> </span>merge<span class="ltx_text ltx_lst_space"> </span>for<span class="ltx_text ltx_lst_space"> </span>speed</span></span>
</div>
<div id="lstnumberx302" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">t1</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">t2</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">==</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">t1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">t2</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx303" class="ltx_listingline">
</div>
<div id="lstnumberx304" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Temperature<span class="ltx_text ltx_lst_space"> </span>distribution:<span class="ltx_text ltx_lst_space"> </span>parallelize</span></span>
</div>
<div id="lstnumberx305" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m2</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">**</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">t</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">==</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">**</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">t</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m2</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">**</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">t</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
</section>
<section id="S11.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">11.3 </span>Real-World Usage Patterns</h3>

<section id="S11.SS3.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">11.3.1 </span>Domain-Specific Grounding</h4>

<div id="S11.SS3.SSS1.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBNZWRpY2FsIGFzc2lzdGFudCB3aXRoIHNwZWNpYWxpemVkIGdyb3VuZGluZwptZWRpY2FsX21vZGVsID0gKAogICAgMC44NSAqIG1lZGljYWxfbGxtICsKICAgIDAuMTAgKiAocHVibWVkX3NhIDw8IExvbmdlc3RTdWZmaXgoMzApKSArCiAgICAwLjA1ICogKGRydWdfZGJfc2EgPDwgRXhhY3RNYXRjaCgpKQopIEAgbWVkaWNhbF90ZXJtaW5vbG9neV9jb25zdHJhaW50" download="">⬇</a></div>
<div id="lstnumberx306" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Medical<span class="ltx_text ltx_lst_space"> </span>assistant<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>specialized<span class="ltx_text ltx_lst_space"> </span>grounding</span></span>
</div>
<div id="lstnumberx307" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">medical_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx308" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.85</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">medical_llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx309" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.10</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">pubmed_sa</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">LongestSuffix</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(30))</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx310" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.05</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">drug_db_sa</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ExactMatch</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">())</span>
</div>
<div id="lstnumberx311" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">medical_terminology_constraint</span>
</div>
</div>
</div>
</section>
<section id="S11.SS3.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">11.3.2 </span>Real-Time News Integration</h4>

<div id="S11.SS3.SSS2.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBOZXdzLWF3YXJlIG1vZGVsIHdpdGggcmVjZW5jeSBiaWFzCm5ld3NfbW9kZWwgPSAoCiAgICAwLjkwICogbGxtICsKICAgIDAuMTAgKiAobmV3c19zYSA8PCBSZWNlbmN5V2VpZ2h0KDAuOTkpKSAgIyBTdHJvbmcgcmVjZW5jeQopICoqIDAuOCAgIyBMb3dlciB0ZW1wZXJhdHVyZSBmb3IgZmFjdHVhbCBjb250ZW50" download="">⬇</a></div>
<div id="lstnumberx312" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>News-aware<span class="ltx_text ltx_lst_space"> </span>model<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>recency<span class="ltx_text ltx_lst_space"> </span>bias</span></span>
</div>
<div id="lstnumberx313" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">news_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx314" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.90</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx315" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.10</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">news_sa</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">RecencyWeight</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(0.99))</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Strong<span class="ltx_text ltx_lst_space"> </span>recency</span></span>
</div>
<div id="lstnumberx316" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">**</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.8</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">  </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Lower<span class="ltx_text ltx_lst_space"> </span>temperature<span class="ltx_text ltx_lst_space"> </span>for<span class="ltx_text ltx_lst_space"> </span>factual<span class="ltx_text ltx_lst_space"> </span>content</span></span>
</div>
</div>
</div>
</section>
<section id="S11.SS3.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">11.3.3 </span>Code Generation with Patterns</h4>

<div id="S11.SS3.SSS3.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBDb2RlIG1vZGVsIHdpdGggcGF0dGVybiBtYXRjaGluZwpjb2RlX21vZGVsID0gKAogICAgMC44MCAqIGNvZGVfbGxtICsKICAgIDAuMTUgKiAoZ2l0aHViX3NhIDw8IFBhdHRlcm5NYXRjaChzeW50YXhfdHJlZSkpICsKICAgIDAuMDUgKiAoZG9jc19zYSA8PCBTZW1hbnRpY1NlYXJjaCgpKQopIEAgc3ludGF4X2NvbnN0cmFpbnQgJiB0eXBlX2NvbnN0cmFpbnQ=" download="">⬇</a></div>
<div id="lstnumberx317" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Code<span class="ltx_text ltx_lst_space"> </span>model<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>pattern<span class="ltx_text ltx_lst_space"> </span>matching</span></span>
</div>
<div id="lstnumberx318" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">code_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx319" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.80</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">code_llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx320" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.15</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">github_sa</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">PatternMatch</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">syntax_tree</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">))</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx321" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.05</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">docs_sa</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">SemanticSearch</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">())</span>
</div>
<div id="lstnumberx322" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">syntax_constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&amp;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">type_constraint</span>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="S12" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">12 </span>Related Work and Connections</h2>

<section id="S12.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">12.1 </span>Historical Foundations</h3>

<div id="S12.SS1.p1" class="ltx_para">
<p class="ltx_p">Our algebraic framework builds upon several foundational ideas:</p>
</div>
<section id="S12.SS1.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.1.1 </span>Statistical Language Models</h4>

<div id="S12.SS1.SSS1.p1" class="ltx_para">
<p class="ltx_p">N-gram models <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite> pioneered statistical approaches to language modeling. Our framework generalizes n-grams as specific instances of projection-based models with suffix projections.</p>
</div>
</section>
<section id="S12.SS1.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.1.2 </span>Ensemble Methods</h4>

<div id="S12.SS1.SSS2.p1" class="ltx_para">
<p class="ltx_p">Mixture of experts <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite> and ensemble learning provide the conceptual foundation for our mixture operations. We extend these ideas with algebraic structure and composition laws.</p>
</div>
</section>
<section id="S12.SS1.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.1.3 </span>Formal Language Theory</h4>

<div id="S12.SS1.SSS3.p1" class="ltx_para">
<p class="ltx_p">Automata theory and formal languages <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite> inspire our constraint operations. We show how context-free grammars and regular expressions map to our constraint algebra.</p>
</div>
</section>
</section>
<section id="S12.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">12.2 </span>Contemporary Connections</h3>

<section id="S12.SS2.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.2.1 </span>Structured Generation</h4>

<div id="S12.SS2.SSS1.p1" class="ltx_para">
<p class="ltx_p">Recent work on constrained decoding <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite> including Guidance, LMQL, and JSONformer can be understood as specific instances of our output constraint algebra. Our framework unifies these approaches under a single mathematical structure.</p>
</div>
</section>
<section id="S12.SS2.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.2.2 </span>Retrieval-Augmented Generation</h4>

<div id="S12.SS2.SSS2.p1" class="ltx_para">
<p class="ltx_p">RAG systems <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite> implement a specific form of input projection where contexts are augmented with retrieved documents. Our semantic projection generalizes this concept.</p>
</div>
</section>
<section id="S12.SS2.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.2.3 </span>Continuous Learning</h4>

<div id="S12.SS2.SSS3.p1" class="ltx_para">
<p class="ltx_p">Parameter-efficient fine-tuning methods like LoRA <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite> aim for rapid adaptation. Our n-gram mixture approach provides an alternative that requires no gradient computation.</p>
</div>
</section>
</section>
<section id="S12.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">12.3 </span>Theoretical Connections</h3>

<section id="S12.SS3.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.3.1 </span>Category Theory in Computer Science</h4>

<div id="S12.SS3.SSS1.p1" class="ltx_para">
<p class="ltx_p">Our use of category theory follows the tradition of categorical semantics in programming languages <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite>. Language models form a category with rich additional structure.</p>
</div>
</section>
<section id="S12.SS3.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.3.2 </span>Algebraic Effects</h4>

<div id="S12.SS3.SSS2.p1" class="ltx_para">
<p class="ltx_p">The algebraic approach to computational effects <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite> inspires our treatment of projections and constraints as algebraic operations with well-defined composition laws.</p>
</div>
</section>
<section id="S12.SS3.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">12.3.3 </span>Information Theory</h4>

<div id="S12.SS3.SSS3.p1" class="ltx_para">
<p class="ltx_p">The information-theoretic view of language modeling <cite class="ltx_cite ltx_citemacro_cite"><span class="ltx_ref ltx_missing_citation ltx_ref_self">placeholder</span></cite> provides the foundation for understanding our mixture operations as optimal information combination.</p>
</div>
</section>
</section>
</section>
<section id="S13" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">13 </span>Discussion and Future Directions</h2>

<section id="S13.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">13.1 </span>Implications</h3>

<section id="S13.SS1.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.1.1 </span>For Language Model Engineering</h4>

<div id="S13.SS1.SSS1.p1" class="ltx_para">
<p class="ltx_p">The algebraic framework transforms language model development from monolithic training to compositional design. Engineers can:</p>
<ul id="S13.I1" class="ltx_itemize">
<li id="S13.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I1.i1.p1" class="ltx_para">
<p class="ltx_p">Build complex models from simple, tested components</p>
</div>
</li>
<li id="S13.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I1.i2.p1" class="ltx_para">
<p class="ltx_p">Reason algebraically about model behavior</p>
</div>
</li>
<li id="S13.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I1.i3.p1" class="ltx_para">
<p class="ltx_p">Rapidly prototype through composition rather than training</p>
</div>
</li>
<li id="S13.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I1.i4.p1" class="ltx_para">
<p class="ltx_p">Ensure reliability through mathematical guarantees</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S13.SS1.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.1.2 </span>For Theoretical Understanding</h4>

<div id="S13.SS1.SSS2.p1" class="ltx_para">
<p class="ltx_p">The category-theoretic formalization provides:</p>
<ul id="S13.I2" class="ltx_itemize">
<li id="S13.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I2.i1.p1" class="ltx_para">
<p class="ltx_p">Precise mathematical semantics for model composition</p>
</div>
</li>
<li id="S13.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I2.i2.p1" class="ltx_para">
<p class="ltx_p">Tools for proving properties of composed systems</p>
</div>
</li>
<li id="S13.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I2.i3.p1" class="ltx_para">
<p class="ltx_p">Connections to other areas of mathematics and computer science</p>
</div>
</li>
<li id="S13.I2.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I2.i4.p1" class="ltx_para">
<p class="ltx_p">A foundation for further theoretical development</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S13.SS1.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.1.3 </span>For Practical Applications</h4>

<div id="S13.SS1.SSS3.p1" class="ltx_para">
<p class="ltx_p">The framework enables:</p>
<ul id="S13.I3" class="ltx_itemize">
<li id="S13.I3.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I3.i1.p1" class="ltx_para">
<p class="ltx_p">Real-time personalization without retraining</p>
</div>
</li>
<li id="S13.I3.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I3.i2.p1" class="ltx_para">
<p class="ltx_p">Guaranteed structured output for critical applications</p>
</div>
</li>
<li id="S13.I3.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I3.i3.p1" class="ltx_para">
<p class="ltx_p">Reduced hallucination through factual grounding</p>
</div>
</li>
<li id="S13.I3.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I3.i4.p1" class="ltx_para">
<p class="ltx_p">Interpretable model behavior through algebraic decomposition</p>
</div>
</li>
</ul>
</div>
</section>
</section>
<section id="S13.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">13.2 </span>Limitations and Challenges</h3>

<section id="S13.SS2.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.2.1 </span>Computational Overhead</h4>

<div id="S13.SS2.SSS1.p1" class="ltx_para">
<p class="ltx_p">While individual operations are efficient, complex compositions may accumulate overhead. Future work should optimize composed operations through compilation or fusion.</p>
</div>
</section>
<section id="S13.SS2.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.2.2 </span>Theoretical Completeness</h4>

<div id="S13.SS2.SSS2.p1" class="ltx_para">
<p class="ltx_p">Our algebra captures many important operations but is not complete. Extensions might include:</p>
<ul id="S13.I4" class="ltx_itemize">
<li id="S13.I4.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I4.i1.p1" class="ltx_para">
<p class="ltx_p">Probabilistic programming constructs</p>
</div>
</li>
<li id="S13.I4.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I4.i2.p1" class="ltx_para">
<p class="ltx_p">Temporal operations for sequence modeling</p>
</div>
</li>
<li id="S13.I4.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I4.i3.p1" class="ltx_para">
<p class="ltx_p">Higher-order operations on model transformers</p>
</div>
</li>
</ul>
</div>
</section>
<section id="S13.SS2.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.2.3 </span>Learnability of Compositions</h4>

<div id="S13.SS2.SSS3.p1" class="ltx_para">
<p class="ltx_p">Currently, algebraic compositions are manually designed. Future work should explore:</p>
<ul id="S13.I5" class="ltx_itemize">
<li id="S13.I5.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I5.i1.p1" class="ltx_para">
<p class="ltx_p">Learning optimal compositions from data</p>
</div>
</li>
<li id="S13.I5.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I5.i2.p1" class="ltx_para">
<p class="ltx_p">Neural architecture search in the algebraic space</p>
</div>
</li>
<li id="S13.I5.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S13.I5.i3.p1" class="ltx_para">
<p class="ltx_p">Gradient-based optimization of algebraic expressions</p>
</div>
</li>
</ul>
</div>
</section>
</section>
<section id="S13.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">13.3 </span>Future Directions</h3>

<section id="S13.SS3.SSS1" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.3.1 </span>Algebraic Compilation</h4>

<div id="S13.SS3.SSS1.p1" class="ltx_para">
<p class="ltx_p">Develop compilers that optimize algebraic expressions:</p>
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBCZWZvcmUgb3B0aW1pemF0aW9uCm1vZGVsID0gKGEgKiBtMSArIGIgKiBtMikgQCBwMSBAIHAyIEAgYzEgQCBjMgoKIyBBZnRlciBhbGdlYnJhaWMgb3B0aW1pemF0aW9uCm1vZGVsID0gKGEgKiBtMSArIGIgKiBtMikgQCAocDEgLiBwMikgQCAoYzEgJiBjMikKIyBDb21wb3NlZCBvcGVyYXRpb25zIGFyZSBtb3JlIGVmZmljaWVudA==" download="">⬇</a></div>
<div id="lstnumberx323" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Before<span class="ltx_text ltx_lst_space"> </span>optimization</span></span>
</div>
<div id="lstnumberx324" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m2</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">p1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">p2</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c2</span>
</div>
<div id="lstnumberx325" class="ltx_listingline">
</div>
<div id="lstnumberx326" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>After<span class="ltx_text ltx_lst_space"> </span>algebraic<span class="ltx_text ltx_lst_space"> </span>optimization</span></span>
</div>
<div id="lstnumberx327" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">m2</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">p1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">p2</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c1</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&amp;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c2</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx328" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Composed<span class="ltx_text ltx_lst_space"> </span>operations<span class="ltx_text ltx_lst_space"> </span>are<span class="ltx_text ltx_lst_space"> </span>more<span class="ltx_text ltx_lst_space"> </span>efficient</span></span>
</div>
</div>
</div>
</section>
<section id="S13.SS3.SSS2" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.3.2 </span>Differentiable Algebra</h4>

<div id="S13.SS3.SSS2.p1" class="ltx_para">
<p class="ltx_p">Extend the algebra with differentiable operations:</p>
<table id="S13.E47" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S13.E47.m1" class="ltx_Math" alttext="\nabla_{\alpha}((\alpha M_{1}+(1-\alpha)M_{2})@\pi)=\frac{\partial\mathcal{L}}%
{\partial\alpha}" display="block"><mrow><mrow><msub><mo>∇</mo><mi>α</mi></msub><mrow><mo stretchy="false">(</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><mrow><mi>α</mi><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub></mrow><mo>+</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><mn>1</mn><mo>−</mo><mi>α</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><msub><mi>M</mi><mn>2</mn></msub></mrow></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>=</mo><mfrac><mrow><mo rspace="0em">∂</mo><mi class="ltx_font_mathcaligraphic">ℒ</mi></mrow><mrow><mo rspace="0em">∂</mo><mi>α</mi></mrow></mfrac></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(47)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">This would enable gradient-based optimization of algebraic structures.</p>
</div>
</section>
<section id="S13.SS3.SSS3" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.3.3 </span>Quantum Language Models</h4>

<div id="S13.SS3.SSS3.p1" class="ltx_para">
<p class="ltx_p">Explore quantum computing implementations where superposition naturally represents mixtures:</p>
<table id="S13.E48" class="ltx_equation ltx_eqn_table">

<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math id="S13.E48.m1" class="ltx_Math" alttext="|\psi\rangle=\alpha|M_{1}\rangle+\beta|M_{2}\rangle" display="block"><mrow><mrow><mo stretchy="false">|</mo><mi>ψ</mi><mo stretchy="false">⟩</mo></mrow><mo>=</mo><mrow><mrow><mi>α</mi><mo>⁢</mo><mrow><mo stretchy="false">|</mo><msub><mi>M</mi><mn>1</mn></msub><mo stretchy="false">⟩</mo></mrow></mrow><mo>+</mo><mrow><mi>β</mi><mo>⁢</mo><mrow><mo stretchy="false">|</mo><msub><mi>M</mi><mn>2</mn></msub><mo stretchy="false">⟩</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(48)</span></td>
</tr></tbody>
</table>
</div>
</section>
<section id="S13.SS3.SSS4" class="ltx_subsubsection">
<h4 class="ltx_title ltx_title_subsubsection">
<span class="ltx_tag ltx_tag_subsubsection">13.3.4 </span>Algebraic Type Systems</h4>

<div id="S13.SS3.SSS4.p1" class="ltx_para">
<p class="ltx_p">Develop type systems for the algebra to ensure composition safety:</p>
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,LS0gVHlwZS1zYWZlIGNvbXBvc2l0aW9uCm1vZGVsIDo6IENvbnRleHQgLT4gRGlzdHJpYnV0aW9uCnByb2plY3Rpb24gOjogQ29udGV4dCAtPiBDb250ZXh0CmNvbnN0cmFpbnQgOjogRGlzdHJpYnV0aW9uIC0+IERpc3RyaWJ1dGlvbgoKY29tcG9zZWQgOjogQ29udGV4dCAtPiBEaXN0cmlidXRpb24KY29tcG9zZWQgPSBtb2RlbCAuIHByb2plY3Rpb24gPj0+IGNvbnN0cmFpbnQ=" download="">⬇</a></div>
<div id="lstnumberx329" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">--</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Type</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">-</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">safe</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">composition</span>
</div>
<div id="lstnumberx330" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">::</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Context</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">-&gt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Distribution</span>
</div>
<div id="lstnumberx331" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projection</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">::</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Context</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">-&gt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Context</span>
</div>
<div id="lstnumberx332" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">constraint</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">::</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Distribution</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">-&gt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Distribution</span>
</div>
<div id="lstnumberx333" class="ltx_listingline">
</div>
<div id="lstnumberx334" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">composed</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">::</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Context</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">-&gt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Distribution</span>
</div>
<div id="lstnumberx335" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">composed</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projection</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&gt;=&gt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">constraint</span>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="S14" class="ltx_section">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">14 </span>Conclusion</h2>

<div id="S14.p1" class="ltx_para">
<p class="ltx_p">We have presented a unified algebraic framework for language model composition that fundamentally reconceptualizes how we build and reason about language models. By treating models, projections, and constraints as first-class algebraic objects with well-defined composition operations, we enable:</p>
</div>
<div id="S14.p2" class="ltx_para">
<ol id="S14.I1" class="ltx_enumerate">
<li id="S14.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="S14.I1.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Principled Composition</span>: Complex models built from simple, well-understood components through algebraic operations</p>
</div>
</li>
<li id="S14.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="S14.I1.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Theoretical Foundations</span>: A rigorous mathematical framework based on category theory that provides tools for reasoning about composed systems</p>
</div>
</li>
<li id="S14.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="S14.I1.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Practical Benefits</span>: Improved factual accuracy, structural reliability, and continuous learning capabilities demonstrated through extensive experiments</p>
</div>
</li>
<li id="S14.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">4.</span> 
<div id="S14.I1.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Unified Understanding</span>: Classical techniques (n-grams, grammars) and modern approaches (neural models, constraints) understood as instances of the same algebra</p>
</div>
</li>
</ol>
</div>
<div id="S14.p3" class="ltx_para">
<p class="ltx_p">The Language Model Algebra represents a paradigm shift from monolithic model training to compositional model engineering. Just as the development of linear algebra revolutionized numerical computation, we believe algebraic frameworks will transform how we build, understand, and deploy language models.</p>
</div>
<div id="S14.p4" class="ltx_para">
<p class="ltx_p">The experimental validation is compelling:</p>
<ul id="S14.I2" class="ltx_itemize">
<li id="S14.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S14.I2.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Minimal grounding (5% n-gram)</span>: 83.4% accuracy vs 71.2% baseline</p>
</div>
</li>
<li id="S14.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S14.I2.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Multi-source (7% total n-gram)</span>: 85.2% accuracy with real-time updates</p>
</div>
</li>
<li id="S14.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S14.I2.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Adaptation speed</span>: 8 seconds vs 4.2 hours for fine-tuning</p>
</div>
</li>
<li id="S14.I2.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S14.I2.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Compute requirements</span>: CPU-only vs GPU clusters</p>
</div>
</li>
</ul>
</div>
<div id="S14.p5" class="ltx_para">
<p class="ltx_p">But the deeper impact lies in the paradigm shift. Instead of building ever-larger models or complex retrieval systems, we can achieve remarkable improvements through simple algebraic composition. A production system might look like:</p>
</div>
<div id="S14.p6" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBUaGlzIGlzIHRoZSBmdXR1cmU6IHNpbXBsZSwgaW50ZXJwcmV0YWJsZSwgcG93ZXJmdWwKcHJvZHVjdGlvbl9tb2RlbCA9ICgKICAgIDAuOTUgKiBzdGF0ZV9vZl90aGVfYXJ0X2xsbSArCiAgICAwLjA1ICogY29udGludW91c2x5X3VwZGF0ZWRfbmdyYW1zCik=" download="">⬇</a></div>
<div id="lstnumberx336" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>This<span class="ltx_text ltx_lst_space"> </span>is<span class="ltx_text ltx_lst_space"> </span>the<span class="ltx_text ltx_lst_space"> </span>future:<span class="ltx_text ltx_lst_space"> </span>simple,<span class="ltx_text ltx_lst_space"> </span>interpretable,<span class="ltx_text ltx_lst_space"> </span>powerful</span></span>
</div>
<div id="lstnumberx337" class="ltx_listingline">
<span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">production_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span>
</div>
<div id="lstnumberx338" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.95</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">state_of_the_art_llm</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span>
</div>
<div id="lstnumberx339" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.05</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">continuously_updated_ngrams</span>
</div>
<div id="lstnumberx340" class="ltx_listingline">
<span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
<div id="S14.p7" class="ltx_para">
<p class="ltx_p">The implications extend beyond language models. Any AI system that balances pattern matching with generalization could benefit from algebraic composition. We envision:</p>
<ul id="S14.I3" class="ltx_itemize">
<li id="S14.I3.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S14.I3.i1.p1" class="ltx_para">
<p class="ltx_p">Vision models grounded in recent images</p>
</div>
</li>
<li id="S14.I3.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S14.I3.i2.p1" class="ltx_para">
<p class="ltx_p">Recommendation systems with real-time preference updates</p>
</div>
</li>
<li id="S14.I3.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S14.I3.i3.p1" class="ltx_para">
<p class="ltx_p">Robotics policies anchored in demonstrated behaviors</p>
</div>
</li>
<li id="S14.I3.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="S14.I3.i4.p1" class="ltx_para">
<p class="ltx_p">Scientific models combining theory with observations</p>
</div>
</li>
</ul>
</div>
<div id="S14.p8" class="ltx_para">
<p class="ltx_p">The Language Model Algebra transforms a complex engineering challenge into a simple algebraic expression. The future isn’t about replacing large models with complex architectures—it’s about grounding them with lightweight reality anchors. The formula is simple: <span class="ltx_text ltx_font_bold">Big Model + Small Weight + Simple N-gram = Reliable AI</span>.</p>
</div>
<div id="S14.p9" class="ltx_para">
<p class="ltx_p">In the end, the most profound insights are often the simplest. We don’t need to revolutionize language models; we just need to ground them. Five percent is enough.</p>
</div>
</section>
<section id="Sx1" class="ltx_section">
<h2 class="ltx_title ltx_title_section">Acknowledgments</h2>

<div id="Sx1.p1" class="ltx_para">
<p class="ltx_p">[Placeholder for acknowledgments]</p>
</div>
</section>
<section id="bib" class="ltx_bibliography">
<h2 class="ltx_title ltx_title_bibliography">References</h2>

<ul id="bib.L1" class="ltx_biblist">
</ul>
</section>
<section id="A1" class="ltx_appendix">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix A </span>Detailed Proofs</h2>

<section id="A1.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">A.1 </span>Proof of Monoidal Category Structure</h3>

<div class="ltx_proof">
<h6 class="ltx_title ltx_runin ltx_font_italic ltx_title_proof">Proof.</h6>
<div id="A1.SS1.p1" class="ltx_para">
<p class="ltx_p">We prove that <math id="A1.SS1.p1.m1" class="ltx_Math" alttext="\mathbf{LangMod}" display="inline"><mi>𝐋𝐚𝐧𝐠𝐌𝐨𝐝</mi></math> forms a symmetric monoidal category.</p>
</div>
<div id="A1.SS1.p2" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Objects and Morphisms:</span> Objects are language models <math id="A1.SS1.p2.m1" class="ltx_Math" alttext="M:\mathcal{C}\rightarrow\mathcal{D}" display="inline"><mrow><mi>M</mi><mo lspace="0.278em" rspace="0.278em">:</mo><mrow><mi class="ltx_font_mathcaligraphic">𝒞</mi><mo stretchy="false">→</mo><mi class="ltx_font_mathcaligraphic">𝒟</mi></mrow></mrow></math>. Morphisms are natural transformations preserving probabilistic structure.</p>
</div>
<div id="A1.SS1.p3" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Tensor Product:</span> Define <math id="A1.SS1.p3.m1" class="ltx_Math" alttext="M_{1}\otimes M_{2}=\frac{1}{2}(M_{1}+M_{2})" display="inline"><mrow><mrow><msub><mi>M</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">⊗</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo>=</mo><mrow><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math> (equal-weight mixture).</p>
</div>
<div id="A1.SS1.p4" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Associativity:</span></p>
<table id="A3.EGx3" class="ltx_equationgroup ltx_eqn_align ltx_eqn_table">

<tbody id="A1.E49"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="A1.E49.m1" class="ltx_Math" alttext="\displaystyle(M_{1}\otimes M_{2})\otimes M_{3}" display="inline"><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">⊗</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo rspace="0.055em" stretchy="false">)</mo></mrow><mo rspace="0.222em">⊗</mo><msub><mi>M</mi><mn>3</mn></msub></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E49.m2" class="ltx_Math" alttext="\displaystyle=\frac{1}{2}(\frac{1}{2}(M_{1}+M_{2})+M_{3})" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>+</mo><msub><mi>M</mi><mn>3</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(49)</span></td>
</tr></tbody>
<tbody id="A1.E50"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_eqn_cell"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E50.m1" class="ltx_Math" alttext="\displaystyle=\frac{1}{4}M_{1}+\frac{1}{4}M_{2}+\frac{1}{2}M_{3}" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub></mrow><mo>+</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle><mo>⁢</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo>+</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><msub><mi>M</mi><mn>3</mn></msub></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(50)</span></td>
</tr></tbody>
<tbody id="A1.E51"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="A1.E51.m1" class="ltx_Math" alttext="\displaystyle M_{1}\otimes(M_{2}\otimes M_{3})" display="inline"><mrow><msub><mi>M</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">⊗</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo lspace="0.222em" rspace="0.222em">⊗</mo><msub><mi>M</mi><mn>3</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E51.m2" class="ltx_Math" alttext="\displaystyle=\frac{1}{2}(M_{1}+\frac{1}{2}(M_{2}+M_{3}))" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>+</mo><msub><mi>M</mi><mn>3</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(51)</span></td>
</tr></tbody>
<tbody id="A1.E52"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_eqn_cell"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E52.m1" class="ltx_Math" alttext="\displaystyle=\frac{1}{2}M_{1}+\frac{1}{4}M_{2}+\frac{1}{4}M_{3}" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub></mrow><mo>+</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle><mo>⁢</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo>+</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle><mo>⁢</mo><msub><mi>M</mi><mn>3</mn></msub></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(52)</span></td>
</tr></tbody>
</table>
</div>
<div id="A1.SS1.p5" class="ltx_para">
<p class="ltx_p">The associator <math id="A1.SS1.p5.m1" class="ltx_Math" alttext="\alpha_{M_{1},M_{2},M_{3}}" display="inline"><msub><mi>α</mi><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>,</mo><msub><mi>M</mi><mn>2</mn></msub><mo>,</mo><msub><mi>M</mi><mn>3</mn></msub></mrow></msub></math> reweights to establish isomorphism.</p>
</div>
<div id="A1.SS1.p6" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Unit:</span> The uniform distribution <math id="A1.SS1.p6.m1" class="ltx_Math" alttext="I" display="inline"><mi>I</mi></math> satisfies <math id="A1.SS1.p6.m2" class="ltx_Math" alttext="I\otimes M\cong M\cong M\otimes I" display="inline"><mrow><mrow><mi>I</mi><mo lspace="0.222em" rspace="0.222em">⊗</mo><mi>M</mi></mrow><mo>≅</mo><mi>M</mi><mo>≅</mo><mrow><mi>M</mi><mo lspace="0.222em" rspace="0.222em">⊗</mo><mi>I</mi></mrow></mrow></math>.</p>
</div>
<div id="A1.SS1.p7" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Coherence:</span> The pentagon and triangle diagrams commute by construction.
∎</p>
</div>
</div>
</section>
<section id="A1.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">A.2 </span>Proof of Composition Laws</h3>

<div class="ltx_proof">
<h6 class="ltx_title ltx_runin ltx_font_italic ltx_title_proof">Proof.</h6>
<div id="A1.SS2.p1" class="ltx_para">
<p class="ltx_p">We prove key composition laws.</p>
</div>
<div id="A1.SS2.p2" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Distributivity over Addition:</span></p>
<table id="A3.EGx4" class="ltx_equationgroup ltx_eqn_align ltx_eqn_table">

<tbody id="A1.E53"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="A1.E53.m1" class="ltx_Math" alttext="\displaystyle((M_{1}+M_{2})@\pi)(c)" display="inline"><mrow><mrow><mo stretchy="false">(</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E53.m2" class="ltx_Math" alttext="\displaystyle=(M_{1}+M_{2})(\pi(c))" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>+</mo><msub><mi>M</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>π</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(53)</span></td>
</tr></tbody>
<tbody id="A1.E54"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_eqn_cell"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E54.m1" class="ltx_Math" alttext="\displaystyle=\frac{1}{2}M_{1}(\pi(c))+\frac{1}{2}M_{2}(\pi(c))" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>π</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow><mo>+</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mi>π</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(54)</span></td>
</tr></tbody>
<tbody id="A1.E55"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_eqn_cell"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E55.m1" class="ltx_Math" alttext="\displaystyle=\frac{1}{2}(M_{1}@\pi)(c)+\frac{1}{2}(M_{2}@\pi)(c)" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo>+</mo><mrow><mstyle displaystyle="true"><mfrac><mn>1</mn><mn>2</mn></mfrac></mstyle><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(55)</span></td>
</tr></tbody>
<tbody id="A1.E56"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_eqn_cell"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E56.m1" class="ltx_Math" alttext="\displaystyle=((M_{1}@\pi)+(M_{2}@\pi))(c)" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>1</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow><mo>+</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>M</mi><mn>2</mn></msub><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mi>π</mi></mrow><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(56)</span></td>
</tr></tbody>
</table>
</div>
<div id="A1.SS2.p3" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Associativity of Composition:</span></p>
<table id="A3.EGx5" class="ltx_equationgroup ltx_eqn_align ltx_eqn_table">

<tbody id="A1.E57"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math id="A1.E57.m1" class="ltx_Math" alttext="\displaystyle((M@\pi_{1})@\pi_{2})(c)" display="inline"><mrow><mrow><mo stretchy="false">(</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>π</mi><mn>1</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>π</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E57.m2" class="ltx_Math" alttext="\displaystyle=(M@\pi_{1})(\pi_{2}(c))" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><msub><mi>π</mi><mn>1</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>π</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(57)</span></td>
</tr></tbody>
<tbody id="A1.E58"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_eqn_cell"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E58.m1" class="ltx_Math" alttext="\displaystyle=M(\pi_{1}(\pi_{2}(c)))" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mi>M</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>π</mi><mn>1</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>π</mi><mn>2</mn></msub><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(58)</span></td>
</tr></tbody>
<tbody id="A1.E59"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_eqn_cell"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E59.m1" class="ltx_Math" alttext="\displaystyle=M((\pi_{1}\circ\pi_{2})(c))" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mi>M</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><msub><mi>π</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">∘</mo><msub><mi>π</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(59)</span></td>
</tr></tbody>
<tbody id="A1.E60"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_eqn_cell"></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math id="A1.E60.m1" class="ltx_Math" alttext="\displaystyle=(M@(\pi_{1}\circ\pi_{2}))(c)" display="inline"><mrow><mi></mi><mo>=</mo><mrow><mrow><mo stretchy="false">(</mo><mrow><mi>M</mi><mo>⁢</mo><mi mathvariant="normal">@</mi><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mrow><msub><mi>π</mi><mn>1</mn></msub><mo lspace="0.222em" rspace="0.222em">∘</mo><msub><mi>π</mi><mn>2</mn></msub></mrow><mo stretchy="false">)</mo></mrow></mrow><mo stretchy="false">)</mo></mrow><mo>⁢</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mrow></mrow></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td rowspan="1" class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right"><span class="ltx_tag ltx_tag_equation ltx_align_right">(60)</span></td>
</tr></tbody>
</table>
<p class="ltx_p">∎</p>
</div>
</div>
</section>
</section>
<section id="A2" class="ltx_appendix">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix B </span>Implementation Details</h2>

<section id="A2.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">B.1 </span>Implementation Quality and Testing</h3>

<div id="A2.SS1.p1" class="ltx_para">
<p class="ltx_p">The LangCalc framework maintains high code quality through comprehensive testing and verification:</p>
</div>
<div id="A2.SS1.p2" class="ltx_para">
<ul id="A2.I1" class="ltx_itemize">
<li id="A2.I1.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="A2.I1.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Test Suite</span>: 263 tests with 100% pass rate (228 unit tests, 35 integration tests)</p>
</div>
</li>
<li id="A2.I1.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="A2.I1.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Core Module Coverage</span>: 95% test coverage on <span class="ltx_text ltx_font_typewriter">model_algebra.py</span>, the foundation of the algebraic framework</p>
</div>
</li>
<li id="A2.I1.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="A2.I1.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Mathematical Property Verification</span>: Automated tests verify associativity, distributivity, commutativity, and identity properties</p>
</div>
</li>
<li id="A2.I1.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="A2.I1.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Edge Case Testing</span>: Comprehensive coverage of boundary conditions, empty inputs, and error handling</p>
</div>
</li>
<li id="A2.I1.i5" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span> 
<div id="A2.I1.i5.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Integration Testing</span>: End-to-end scenarios with Ollama LLM integration, multi-source grounding, and constraint composition</p>
</div>
</li>
</ul>
</div>
<div id="A2.SS1.p3" class="ltx_para">
<p class="ltx_p">The test infrastructure ensures mathematical consistency and production readiness:</p>
</div>
<div id="A2.SS1.p4" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,IyBFeGFtcGxlOiBBbGdlYnJhaWMgcHJvcGVydHkgdmVyaWZpY2F0aW9uCmRlZiB0ZXN0X2Fzc29jaWF0aXZpdHkoKToKICAgICIiIlZlcmlmeSAoYSArIGIpICsgYyA9IGEgKyAoYiArIGMpIiIiCiAgICBhLCBiLCBjID0gY3JlYXRlX3Rlc3RfbW9kZWxzKDMpCiAgICBsZWZ0ID0gKGEgKyBiKSArIGMKICAgIHJpZ2h0ID0gYSArIChiICsgYykKICAgIGFzc2VydF9lcXVpdmFsZW50X2Rpc3RyaWJ1dGlvbnMobGVmdCwgcmlnaHQpCgpkZWYgdGVzdF9kaXN0cmlidXRpdml0eSgpOgogICAgIiIiVmVyaWZ5IGFscGhhKihhICsgYikgPSBhbHBoYSphICsgYWxwaGEqYiIiIgogICAgYSwgYiA9IGNyZWF0ZV90ZXN0X21vZGVscygyKQogICAgYWxwaGEgPSAwLjMKICAgIGxlZnQgPSBhbHBoYSAqIChhICsgYikKICAgIHJpZ2h0ID0gKGFscGhhICogYSkgKyAoYWxwaGEgKiBiKQogICAgYXNzZXJ0X2VxdWl2YWxlbnRfZGlzdHJpYnV0aW9ucyhsZWZ0LCByaWdodCk=" download="">⬇</a></div>
<div id="lstnumberx341" class="ltx_listingline">
<span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Example:<span class="ltx_text ltx_lst_space"> </span>Algebraic<span class="ltx_text ltx_lst_space"> </span>property<span class="ltx_text ltx_lst_space"> </span>verification</span></span>
</div>
<div id="lstnumberx342" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">test_associativity</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">():</span>
</div>
<div id="lstnumberx343" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Verify<span class="ltx_text ltx_lst_space"> </span>(a<span class="ltx_text ltx_lst_space"> </span>+<span class="ltx_text ltx_lst_space"> </span>b)<span class="ltx_text ltx_lst_space"> </span>+<span class="ltx_text ltx_lst_space"> </span>c<span class="ltx_text ltx_lst_space"> </span>=<span class="ltx_text ltx_lst_space"> </span>a<span class="ltx_text ltx_lst_space"> </span>+<span class="ltx_text ltx_lst_space"> </span>(b<span class="ltx_text ltx_lst_space"> </span>+<span class="ltx_text ltx_lst_space"> </span>c)"</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span>
</div>
<div id="lstnumberx344" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">create_test_models</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(3)</span>
</div>
<div id="lstnumberx345" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">left</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c</span>
</div>
<div id="lstnumberx346" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">right</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">c</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx347" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">assert_equivalent_distributions</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">left</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">right</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx348" class="ltx_listingline">
</div>
<div id="lstnumberx349" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">test_distributivity</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">():</span>
</div>
<div id="lstnumberx350" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">"Verify<span class="ltx_text ltx_lst_space"> </span>alpha*(a<span class="ltx_text ltx_lst_space"> </span>+<span class="ltx_text ltx_lst_space"> </span>b)<span class="ltx_text ltx_lst_space"> </span>=<span class="ltx_text ltx_lst_space"> </span>alpha*a<span class="ltx_text ltx_lst_space"> </span>+<span class="ltx_text ltx_lst_space"> </span>alpha*b"</span><span class="ltx_text ltx_lst_string ltx_font_typewriter" style="font-size:90%;color:#FF0000;">""</span>
</div>
<div id="lstnumberx351" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">create_test_models</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(2)</span>
</div>
<div id="lstnumberx352" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alpha</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.3</span>
</div>
<div id="lstnumberx353" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">left</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alpha</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx354" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">right</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alpha</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">a</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">alpha</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">*</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">b</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx355" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">assert_equivalent_distributions</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">left</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">right</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
<div id="A2.SS1.p5" class="ltx_para">
<p class="ltx_p">This rigorous testing approach ensures that:</p>
<ol id="A2.I2" class="ltx_enumerate">
<li id="A2.I2.i1" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">1.</span> 
<div id="A2.I2.i1.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Algebraic laws hold</span>: Composition operations satisfy mathematical properties</p>
</div>
</li>
<li id="A2.I2.i2" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">2.</span> 
<div id="A2.I2.i2.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Edge cases handled</span>: Empty contexts, zero weights, extreme temperatures</p>
</div>
</li>
<li id="A2.I2.i3" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">3.</span> 
<div id="A2.I2.i3.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Integration works</span>: Real LLM integration via Ollama validated in tests</p>
</div>
</li>
<li id="A2.I2.i4" class="ltx_item" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">4.</span> 
<div id="A2.I2.i4.p1" class="ltx_para">
<p class="ltx_p"><span class="ltx_text ltx_font_bold">Performance verified</span>: Suffix array efficiency and overhead measurements</p>
</div>
</li>
</ol>
</div>
<div id="A2.SS1.p6" class="ltx_para">
<p class="ltx_p">See <span class="ltx_text ltx_font_typewriter">tests/README.md</span> and <span class="ltx_text ltx_font_typewriter">TEST_COVERAGE_SUMMARY.md</span> for detailed coverage analysis and test documentation.</p>
</div>
</section>
<section id="A2.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">B.2 </span>Suffix Array Construction</h3>

<div id="A2.SS2.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,Y2xhc3MgU3VmZml4QXJyYXk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY29ycHVzKToKICAgICAgICBzZWxmLmNvcnB1cyA9IGNvcnB1cwogICAgICAgIHNlbGYuc3VmZml4ZXMgPSBzZWxmLl9idWlsZF9zdWZmaXhfYXJyYXkoY29ycHVzKQogICAgICAgIHNlbGYubmdyYW1fY291bnRzID0gc2VsZi5fY29tcHV0ZV9uZ3JhbV9jb3VudHMoKQoKICAgIGRlZiBfYnVpbGRfc3VmZml4X2FycmF5KHNlbGYsIHRleHQpOgogICAgICAgICMgQnVpbGQgc3VmZml4IGFycmF5IGluIE8obiBsb2cgbikKICAgICAgICBzdWZmaXhlcyA9IFsodGV4dFtpOl0sIGkpIGZvciBpIGluIHJhbmdlKGxlbih0ZXh0KSldCiAgICAgICAgc3VmZml4ZXMuc29ydCgpCiAgICAgICAgcmV0dXJuIFtpIGZvciBfLCBpIGluIHN1ZmZpeGVzXQoKICAgIGRlZiBxdWVyeShzZWxmLCBjb250ZXh0LCBuPTUpOgogICAgICAgICMgQmluYXJ5IHNlYXJjaCBmb3IgY29udGV4dCBpbiBPKGxvZyB8Y29ycHVzfCkKICAgICAgICBsZWZ0ID0gc2VsZi5fYmluYXJ5X3NlYXJjaF9sZWZ0KGNvbnRleHQpCiAgICAgICAgcmlnaHQgPSBzZWxmLl9iaW5hcnlfc2VhcmNoX3JpZ2h0KGNvbnRleHQpCgogICAgICAgICMgRXh0cmFjdCBjb250aW51YXRpb24gY291bnRzCiAgICAgICAgY29udGludWF0aW9ucyA9IGRlZmF1bHRkaWN0KGludCkKICAgICAgICBmb3IgaSBpbiByYW5nZShsZWZ0LCByaWdodCk6CiAgICAgICAgICAgIG5leHRfcG9zID0gc2VsZi5zdWZmaXhlc1tpXSArIGxlbihjb250ZXh0KQogICAgICAgICAgICBpZiBuZXh0X3BvcyA8IGxlbihzZWxmLmNvcnB1cyk6CiAgICAgICAgICAgICAgICBuZXh0X3Rva2VuID0gc2VsZi5jb3JwdXNbbmV4dF9wb3NdCiAgICAgICAgICAgICAgICBjb250aW51YXRpb25zW25leHRfdG9rZW5dICs9IDEKCiAgICAgICAgcmV0dXJuIHNlbGYuX25vcm1hbGl6ZShjb250aW51YXRpb25zKQoKICAgIGRlZiB1cGRhdGUoc2VsZiwgbmV3X3RleHQpOgogICAgICAgICMgRHluYW1pYyB1cGRhdGUgaW4gTyh8bmV3X3RleHR8IGxvZyB8Y29ycHVzfCkKICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4obmV3X3RleHQpKToKICAgICAgICAgICAgc3VmZml4ID0gbmV3X3RleHRbaTpdCiAgICAgICAgICAgIGluc2VydF9wb3MgPSBzZWxmLl9maW5kX2luc2VydF9wb3NpdGlvbihzdWZmaXgpCiAgICAgICAgICAgIHNlbGYuc3VmZml4ZXMuaW5zZXJ0KGluc2VydF9wb3MsIGxlbihzZWxmLmNvcnB1cykgKyBpKQogICAgICAgIHNlbGYuY29ycHVzICs9IG5ld190ZXh0" download="">⬇</a></div>
<div id="lstnumberx356" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">class</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">SuffixArray</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx357" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__init__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">corpus</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx358" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">corpus</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">corpus</span>
</div>
<div id="lstnumberx359" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffixes</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">_build_suffix_array</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">corpus</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx360" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ngram_counts</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">_compute_ngram_counts</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx361" class="ltx_listingline">
</div>
<div id="lstnumberx362" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">_build_suffix_array</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">text</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx363" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Build<span class="ltx_text ltx_lst_space"> </span>suffix<span class="ltx_text ltx_lst_space"> </span>array<span class="ltx_text ltx_lst_space"> </span>in<span class="ltx_text ltx_lst_space"> </span>O(n<span class="ltx_text ltx_lst_space"> </span>log<span class="ltx_text ltx_lst_space"> </span>n)</span></span>
</div>
<div id="lstnumberx364" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffixes</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">text</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:],</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">range</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">len</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">text</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">))]</span>
</div>
<div id="lstnumberx365" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffixes</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">sort</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx366" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">_</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffixes</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span>
</div>
<div id="lstnumberx367" class="ltx_listingline">
</div>
<div id="lstnumberx368" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">query</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">n</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=5):</span>
</div>
<div id="lstnumberx369" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Binary<span class="ltx_text ltx_lst_space"> </span>search<span class="ltx_text ltx_lst_space"> </span>for<span class="ltx_text ltx_lst_space"> </span>context<span class="ltx_text ltx_lst_space"> </span>in<span class="ltx_text ltx_lst_space"> </span>O(log<span class="ltx_text ltx_lst_space"> </span>|corpus|)</span></span>
</div>
<div id="lstnumberx370" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">left</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">_binary_search_left</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx371" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">right</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">_binary_search_right</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx372" class="ltx_listingline">
</div>
<div id="lstnumberx373" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Extract<span class="ltx_text ltx_lst_space"> </span>continuation<span class="ltx_text ltx_lst_space"> </span>counts</span></span>
</div>
<div id="lstnumberx374" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">continuations</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">defaultdict</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">int</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx375" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">range</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">left</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">right</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx376" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">next_pos</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffixes</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">len</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx377" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">next_pos</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">&lt;</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">len</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">corpus</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx378" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">next_token</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">corpus</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">next_pos</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span>
</div>
<div id="lstnumberx379" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">continuations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">next_token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">1</span>
</div>
<div id="lstnumberx380" class="ltx_listingline">
</div>
<div id="lstnumberx381" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">_normalize</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">continuations</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx382" class="ltx_listingline">
</div>
<div id="lstnumberx383" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">update</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_text</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx384" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Dynamic<span class="ltx_text ltx_lst_space"> </span>update<span class="ltx_text ltx_lst_space"> </span>in<span class="ltx_text ltx_lst_space"> </span>O(|new_text|<span class="ltx_text ltx_lst_space"> </span>log<span class="ltx_text ltx_lst_space"> </span>|corpus|)</span></span>
</div>
<div id="lstnumberx385" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">range</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">len</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_text</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)):</span>
</div>
<div id="lstnumberx386" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffix</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_text</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:]</span>
</div>
<div id="lstnumberx387" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">insert_pos</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">_find_insert_position</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffix</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx388" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">suffixes</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">insert</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">insert_pos</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">len</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">corpus</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">i</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx389" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">corpus</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">new_text</span>
</div>
</div>
</div>
</section>
<section id="A2.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">B.3 </span>Constraint Implementation</h3>

<div id="A2.SS3.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,Y2xhc3MgSlNPTlNjaGVtYUNvbnN0cmFpbnQ6CiAgICBkZWYgX19pbml0X18oc2VsZiwgc2NoZW1hKToKICAgICAgICBzZWxmLnNjaGVtYSA9IHNjaGVtYQogICAgICAgIHNlbGYudmFsaWRhdG9yID0gSlNPTlZhbGlkYXRvcihzY2hlbWEpCgogICAgZGVmIGFwcGx5KHNlbGYsIGRpc3RyaWJ1dGlvbiwgY29udGV4dCk6CiAgICAgICAgIyBHZXQgdmFsaWQgY29udGludWF0aW9ucwogICAgICAgIHZhbGlkX3Rva2VucyA9IHNldCgpCgogICAgICAgIGZvciB0b2tlbiBpbiBkaXN0cmlidXRpb24udm9jYWI6CiAgICAgICAgICAgIHBvdGVudGlhbCA9IGNvbnRleHQgKyB0b2tlbgogICAgICAgICAgICBpZiBzZWxmLnZhbGlkYXRvci5pc192YWxpZF9wcmVmaXgocG90ZW50aWFsKToKICAgICAgICAgICAgICAgIHZhbGlkX3Rva2Vucy5hZGQodG9rZW4pCgogICAgICAgICMgQXBwbHkgbWFzawogICAgICAgIG1hc2tlZCA9IGRpc3RyaWJ1dGlvbi5jb3B5KCkKICAgICAgICBmb3IgdG9rZW4gaW4gZGlzdHJpYnV0aW9uLnZvY2FiOgogICAgICAgICAgICBpZiB0b2tlbiBub3QgaW4gdmFsaWRfdG9rZW5zOgogICAgICAgICAgICAgICAgbWFza2VkW3Rva2VuXSA9IDAKCiAgICAgICAgIyBSZW5vcm1hbGl6ZQogICAgICAgIHJldHVybiBtYXNrZWQubm9ybWFsaXplKCkKCiAgICBkZWYgX19tYXRtdWxfXyhzZWxmLCBvdGhlcik6CiAgICAgICAgIyBDb21wb3NlIHdpdGggbW9kZWwgdXNpbmcgQCBvcGVyYXRvcgogICAgICAgIGlmIGlzaW5zdGFuY2Uob3RoZXIsIExhbmd1YWdlTW9kZWwpOgogICAgICAgICAgICByZXR1cm4gQ29uc3RyYWluZWRNb2RlbChvdGhlciwgc2VsZikKICAgICAgICBlbGlmIGlzaW5zdGFuY2Uob3RoZXIsIENvbnN0cmFpbnQpOgogICAgICAgICAgICByZXR1cm4gQ29tcG9zZWRDb25zdHJhaW50KHNlbGYsIG90aGVyKQ==" download="">⬇</a></div>
<div id="lstnumberx390" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">class</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">JSONSchemaConstraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx391" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__init__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">schema</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx392" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">schema</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">schema</span>
</div>
<div id="lstnumberx393" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">validator</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">JSONValidator</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">schema</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx394" class="ltx_listingline">
</div>
<div id="lstnumberx395" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">apply</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx396" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Get<span class="ltx_text ltx_lst_space"> </span>valid<span class="ltx_text ltx_lst_space"> </span>continuations</span></span>
</div>
<div id="lstnumberx397" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">valid_tokens</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">set</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx398" class="ltx_listingline">
</div>
<div id="lstnumberx399" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">vocab</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx400" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">potential</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">context</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">+</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span>
</div>
<div id="lstnumberx401" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">validator</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">is_valid_prefix</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">potential</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx402" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">valid_tokens</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">add</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx403" class="ltx_listingline">
</div>
<div id="lstnumberx404" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Apply<span class="ltx_text ltx_lst_space"> </span>mask</span></span>
</div>
<div id="lstnumberx405" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">masked</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">copy</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx406" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">for</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">distribution</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">vocab</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx407" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">not</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">in</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">valid_tokens</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx408" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">                </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">masked</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">token</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">]</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0</span>
</div>
<div id="lstnumberx409" class="ltx_listingline">
</div>
<div id="lstnumberx410" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Renormalize</span></span>
</div>
<div id="lstnumberx411" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">masked</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">normalize</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">()</span>
</div>
<div id="lstnumberx412" class="ltx_listingline">
</div>
<div id="lstnumberx413" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__matmul__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx414" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Compose<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>model<span class="ltx_text ltx_lst_space"> </span>using<span class="ltx_text ltx_lst_space"> </span>@<span class="ltx_text ltx_lst_space"> </span>operator</span></span>
</div>
<div id="lstnumberx415" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">isinstance</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">LanguageModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx416" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ConstrainedModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx417" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">elif</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">isinstance</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Constraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx418" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ComposedConstraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
</section>
<section id="A2.SS4" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">B.4 </span>Algebraic Model Wrapper</h3>

<div id="A2.SS4.p1" class="ltx_para">
<div class="ltx_listing ltx_lst_language_Python ltx_lstlisting ltx_listing">
<div class="ltx_listing_data"><a href="data:text/plain;base64,Y2xhc3MgQWxnZWJyYWljTW9kZWw6CiAgICBkZWYgX19pbml0X18oc2VsZiwgYmFzZV9tb2RlbCk6CiAgICAgICAgc2VsZi5iYXNlX21vZGVsID0gYmFzZV9tb2RlbAoKICAgIGRlZiBfX2FkZF9fKHNlbGYsIG90aGVyKToKICAgICAgICAjIE1peHR1cmUgd2l0aCBlcXVhbCB3ZWlnaHRzCiAgICAgICAgcmV0dXJuIE1peHR1cmVNb2RlbChbc2VsZiwgb3RoZXJdLCBbMC41LCAwLjVdKQoKICAgIGRlZiBfX211bF9fKHNlbGYsIHNjYWxhcik6CiAgICAgICAgIyBXZWlnaHRlZCBtb2RlbAogICAgICAgIHJldHVybiBXZWlnaHRlZE1vZGVsKHNlbGYsIHNjYWxhcikKCiAgICBkZWYgX19tYXRtdWxfXyhzZWxmLCB0cmFuc2Zvcm0pOgogICAgICAgICMgQ29tcG9zaXRpb24KICAgICAgICBpZiBpc2luc3RhbmNlKHRyYW5zZm9ybSwgUHJvamVjdGlvbik6CiAgICAgICAgICAgIHJldHVybiBQcm9qZWN0ZWRNb2RlbChzZWxmLCB0cmFuc2Zvcm0pCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKHRyYW5zZm9ybSwgQ29uc3RyYWludCk6CiAgICAgICAgICAgIHJldHVybiBDb25zdHJhaW5lZE1vZGVsKHNlbGYsIHRyYW5zZm9ybSkKCiAgICBkZWYgX19yc2hpZnRfXyhzZWxmLCBwcm9qZWN0aW9uKToKICAgICAgICAjIElucHV0IHByb2plY3Rpb24gKHN5bnRheCBzdWdhcikKICAgICAgICByZXR1cm4gc2VsZiBAIHByb2plY3Rpb24KCiAgICBkZWYgX19vcl9fKHNlbGYsIG90aGVyKToKICAgICAgICAjIEZvciBjb25zdHJhaW50czogdW5pb24KICAgICAgICBpZiBpc2luc3RhbmNlKHNlbGYsIENvbnN0cmFpbnQpOgogICAgICAgICAgICByZXR1cm4gVW5pb25Db25zdHJhaW50KHNlbGYsIG90aGVyKQoKICAgIGRlZiBfX2FuZF9fKHNlbGYsIG90aGVyKToKICAgICAgICAjIEZvciBjb25zdHJhaW50czogaW50ZXJzZWN0aW9uCiAgICAgICAgaWYgaXNpbnN0YW5jZShzZWxmLCBDb25zdHJhaW50KToKICAgICAgICAgICAgcmV0dXJuIEludGVyc2VjdGlvbkNvbnN0cmFpbnQoc2VsZiwgb3RoZXIp" download="">⬇</a></div>
<div id="lstnumberx419" class="ltx_listingline">
<span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">class</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">AlgebraicModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">:</span>
</div>
<div id="lstnumberx420" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__init__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_model</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx421" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">.</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_model</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">=</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">base_model</span>
</div>
<div id="lstnumberx422" class="ltx_listingline">
</div>
<div id="lstnumberx423" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__add__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx424" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Mixture<span class="ltx_text ltx_lst_space"> </span>with<span class="ltx_text ltx_lst_space"> </span>equal<span class="ltx_text ltx_lst_space"> </span>weights</span></span>
</div>
<div id="lstnumberx425" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">MixtureModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">([</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">],</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">[0.5,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">0.5])</span>
</div>
<div id="lstnumberx426" class="ltx_listingline">
</div>
<div id="lstnumberx427" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__mul__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">scalar</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx428" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Weighted<span class="ltx_text ltx_lst_space"> </span>model</span></span>
</div>
<div id="lstnumberx429" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">WeightedModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">scalar</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx430" class="ltx_listingline">
</div>
<div id="lstnumberx431" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__matmul__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transform</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx432" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Composition</span></span>
</div>
<div id="lstnumberx433" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">isinstance</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transform</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Projection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx434" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ProjectedModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transform</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx435" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">elif</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">isinstance</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transform</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Constraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx436" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">ConstrainedModel</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">transform</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx437" class="ltx_listingline">
</div>
<div id="lstnumberx438" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__rshift__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projection</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx439" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>Input<span class="ltx_text ltx_lst_space"> </span>projection<span class="ltx_text ltx_lst_space"> </span>(syntax<span class="ltx_text ltx_lst_space"> </span>sugar)</span></span>
</div>
<div id="lstnumberx440" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">@</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">projection</span>
</div>
<div id="lstnumberx441" class="ltx_listingline">
</div>
<div id="lstnumberx442" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__or__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx443" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>For<span class="ltx_text ltx_lst_space"> </span>constraints:<span class="ltx_text ltx_lst_space"> </span>union</span></span>
</div>
<div id="lstnumberx444" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">isinstance</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Constraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx445" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">UnionConstraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
<div id="lstnumberx446" class="ltx_listingline">
</div>
<div id="lstnumberx447" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">    </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">def</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">__and__</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx448" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_comment ltx_font_typewriter" style="font-size:90%;"><span class="ltx_text" style="color:#808080;">#<span class="ltx_text ltx_lst_space"> </span>For<span class="ltx_text ltx_lst_space"> </span>constraints:<span class="ltx_text ltx_lst_space"> </span>intersection</span></span>
</div>
<div id="lstnumberx449" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">        </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">if</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_keyword ltx_lst_keywords2 ltx_font_typewriter" style="font-size:90%;color:#0000FF;">isinstance</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">Constraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">):</span>
</div>
<div id="lstnumberx450" class="ltx_listingline">
<span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;">            </span><span class="ltx_text ltx_lst_keyword ltx_font_typewriter" style="font-size:90%;color:#0000FF;">return</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">IntersectionConstraint</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">(</span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">self</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">,</span><span class="ltx_text ltx_lst_space ltx_font_typewriter" style="font-size:90%;"> </span><span class="ltx_text ltx_lst_identifier ltx_font_typewriter" style="font-size:90%;">other</span><span class="ltx_text ltx_font_typewriter" style="font-size:90%;">)</span>
</div>
</div>
</div>
</section>
</section>
<section id="A3" class="ltx_appendix">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix C </span>Additional Experimental Results</h2>

<section id="A3.SS1" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">C.1 </span>Domain Adaptation Speed</h3>

<figure id="A3.T9" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 9</span>: </span><span class="ltx_text" style="font-size:90%;">Time to Adapt to New Domain (90% of peak performance)</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Method</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Adaptation Time</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Memory Required</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Full Fine-tuning</th>
<td class="ltx_td ltx_align_center ltx_border_t">4.2 hours</td>
<td class="ltx_td ltx_align_center ltx_border_t">24 GB</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">LoRA Adaptation</th>
<td class="ltx_td ltx_align_center">18 minutes</td>
<td class="ltx_td ltx_align_center">8 GB</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Retrieval Database</th>
<td class="ltx_td ltx_align_center">5 minutes</td>
<td class="ltx_td ltx_align_center">12 GB</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb">Algebraic N-gram Update</th>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">8 seconds</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">0.5 GB</span></td>
</tr>
</tbody>
</table>
</figure>
</section>
<section id="A3.SS2" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">C.2 </span>Compositional Generalization</h3>

<figure id="A3.T10" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 10</span>: </span><span class="ltx_text" style="font-size:90%;">Performance on SCAN Compositional Generalization</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Model</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Length Split</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">MCD Split</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Baseline LLM</th>
<td class="ltx_td ltx_align_center ltx_border_t">14.3%</td>
<td class="ltx_td ltx_align_center ltx_border_t">8.2%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">With Pattern Projection</th>
<td class="ltx_td ltx_align_center">67.8%</td>
<td class="ltx_td ltx_align_center">54.3%</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb">With Algebraic Composition</th>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">82.4%</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb"><span class="ltx_text ltx_font_bold">71.6%</span></td>
</tr>
</tbody>
</table>
</figure>
</section>
<section id="A3.SS3" class="ltx_subsection">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">C.3 </span>Interpretability Analysis</h3>

<figure id="A3.T11" class="ltx_table">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table"><span class="ltx_text" style="font-size:90%;">Table 11</span>: </span><span class="ltx_text" style="font-size:90%;">Interpretability Metrics</span></figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle">
<thead class="ltx_thead">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_tt">Model</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Attribution</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Decomposable</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt">Traceable</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_t">Black-box LLM</th>
<td class="ltx_td ltx_align_center ltx_border_t">No</td>
<td class="ltx_td ltx_align_center ltx_border_t">No</td>
<td class="ltx_td ltx_align_center ltx_border_t">No</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Attention-based</th>
<td class="ltx_td ltx_align_center">Partial</td>
<td class="ltx_td ltx_align_center">No</td>
<td class="ltx_td ltx_align_center">Partial</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row">Algebraic Mixture</th>
<td class="ltx_td ltx_align_center">Yes</td>
<td class="ltx_td ltx_align_center">Yes</td>
<td class="ltx_td ltx_align_center">Yes</td>
</tr>
<tr class="ltx_tr">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb">With Projections</th>
<td class="ltx_td ltx_align_center ltx_border_bb">Yes</td>
<td class="ltx_td ltx_align_center ltx_border_bb">Yes</td>
<td class="ltx_td ltx_align_center ltx_border_bb">Yes</td>
</tr>
</tbody>
</table>
</figure>
</section>
</section>
</article>
</div>
<footer class="ltx_page_footer">
<div class="ltx_page_logo">Generated  on Tue Oct  7 08:32:54 2025 by <a href="http://dlmf.nist.gov/LaTeXML/" class="ltx_LaTeXML_logo"><span style="letter-spacing:-0.2em; margin-right:0.1em;">L<span class="ltx_font_smallcaps" style="position:relative; bottom:2.2pt;">a</span>T<span class="ltx_font_smallcaps" style="font-size:120%;position:relative; bottom:-0.2ex;">e</span></span><span style="font-size:90%; position:relative; bottom:-0.2ex;">XML</span><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAOCAYAAAD5YeaVAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wKExQZLWTEaOUAAAAddEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIFRoZSBHSU1Q72QlbgAAAdpJREFUKM9tkL+L2nAARz9fPZNCKFapUn8kyI0e4iRHSR1Kb8ng0lJw6FYHFwv2LwhOpcWxTjeUunYqOmqd6hEoRDhtDWdA8ApRYsSUCDHNt5ul13vz4w0vWCgUnnEc975arX6ORqN3VqtVZbfbTQC4uEHANM3jSqXymFI6yWazP2KxWAXAL9zCUa1Wy2tXVxheKA9YNoR8Pt+aTqe4FVVVvz05O6MBhqUIBGk8Hn8HAOVy+T+XLJfLS4ZhTiRJgqIoVBRFIoric47jPnmeB1mW/9rr9ZpSSn3Lsmir1fJZlqWlUonKsvwWwD8ymc/nXwVBeLjf7xEKhdBut9Hr9WgmkyGEkJwsy5eHG5vN5g0AKIoCAEgkEkin0wQAfN9/cXPdheu6P33fBwB4ngcAcByHJpPJl+fn54mD3Gg0NrquXxeLRQAAwzAYj8cwTZPwPH9/sVg8PXweDAauqqr2cDjEer1GJBLBZDJBs9mE4zjwfZ85lAGg2+06hmGgXq+j3+/DsixYlgVN03a9Xu8jgCNCyIegIAgx13Vfd7vdu+FweG8YRkjXdWy329+dTgeSJD3ieZ7RNO0VAXAPwDEAO5VKndi2fWrb9jWl9Esul6PZbDY9Go1OZ7PZ9z/lyuD3OozU2wAAAABJRU5ErkJggg==" alt="Mascot Sammy"></a>
</div></footer>
</div>
</div>
<script>
/* Component JS: reading-time */
// Reading Time Component JavaScript
(function() {
    'use strict';

    function initReadingTime() {
        // Calculate reading time
        const readingStats = calculateReadingTime();

        if (!readingStats.words || readingStats.words === 0) {
            return; // No content found
        }

        // Create reading time element
        const readingTime = document.createElement('div');
        readingTime.className = 'tex2any-reading-time';
        readingTime.setAttribute('role', 'status');
        readingTime.setAttribute('aria-label', 'Estimated reading time: ' + readingStats.minutes + ' minutes');
        readingTime.setAttribute('data-tooltip', readingStats.words + ' words');

        // Progress indicator
        const progressDot = document.createElement('span');
        progressDot.className = 'tex2any-reading-time-progress not-started';
        progressDot.setAttribute('aria-hidden', 'true');

        // Clock icon
        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        icon.setAttribute('viewBox', '0 0 24 24');
        icon.setAttribute('aria-hidden', 'true');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z');
        icon.appendChild(path);

        // Text
        const text = document.createElement('span');
        text.className = 'tex2any-reading-time-text';
        text.textContent = readingStats.minutes + ' min read';

        // Assemble
        readingTime.appendChild(progressDot);
        readingTime.appendChild(icon);
        readingTime.appendChild(text);

        // Insert into document
        insertReadingTime(readingTime);

        // Track reading progress
        trackReadingProgress(readingTime, progressDot, readingStats.words);
    }

    function calculateReadingTime() {
        // Average reading speed: 200 words per minute
        const wordsPerMinute = 200;

        // Get main content
        const contentSelectors = [
            '.ltx_document',
            'main',
            'article',
            '.tex2any-content-wrapper',
            'body'
        ];

        let contentElement = null;
        for (const selector of contentSelectors) {
            contentElement = document.querySelector(selector);
            if (contentElement) break;
        }

        if (!contentElement) {
            return { words: 0, minutes: 0 };
        }

        // Get text content, excluding certain elements
        const clonedContent = contentElement.cloneNode(true);

        // Remove elements that shouldn't be counted
        const excludeSelectors = [
            'script',
            'style',
            'nav',
            '.tex2any-reading-time',
            '.tex2any-toc',
            '.tex2any-floating-toc',
            '.tex2any-footer',
            '.tex2any-header',
            'code',  // Code is typically read slower
            '.ltx_biblist'  // Bibliography
        ];

        excludeSelectors.forEach(function(selector) {
            const elements = clonedContent.querySelectorAll(selector);
            elements.forEach(function(el) {
                el.remove();
            });
        });

        // Get text content
        const text = clonedContent.textContent || '';

        // Count words
        const words = text.trim().split(/\s+/).filter(function(word) {
            return word.length > 0;
        }).length;

        // Calculate reading time
        const minutes = Math.ceil(words / wordsPerMinute);

        return { words: words, minutes: minutes };
    }

    function insertReadingTime(readingTime) {
        // Try to insert after title
        const titleSelectors = [
            '.ltx_title',
            'h1.ltx_title',
            'article h1',
            'main h1',
            'h1'
        ];

        let titleElement = null;
        for (const selector of titleSelectors) {
            titleElement = document.querySelector(selector);
            if (titleElement) break;
        }

        if (titleElement) {
            // Insert after title
            titleElement.parentNode.insertBefore(readingTime, titleElement.nextSibling);
        } else {
            // Fallback: insert at beginning of content
            const contentWrapper = document.querySelector('.tex2any-content-wrapper') ||
                                 document.querySelector('.ltx_document') ||
                                 document.body;

            if (contentWrapper.firstChild) {
                contentWrapper.insertBefore(readingTime, contentWrapper.firstChild);
            } else {
                contentWrapper.appendChild(readingTime);
            }
        }
    }

    function trackReadingProgress(readingTimeElement, progressDot, totalWords) {
        let hasStarted = false;
        let hasCompleted = false;

        function updateProgress() {
            const scrolled = window.scrollY;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;

            // Calculate progress percentage
            const progress = scrolled / (documentHeight - windowHeight);

            if (progress < 0.1 && !hasStarted) {
                progressDot.className = 'tex2any-reading-time-progress not-started';
            } else if (progress >= 0.9 && !hasCompleted) {
                progressDot.className = 'tex2any-reading-time-progress completed';
                hasCompleted = true;
            } else if (progress >= 0.1) {
                if (!hasStarted) {
                    hasStarted = true;
                }
                progressDot.className = 'tex2any-reading-time-progress in-progress';
            }

            // Update tooltip with remaining time
            if (progress < 1) {
                const wordsRemaining = Math.ceil(totalWords * (1 - progress));
                const minutesRemaining = Math.ceil(wordsRemaining / 200);
                const tooltip = minutesRemaining > 0
                    ? minutesRemaining + ' min remaining'
                    : 'Almost done!';
                readingTimeElement.setAttribute('data-tooltip', tooltip);
            } else {
                readingTimeElement.setAttribute('data-tooltip', 'Reading complete!');
            }
        }

        // Throttle scroll events
        let ticking = false;
        function onScroll() {
            if (!ticking) {
                window.requestAnimationFrame(function() {
                    updateProgress();
                    ticking = false;
                });
                ticking = true;
            }
        }

        // Initial update
        updateProgress();

        // Listen to scroll events
        window.addEventListener('scroll', onScroll, { passive: true });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initReadingTime);
    } else {
        initReadingTime();
    }
})();

/* Component JS: footer */
// Footer Component JavaScript
(function() {
    'use strict';

    function initFooter() {
        // Get config data from meta tag (injected by Python)
        const configMeta = document.querySelector('meta[name="tex2any-footer-config"]');
        let config = {};

        if (configMeta) {
            try {
                config = JSON.parse(configMeta.getAttribute('content'));
            } catch (e) {
                console.warn('Failed to parse footer config:', e);
            }
        }

        // Create footer
        const footer = document.createElement('footer');
        footer.className = 'tex2any-footer';

        const footerContent = document.createElement('div');
        footerContent.className = 'tex2any-footer-content';

        // Left section - Author info
        if (config.author_name || config.author_email) {
            const authorSection = document.createElement('div');
            authorSection.className = 'tex2any-footer-section';

            const h3 = document.createElement('h3');
            h3.textContent = 'Author';
            authorSection.appendChild(h3);

            if (config.author_name) {
                const p = document.createElement('p');
                p.textContent = config.author_name;
                authorSection.appendChild(p);
            }

            if (config.author_email) {
                const p = document.createElement('p');
                const a = document.createElement('a');
                a.href = 'mailto:' + config.author_email;
                a.textContent = config.author_email;
                p.appendChild(a);
                authorSection.appendChild(p);
            }

            footerContent.appendChild(authorSection);
        }

        // Middle section - Document info
        const docSection = document.createElement('div');
        docSection.className = 'tex2any-footer-section';

        const docTitle = document.querySelector('.ltx_title_document, title');
        if (docTitle) {
            const h3 = document.createElement('h3');
            h3.textContent = 'Document';
            docSection.appendChild(h3);

            const p = document.createElement('p');
            p.textContent = docTitle.textContent || document.title;
            docSection.appendChild(p);

            // Add date if available
            const date = document.querySelector('.ltx_date');
            if (date) {
                const dateP = document.createElement('p');
                dateP.textContent = date.textContent;
                docSection.appendChild(dateP);
            }
        }

        footerContent.appendChild(docSection);

        // Right section - Links
        const linksSection = document.createElement('div');
        linksSection.className = 'tex2any-footer-section';

        const h3 = document.createElement('h3');
        h3.textContent = 'Quick Links';
        linksSection.appendChild(h3);

        const ul = document.createElement('ul');

        // Add link to top
        const topLi = document.createElement('li');
        const topA = document.createElement('a');
        topA.href = '#';
        topA.textContent = 'Back to Top';
        topLi.appendChild(topA);
        ul.appendChild(topLi);

        // Add links to major sections
        const sections = document.querySelectorAll('.ltx_section');
        sections.forEach((section, i) => {
            if (i >= 3) return; // Only show first 3
            const heading = section.querySelector('.ltx_title');
            if (!heading || !section.id) return;

            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + section.id;
            a.textContent = heading.textContent.replace(/^\d+\s*/, '');
            li.appendChild(a);
            ul.appendChild(li);
        });

        linksSection.appendChild(ul);
        footerContent.appendChild(linksSection);

        footer.appendChild(footerContent);

        // Bottom bar - Copyright
        const bottom = document.createElement('div');
        bottom.className = 'tex2any-footer-bottom';

        const copyright = document.createElement('div');
        copyright.className = 'tex2any-footer-copyright';

        let copyrightText = '';
        if (config.copyright_year && config.author_name) {
            copyrightText = `© ${config.copyright_year} ${config.author_name}`;
        } else if (config.copyright_year) {
            copyrightText = `© ${config.copyright_year}`;
        } else if (config.author_name) {
            copyrightText = `© ${config.author_name}`;
        }

        if (config.license) {
            copyrightText += copyrightText ? ` • ${config.license}` : config.license;
        }

        if (config.custom_text) {
            copyrightText += copyrightText ? ` • ${config.custom_text}` : config.custom_text;
        }

        if (!copyrightText) {
            copyrightText = 'Generated by tex2any';
        }

        copyright.textContent = copyrightText;
        bottom.appendChild(copyright);

        // Generated by
        const links = document.createElement('div');
        links.className = 'tex2any-footer-links';

        const genLink = document.createElement('a');
        genLink.href = 'https://github.com/yourusername/tex2any';
        genLink.textContent = 'Generated by tex2any';
        links.appendChild(genLink);

        bottom.appendChild(links);
        footer.appendChild(bottom);

        // Append to body
        document.body.appendChild(footer);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFooter);
    } else {
        initFooter();
    }
})();

/* Component JS: floating-toc */
// Floating TOC Component JavaScript
(function() {
    'use strict';

    function initFloatingTOC() {
        // Build TOC from document structure
        const sections = document.querySelectorAll('.ltx_section, .ltx_subsection, .ltx_subsubsection');
        if (sections.length === 0) return;

        // Create wrapper
        const wrapper = document.createElement('nav');
        wrapper.className = 'tex2any-floating-toc';
        wrapper.setAttribute('aria-label', 'Table of Contents');

        // Create title
        const title = document.createElement('div');
        title.className = 'tex2any-toc-title';
        title.textContent = 'Contents';
        wrapper.appendChild(title);

        // Build TOC list
        const tocList = document.createElement('ul');
        sections.forEach(section => {
            const heading = section.querySelector('.ltx_title');
            if (!heading || !section.id) return;

            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + section.id;

            // Get section text (remove numbering)
            const textNode = Array.from(heading.childNodes)
                .filter(node => node.nodeType === Node.TEXT_NODE || !node.classList.contains('ltx_tag'))
                .map(node => node.textContent)
                .join('');

            a.textContent = textNode.trim();
            li.appendChild(a);

            // Add appropriate class for nesting
            if (section.classList.contains('ltx_subsection')) {
                li.style.paddingLeft = '1rem';
            } else if (section.classList.contains('ltx_subsubsection')) {
                li.style.paddingLeft = '2rem';
            }

            tocList.appendChild(li);
        });

        wrapper.appendChild(tocList);
        document.body.insertBefore(wrapper, document.body.firstChild);

        // Create toggle button
        const toggle = document.createElement('button');
        toggle.className = 'tex2any-floating-toc-toggle';
        toggle.setAttribute('aria-label', 'Toggle Table of Contents');
        toggle.innerHTML = '☰';
        document.body.appendChild(toggle);

        // Add body class
        document.body.classList.add('has-floating-toc');

        // Start with TOC hidden
        let collapsed = true;
        wrapper.classList.add('collapsed');

        // Toggle functionality
        toggle.addEventListener('click', function() {
            collapsed = !collapsed;
            wrapper.classList.toggle('collapsed', collapsed);
            toggle.innerHTML = collapsed ? '☰' : '✕';
        });

        // Highlight current section
        const headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
        const tocLinks = wrapper.querySelectorAll('a[href^="#"]');

        function updateActiveTOC() {
            let currentSection = null;
            const scrollPos = window.scrollY + 100;

            headings.forEach(heading => {
                if (heading.offsetTop <= scrollPos) {
                    currentSection = heading;
                }
            });

            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (currentSection && link.getAttribute('href') === '#' + currentSection.id) {
                    link.classList.add('active');
                }
            });
        }

        // Update on scroll
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateActiveTOC, 50);
        });

        // Initial update
        updateActiveTOC();
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFloatingTOC);
    } else {
        initFloatingTOC();
    }
})();
</script>
</body>
</html>
